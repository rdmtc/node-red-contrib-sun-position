<script type="text/x-red" data-template-name="time-calc"> <div class="form-row">
    <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-calc.label.position"></span></label>
    <input type="text" id="node-input-positionConfig">
    <input type="hidden" id="node-input-outputs"/>
  </div>
  <hr>
  <div class="form-row time-operand1">
      <label for="node-input-operand1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-calc.label.operand1"></span></label>
      <input type="text" id="node-input-operand1" style="width:70%">
      <input type="hidden" id="node-input-operand1Type">
  </div>
  <div class="form-row time-calc-row-operand1Format hidden">
      <label for="node-input-operand1Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.operand1Format"></span></label>
      <select style="width:70%" id="node-input-operand1Formatsel">
      <input type="text" id="node-input-operand1Format" style="width:50%; margin-left: 5px;">
  </div>
  <div class="form-row time-calc-row-operand1Offset hidden">
      <label for="node-input-operand1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.operand1Offset"></span></label>
      <input id="node-input-operand1Offset" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.offset">
      <select style="width:100px" id="node-input-operand1OffsetMultiplier">
      </select>
  </div>
  <hr>
  <div>
    <label for="node-input-rule-container-row"><i class="fa fa-calculator"></i> <span data-i18n="time-calc.label.operatorContainer"></span></label>
    <div class="form-row node-input-rule-container-row">
      <ol id="node-input-rule-container"></ol>
    </div>
  </div>
  <div class="form-row">
      <select id="node-input-checkall" style="width:100%; margin-right:5px;">
          <option value="false" data-i18n="time-calc.label.stopfirst"></option>
          <option value="true" data-i18n="time-calc.label.checkall"></option>
      </select>
  </div>
  <hr class="time-calc-result">
  <div class="form-row time-result1">
      <label for="node-input-result1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-calc.label.result1"></span></label>
      <input type="text" id="node-input-result1" style="width:70%">
      <input type="hidden" id="node-input-result1Type">
  </div>
  <div class="form-row time-result1Value hidden">
      <label for="node-input-result1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-calc.label.result1Value"></span></label>
      <input type="text" id="node-input-result1Value" style="width:70%">
      <input type="hidden" id="node-input-result1ValueType">
  </div>
  <div class="form-row time-calc-row-result1Format hidden">
      <label for="node-input-result1FormatSel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.result1Format"></span></label>
      <select style="width:70%" id="node-input-result1FormatSel">
      </select>
      <input type="text" id="node-input-result1Format" style="width:50%; margin-left: 5px;">
  </div>
  <div class="form-row time-calc-row-result1Offset hidden">
      <label for="node-input-result1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.result1Offset"></span></label>
      <input id="node-input-result1Offset" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.offset">
      <select style="width:100px" id="node-input-result1OffsetMultiplier">
      </select>
  </div>
  <hr>
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-calc.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]time-calc.placeholder.name">
  </div>
</script>
<style>
    .time-calc-times {
        width: 90px;
    }
    #time-calc-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .time-calc-count {
        width: 40px !important;
    }
    /*
    .select-multi-dropdown {
        position: absolute;
        top:50%;
        transform: translateY(-50%);
    }
    .select-multi-dropdown dd,
    .select-multi-dropdown dt {
        margin: 0px;
        padding: 0px;
    }

    .select-multi-dropdown ul {
        margin: -1px 0 0 0;
    }

    .select-multi-dropdown dd {
        position: relative;
    }

    .select-multi-dropdown a,
    .select-multi-dropdown a:visited {
        color: #fff;
        text-decoration: none;
        outline: none;
        font-size: 12px;
    }

    .select-multi-dropdown dt a {
        background-color: #4F6877;
        display: block;
        padding: 8px 20px 5px 10px;
        min-height: 25px;
        line-height: 24px;
        overflow: hidden;
        border: 0;
        width: 272px;
    }

    .select-multi-dropdown dt a span,
    .multiSel span {
        cursor: pointer;
        display: inline-block;
        padding: 0 3px 2px 0;
    }

    .select-multi-dropdown dd ul {
        background-color: #4F6877;
        border: 0;
        color: #fff;
        display: none;
        left: 0px;
        padding: 2px 15px 2px 5px;
        position: absolute;
        top: 2px;
        width: 280px;
        list-style: none;
        height: 100px;
        overflow: auto;
    }

    .select-multi-dropdown span.value {
        display: none;
    }

    .select-multi-dropdown dd ul li a {
        padding: 5px;
        display: block;
    }

    .select-multi-dropdown dd ul li a:hover {
        background-color: #fff;
    }/* */

</style>
<script type="text/x-red" data-help-name="time-calc"> <p>Injects a message into a flow either manually or at timestamps which can also depending on the sunset, sunrise, or moon set and rise. The message
  payload can be a variety of types, including strings, JavaScript objects, the current time or the cuttent sun or moon position.</p>
  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>payload<span class="property-type">various</span></dt>
      <dd>The configured payload of the message.</dd>
      <dt class="optional">topic <span class="property-type">string</span></dt>
      <dd>An optional property that can be configured in the node.</dd>
      <dt class="optional">time <span class="property-type">time</span></dt>
      <dd>An optional property that can be configured when the inject node should emit a message on that timestamp.</dd>
      <dt class="optional">offset <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. The offset can be a positive or negative and defines a time offset to the choosen time.</dd>
      <dt class="optional">day select <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. There can be defined on which days a msg should be emited.</dd>
  </dl>
  <h3>Details</h3>
  <p>The time-calc node can initiate a flow with a specific payload value.
  The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
  <p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
  <p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
  inject at specified time stamp in a daily interval which can be set directly or by using the suncalc module to generate an output at various sunrise, sunset, moonrise or moonset times based on a specified location.</p>
  <p><b>Note</b>: The next timestamp will be calculated if a timestamp is reached, settings are changed or the inject node is manual triggered. For a given timestamp (or an alternate timestamp) through a flow or global context a recalculation time could be defined. Then planned emit time then is recalculated every end of this interval. Changes to the contexts then only lead to a change of the planned emit time if a recalculation is done!</p>
  <p><b>Note</b>: To include a newline in a string you must use a Function node to create the payload.</p>

  <h3>Sun times:</h3>
  <p>
    <table>
        <thead>
        <tr>
        <th>Time</th>
        <th>Description</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>astronomicalDawn</code></td>
        <td>night ends (morning astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDawn</code></td>
        <td>amateur astronomical dawn (sun at 12° before sunrise)</td>
        </tr>
        <tr>
        <td><code>nauticalDawn</code></td>
        <td>nautical dawn (morning nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDawn</code></td>
        <td>dawn (morning nautical twilight ends, morning civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>sunrise</code></td>
        <td>sunrise (top edge of the sun appears on the horizon)</td>
        </tr>
        <tr>
        <td><code>sunriseEnd</code></td>
        <td>sunrise ends (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>goldenHourEnd</code></td>
        <td>morning golden hour (soft light, best time for photography) ends</td>
        </tr>
        <tr>
        <td><code>solarNoon</code></td>
        <td>solar noon (sun is in the highest position)</td>
        </tr>
        <tr>
        <td><code>goldenHourStart</code></td>
        <td>evening golden hour starts</td>
        </tr>
        <tr>
        <td><code>sunsetStart</code></td>
        <td>sunset starts (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>sunset</code></td>
        <td>sunset (sun disappears below the horizon, evening civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDusk</code></td>
        <td>dusk (evening nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>nauticalDusk</code></td>
        <td>nautical dusk end (evening astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDusk</code></td>
        <td>amateur astronomical dusk (sun at 12° after sunrise)</td>
        </tr>
        <tr>
        <td><code>astronomicalDusk</code></td>
        <td>night starts (dark enough for astronomical observations)</td>
        </tr>
        <tr>
        <td><code>nadir</code></td>
        <td>nadir (darkest moment of the night, sun is in the lowest position)</td>
        </tr>
        </tbody>
        </table>
  </p>
  <p>It can also be configured to inject once each time the flows are started.</p>
  <h3>References</h3>
  <ul>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">Node-Red</a> - the Node-Red Node overview</li>
      <li><a href="https://github.com/HM-RedMatic/node-red-contrib-sun-position">GitHub</a> - the nodes github repository</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">NPM</a> - the nodes npm node description</li>
  </ul>
  With friendly support by <b>agag</b>.
</script>
<script type="text/javascript">
    function clipValueLength(v, l) {
        if (v.length > l) {
            return v.substring(0, l - 3) + "...";
        }
        return v;
    }

    function getValueLabel(t, v, l) {
        l = l || 15;
        if (t === "string" || t === "str") {
            if (v == "") { return v; }
            return '"' + clipValueLength(v, l) + '"';
        } else if (t === "num" || t === "bool") {
            if (v == "") { return v; }
            return "" + v;
        } else if (t === "msg") {
            return t + "." + clipValueLength(v, l);
        } else if (t === "flow" || t === "global") {
            var result = RED.utils.parseContextKey(v);
            return t + "." + clipValueLength(result.key, l);
        } else if (t == "operand1") {
            return "input data";
        } else if (t == "pdsCalcData") {
            return "{sun position}";
        } else if (t == "pdmCalcData") {
            return "{moon position}";
        } else if (t == "pdsTime") {
            let res = v.replace("astronomical", "astro-").replace("nautical", "naut-").replace("civil", "").replace("amateur", "amat-").replace("blueHour", "blHr-").replace("goldenHour", "goHr-");
            return clipValueLength(res, l);
        } else if (t == "pdmTime") {
            return "moon" + v;
        }
        return clipValueLength(v, l);
    }
    RED.nodes.registerType("time-calc", {
        category: "time and astro",
        color: "#FDF0C2",
        icon: "time-calc-black.png",
        inputs: 1,
        outputs: 1,
        defaults: {
            outputs: {
                value: 1
            },
            name: {
                value: "",
                required: false
            },
            positionConfig: {
                value: "",
                type: "position-config",
                required: true
            },
            //#region operand1
            operand1: {
                value: "payload",
                validate: RED.validators.typedInput("operand1Type")
            },
            operand1Type: {
                value: "msg"
            },
            operand1Format: {
                value: 0,
                required: true,
                validate: function (v) {
                    return RED.validators.number()(v) || typeof v === "undefined";
                }
            },
            operand1Offset: {
                value: 0,
                required: true,
                validate: RED.validators.number()
            },
            operand1OffsetMultiplier: {
                value: 60,
                required: true,
                validate: RED.validators.number()
            },
            //#endregion operand1
            //#region rules
            rules: {
                value: {}
            },
            checkall: {
                value: "true",
                required: true
            },
            //#endregion rules
            //#region result1
            result1: {
                value: "payload",
                validate: RED.validators.typedInput("result1Type")
            },
            result1Type: {
                value: "msg"
            },
            result1Value: {
                value: "",
                validate: function (v) {
                    return (RED.validators.typedInput("result1ValueType")(v) || $("#node-input-result1").typedInput("type") === "none" || this.result1Type === undefined);
                }
            },
            result1ValueType: {
                value: "operand1"
            },
            result1Format: {
                value: 0,
                required: false,
                validate: function (v) {
                    return (RED.validators.number()(v) || $("#node-input-result1").typedInput("type") === "none" || this.result1Type === undefined);
                }
            },
            result1Offset: {
                value: 0,
                required: false,
                validate: function (v) {
                    return (RED.validators.number()(v) || $("#node-input-result1").typedInput("type") === "none" || this.result1Type === undefined);
                }
            },
            result1OffsetMultiplier: {
                value: 60,
                required: false,
                validate: RED.validators.number()
            }
            //#endregion result1
        },
        outputLabels: function () {
            var label = "";
            if (this.rules.length) {
                var rule = this.rules[index];
                if (rule) {
                    label = rule.operatorText + getValueLabel(rule.operandType, rule.operandValue);
                    if (data.propertyType != "none") {
                        label += ' only if ' + getValueLabel(rule.propertyType, rule.propertyValue) + ' is true';
                    }
                    return label;
                }
                if (checkall) {
                    return "always";
                }
                return "otherwise";
                //return ["msg if comparision is true", "msg if comparision is false"];
            } else {
                return "input msg after evaluation";
            }
        },
        label: function () {
            if (this.name) {
                return this.name;
            }
            let label = '';
            if (!this.rules || this.rules.length <= 1) {
                let op1 = getValueLabel(this.operand1Type, this.operand1);
                return op1;
            } else if (this.rules && this.rules.length == 1) {
                let op1 = getValueLabel(this.operand1Type, this.operand1);
                let op2 = getValueLabel(this.rules[0].operandType, this.rules[0].operandValue);
                return op1 + this.rules[0].operatorText + op2;
            } else if (this.rules && this.rules.length == 1) {
                let op1 = getValueLabel(this.operand1Type, this.operand1);
                let op2 = getValueLabel(this.rules[0].operandType, this.rules[0].operandValue);
                return op1 + this.rules[0].operatorText + op2;
            }
            return this._("time-calc.label.time-calc");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: "time calc",
        align: "left",
        oneditprepare: function () {
            node = this;
            //#region Multiselect
            /*
 Multi Select jQuery Plugin - v1.0.0-beta1
 Copyright 2017 Ganpat S Rajpurohit, Jaipur.
 Licensed MIT
*/
            "function" !== typeof Object.create && (Object.create = function (a) { function k() { } k.prototype = a; return new k });
            (function (a, k, l, n) {
                a.strip_tags = function (a) { return (a || "").replace(/(<([^>]+)>)/ig, "") }; var m = {
                    _init: function (b, d) {
                        var c = this; this.settings = a.extend({}, a.fn.multi_select.defaults, d); this.$el = a(b); this.selectedValues = []; this.basicClass = "multi-button"; this.selectColors = "green blue aqua red yellow maroon purple".split(" "); var e = this.settings; a(b).each(function () {
                            a(this).css({ position: "relative", width: e.buttonWidth }); $wrapper = c._styleElement(a(this)); $list = c._createList(a(this)); a(this).append($list);
                            a(this).data("list", $list); c._addEvents(this); c._setSelected()
                        })
                    }, init: function () { this._init.call(this, this.$el, this.settings) }, _createList: function (b) {
                        var d = this, c = d.settings, e = this.getData(), g = c.selectedIndexes; c = c.listMaxHeight; var h = {}; c && (h = { "overflow-x": "hidden", "overflow-y": "auto", display: "none", "max-height": c }); var f = a("<ul />", { "class": "multi-menu" }).css(h).data("trigger", b); b = a("<li />", { "class": "control" }); $selAllNone = a("<a />", { "class": "select-all-none", text: this.settings.selectAllText }).on("click",
                            function (a) { a.preventDefault(); d._selectToggle(this) }); b.append($selAllNone); f.append(b); 0 < e.length && a.each(e, function (b, c) {
                                var e = ""; -1 !== a.inArray(c.index, g) && (e = "selected"); e = a("<li />", { "class": "list-items " + e, data: { id: c.index, text: a.strip_tags(c.text) } }); var h = a("<a />", {}), k = a("<span />", { "class": "text", html: a.strip_tags(c.text) }), l = a("<span />", { "class": "check-mark", html: "&#10004;" }); h.append(k).append(l); e.append(h).on("click", function () { a(this).toggleClass("selected"); d._setSelected(a(this)) });
                                f.append(e)
                            }); return this.$list = f
                    }, _addEvents: function (b) {
                        var d = this; a(b); var c = d.settings, e = c.duration, g = c.easing; a(b).on("click", function (c) { c.preventDefault(); a(this); var f = a(b).find("ul"); a(b).hasClass("open") ? a(c.target).is(f) || a(c.target).is(a("*", f)) || ("slide" == g ? f.slideUp(e, function () { a(b).removeClass("open") }) : "fade" == g && f.fadeOut(e, function () { a(b).removeClass("open") })) : "slide" == g ? f.slideDown(e, function () { a(b).addClass("open") }) : "fade" == g && f.fadeIn(e, function () { a(b).addClass("open") }); d._hideList() });
                        a(b).bind("gs.hidden", b, function (b, c) { a(this).hasClass("open") ? console.log("open") : console.log("not open") })
                    }, _styleElement: function (b) { var d = this.settings, c = []; c.push(this.basicClass); c.push("button-" + d.selectSize); c.push("button-" + d.selectColor); d.fillButton && c.push("fill"); c = c.join(" "); d = a("<span />", { "class": "button-text", html: d.selectText }); b.addClass(c).html(d) }, getData: function () { var a = this.settings.sortByText ? this._sortByText() : this._sortByKey(); this.settings.data = a; return this.settings.data },
                    _sortByText: function () { var b = []; a.each(this.settings.data, function (a, c) { b.push({ text: c, index: a }) }); b.sort(function (a, b) { return a.text > b.text ? 1 : a.text < b.text ? -1 : 0 }); return b }, _sortByKey: function () { var b = []; a.each(this.settings.data, function (a, c) { b.push({ text: c, index: a }) }); return b }, _checkSelected: function () { var a = this.$el, d = a.data("list"), c = d.find("li:not(.control)"); d = d.find("li.selected:not(.control)"); c.length == d.length ? a.find(".select-all-none").text(this.settings.selectNoneText) : a.find(".select-all-none").text(this.settings.selectAllText) },
                    getSelectedValues: function () { return this.settings.selectedValues }, clearValues: function () { var a = this.$el; a.data("list").find("li.selected").removeClass("selected"); this.settings.selectedValues = []; a.find(".button-text").text(this.settings.selectText) }, _selectToggle: function (b) {
                        var d = this.$el, c = this.settings, e = d.find(".button-text"); d = d.data("list"); var g = d.find("li:not(.control)"); b = a(b); if (this.settings.selectAllText == b.text()) {
                            d.find("li:not(.control)").addClass("selected"); b.text(this.settings.selectNoneText); var h = [], f = []; 0 <
                                g.length ? (g.each(function (c, b) { h[c] = a(this).data("id"); f.push(a(this).data("text")) }), g.length <= c.selectedCount ? e.text(f.join(", ")) : e.text(this.settings.selectedText + " (" + g.length + ")")) : e.text(this.settings.selectText); this.settings.selectedValues = h; this.settings.onSelect.call(this, this.settings.selectedValues); this._checkSelected()
                        } else this.clearValues(), b.text(this.settings.selectAllText), this.settings.onSelect.call(this, this.settings.selectedValues)
                    }, _setSelected: function (b) {
                        var d = this.$el; b = this.settings; var c = d.data("list").find("li.selected");
                        d = d.find(".button-text"); var e = [], g = []; 0 < c.length ? (c.each(function (c, b) { g[c] = a(this).data("id"); e.push(a(this).data("text")) }), c.length <= b.selectedCount ? d.text(e.join(", ")) : d.text(this.settings.selectedText + " (" + c.length + ")")) : d.text(this.settings.selectText); this.settings.selectedValues = g; this.settings.onSelect.call(this, this.settings.selectedValues); this._checkSelected()
                    }, _hideList: function () {
                        var b = this.$el, d = this.settings, c = d.duration, e = d.easing; a(l).on("click", function (d) {
                            b.each(function () {
                                var b = a(this).find(".multi-menu");
                                if (!a(this).is(d.target) && 0 === a(this).has(d.target).length && 0 === b.has(d.target).length) { var f = a(this); "slide" == e ? b.slideUp(c, function () { f.removeClass("open") }) : "fade" == e && b.fadeOut(c, function () { f.removeClass("open") }) }
                            })
                        })
                    }
                }; a.fn.multi_select = function (b) { if (a.isPlainObject(b)) return this.each(function () { var c = Object.create(m); c._init(this, b); a(this).data("multi_select", c) }); if ("string" === typeof b && 0 !== b.indexOf("_")) { var d = a(this).data("multi_select"); return d[b].apply(d, a.makeArray(arguments).slice(1)) } };
                a.fn.multi_select.defaults = { selectColor: "red", selectSize: "small", selectText: "Select", selectAllText: "Select all", selectNoneText: "Select none", selectedText: "Selected", selectedCount: 3, duration: 300, easing: "slide", listMaxHeight: 200, selectedIndexes: null, sortByText: !1, fillButton: !1, data: {}, buttonWidth: "100%", onSelect: function () { return !0 } }
            })(jQuery, window, document);
            //#endregion Multiselect
            //#region definition
            const SelectFields = {
                operatorsGroups: [
                    { id: "ms", label: "complete Timestamp" },
                    { id: "sec", label: "Timestamp, ignore Milliseconds" },
                    { id: "min", label: "Timestamp, ignore Seconds" },
                    { id: "hour", label: "Timestamp, ignore Minutes" },
                    { id: "date", label: "complete Date" },
                    { id: "month", label: "Year and Month" }
                ],
                operators: [
                    { id: 1, group: "ms", label: "==", "text": "equal" },
                    { id: 2, group: "ms", label: "!=", "text": "unequal" },
                    { id: 3, group: "ms", label: ">", "text": "greater" },
                    { id: 4, group: "ms", label: ">=", "text": "greater or equal" },
                    { id: 5, group: "ms", label: "<", "text": "lesser" },
                    { id: 6, group: "ms", label: "<=", "text": "lesser or equal" },
                    { id: 11, group: "sec", label: "== (sec)", "text": "equal (ignore milliseconds)" },
                    { id: 12, group: "sec", label: "!= (sec)", "text": "unequal (ignore milliseconds)" },
                    { id: 13, group: "sec", label: "> (sec)", "text": "greater (ignore milliseconds)" },
                    { id: 14, group: "sec", label: ">= (sec)", "text": "greater or equal (ignore milliseconds)" },
                    { id: 15, group: "sec", label: "< (sec)", "text": "lesser (ignore milliseconds)" },
                    { id: 16, group: "sec", label: "<= (sec)", "text": "lesser or equal (ignore milliseconds)" },
                    { id: 21, group: "min", label: "== (min)", "text": "equal (ignore seconds)" },
                    { id: 22, group: "min", label: "!= (min)", "text": "unequal (ignore seconds)" },
                    { id: 23, group: "min", label: "> (min)", "text": "greater (ignore seconds)" },
                    { id: 24, group: "min", label: ">= (min)", "text": "greater or equal (ignore seconds)" },
                    { id: 25, group: "min", label: "< (min)", "text": "lesser (ignore seconds)" },
                    { id: 26, group: "min", label: "<= (min)", "text": "lesser or equal (ignore seconds)" },
                    { id: 31, group: "hour", label: "== (h)", "text": "equal (ignore minutes)" },
                    { id: 32, group: "hour", label: "!= (h)", "text": "unequal (ignore minutes)" },
                    { id: 33, group: "hour", label: "> (h)", "text": "greater (ignore minutes)" },
                    { id: 34, group: "hour", label: ">= (h)", "text": "greater or equal (ignore minutes)" },
                    { id: 35, group: "hour", label: "< (h)", "text": "lesser (ignore minutes)" },
                    { id: 36, group: "hour", label: "<= (h)", "text": "lesser or equal (ignore minutes)" },
                    { id: 41, group: "date", label: "== (date)", "text": "equal (ignore timestamp)" },
                    { id: 42, group: "date", label: "!= (date)", "text": "unequal (ignore timestamp)" },
                    { id: 43, group: "date", label: "> (date)", "text": "greater (ignore timestamp)" },
                    { id: 44, group: "date", label: ">= (date)", "text": "greater or equal (ignore timestamp)" },
                    { id: 45, group: "date", label: "< (date)", "text": "lesser (ignore timestamp)" },
                    { id: 46, group: "date", label: "<= (date)", "text": "lesser or equal (ignore timestamp)" },
                    { id: 51, group: "month", label: "== (month)", "text": "equal (year and month)" },
                    { id: 52, group: "month", label: "!= (month)", "text": "unequal (year and month)" },
                    { id: 53, group: "month", label: "> (month)", "text": "greater (year and month)" },
                    { id: 54, group: "month", label: ">= (month)", "text": "greater or equal (year and month)" },
                    { id: 55, group: "month", label: "< (month)", "text": "lesser (year and month)" },
                    { id: 56, group: "month", label: "<= (month)", "text": "lesser or equal (year and month)" }
                ], outputFormatsGroups: [
                    { id: "number", label: "Number" },
                    { id: "string", label: "Text (string)" },
                    { id: "time", label: "time (number) since emit" },
                    { id: "dayofweek", label: "day of week" },
                    { id: "other", label: "Other" }
                ], outputFormats: [
                    { id: 0, group: "number", name: "UNIX", label: "milliseconds UNIX timestamp" },
                    { id: 10, group: "number", name: "YYYYMMDDHHMMSS", label: "YYYYMMDDHHMMSS" },
                    { id: 11, group: "number", name: "YYYYMMDD_HHMMSS", label: "YYYYMMDD.HHMMSS" },
                    { id: 1, group: "string", "name": "ECMA262", label: "ECMA-262", add: "standard JSON Date representation" },
                    { id: 2, group: "string", name: "local", label: "local date and time" },
                    { id: 14, group: "string", name: "localLong", label: "local date and time enh." },
                    { id: 3, group: "string", name: "localTime", label: "local time" },
                    { id: 13, group: "string", name: "localTimeLong", label: "ocal time enh." },
                    { id: 12, group: "string", name: "localDate", label: "local date" },
                    { id: 15, group: "string", name: "localDateLong", label: "local date long" },
                    { id: 4, group: "string", name: "UTC", label: "UTC date and time" },
                    { id: 5, group: "string", name: "ISO", label: "ISO date and time" },
                    { id: 6, group: "time", name: "ms", label: "milliseconds" },
                    { id: 7, group: "time", name: "sec", label: "seconds" },
                    { id: 8, group: "time", name: "min", label: "minutes" },
                    { id: 9, group: "time", name: "hour", label: "hours" },
                    { id: 16, group: "dayofweek", name: "ISO", label: "Day Name, e.g. Monday, 22.12." },
                    { id: 17, group: "dayofweek", name: "ISO", label: "Day in relative, e.g. Today, 22.12." },
                    { id: -1, group: "other", name: "object", label: "as object" },
                    { id: 99, group: "other", name: "free definition", label: "Other" }
                ], parseFormatsGroups: [
                    { id: "number", label: "Number" },
                    { id: "string", label: "Text (string)" },
                    { id: "other", label: "Other" }
                ], parseFormats: [
                    { id: 0, group: "number", label: "milliseconds UNIX timestamp", add: "xxx" },
                    { id: 1, group: "string", label: "ECMA-262", add: "standard JSON Date representation" },
                    { id: 2, group: "string", label: "various - try different Formats", add: "will try different formats" },
                    { id: 3, group: "number", label: "YYYYMMDDHHMMSS", add: "xxx" },
                    { id: 4, group: "number", label: "YYYYMMDD.HHMMSS", add: "xxx" },
                    { id: 99, group: "other", label: "free definition", add: "xxx" }
                ], multiplierGroups: [
                    { id: "std", label: "Standard" },
                    { id: "other", label: "Special" },
                ], multiplier: [
                    { id: 1, group: "std", label: "seconds" },
                    { id: 60, group: "std", label: "minutes" },
                    { id: 3600, group: "std", label: "hours" },
                    { id: 86400, group: "std", label: "days" },
                    { id: 604800, group: "other", label: "weeks" },
                    { id: -1, group: "other", label: "month" },
                    { id: -2, group: "other", label: "year" }
                ]
            }
            const typeUnlimited = {
                value: "none",
                label: "no limitation",
                //icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
                hasValue: false
            };
            const typeUndefined = {
                value: "none",
                label: "not used",
                //icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
                hasValue: false
            };
            const typeTimeEntered = {
                value: "entered",
                label: "time (current day)",
                icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
                hasValue: true,
                validate: /^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]|[0-9]))?(?::([0-5][0-9]|[0-9]))?\s*(pm?)?$/
            };
            const typeDateEntered = {
                value: "dateEntered",
                label: "date",
                icon: "icons/node-red-contrib-sun-position/inputTypeDate.png",
                hasValue: true
            };
            const typeTimePedefined = {
                value: "predefined",
                label: "time (current day)",
                options: ["midnight (current day)", "noon (current day)", "last this month (0:00)"]
            };
            const typeTimeSun = {
                value: "pdsTime",
                label: "sun time ",
                icon: "icons/node-red-contrib-sun-position/inputTypeSunClock.png",
                options: ["astronomicalDawn", "amateurDawn", "nauticalDawn", "blueHourDawnStart", "civilDawn", "blueHourDawnEnd", "sunrise", "sunriseEnd", "goldenHourEnd", "solarNoon", "goldenHourStart", "sunsetStart", "sunset", "blueHourDuskStart", "civilDusk", "blueHourDuskEnd", "amateurDusk", "astronomicalDusk", "nadir"]
            };
            const typeTimeMoon = {
                value: "pdmTime",
                label: "moon time ",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoonClock.png",
                options: ["rise", "set"]
            };
            const typeSunCalc = {
                value: "pdsCalcData",
                label: "sun caclucaltion",
                icon: "icons/node-red-contrib-sun-position/inputTypeSun.png",
                hasValue: false
            };
            const typeMoonCalc = {
                value: "pdmCalcData",
                label: "moon caclucaltion",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoon.png",
                hasValue: false
            };
            var dateParseFormat = [{ label: 'yy   Year (2 digits)', value: 'yy' }, { label: 'yyyy Year (4 digits)', value: 'yyyy' }, { label: 'M    Month (1 digit)', value: 'M' }, { label: 'MM   Month (2 digits)', value: 'MM' }, { label: 'MMM  Month (name or abbr.)', value: 'MMM' }, { label: 'NNN  Month (abbr.)', value: 'NNN' }, { label: 'd    Day of Month (1 digit)', value: 'd' }, { label: 'dd   Day of Month (2 digits)', value: 'dd' }, { label: 'E    Day of Week (abbr)', value: 'E' }, { label: 'EE   Day of Week (name)', value: 'EE' }, { label: 'h    Hour (1 digit 1-12)', value: 'h' }, { label: 'hh   Hour (2 digits 1-12)', value: 'hh' }, { label: 'H    Hour (1 digit 0-23)', value: 'H' }, { label: 'HH   Hour (2 digits 0-23)', value: 'HH' }, { label: 'K    Hour (1 digit 0-11)', value: 'K' }, { label: 'KK   Hour (2 digits 0-11)', value: 'KK' }, { label: 'k    Hour (1 digit 1-24)', value: 'k' }, { label: 'kk   Hour (2 digits 1-24)', value: 'kk' }, { label: 'm    Minute (1 digit)', value: 'm' }, { label: 'mm   Minute (2 digits)', value: 'mm' }, { label: 's    Second (1 digit)', value: 's' }, { label: 'ss   Second (2 digits)', value: 'ss' }, { label: 'll   Milliseconds (2 digits)', value: 'll' }, { label: 'lll  Milliseconds (3 digits)', value: 'lll' }, { label: 't    AM/PM (1 digit)', value: 't' }, { label: 'tt   AM/PM (2 digits)', value: 'tt' }];
            var dateOutFormat = [{ label: 'yyyy Year (4 digits)', value: 'yyyy' }, { label: 'yy   Year (2 digits)', value: 'yy' }, { label: 'M    Month (1 digit)', value: 'M' }, { label: 'MM   Month (2 digits)', value: 'MM' }, { label: 'MMM  Month (abbr.)', value: 'MMM' }, { label: 'NNN  Month (name)', value: 'NNN' }, { label: 'd    Day of Month (1 digit)', value: 'd' }, { label: 'dd   Day of Month (2 digits)', value: 'dd' }, { label: 'E    Day of Week (abbr)', value: 'E' }, { label: 'EE   Day of Week (name)', value: 'EE' }, { label: 'h    Hour (1-12)', value: 'h' }, { label: 'hh   Hour (2 digits 01-12)', value: 'hh' }, { label: 'H    Hour (0-23)', value: 'H' }, { label: 'HH   Hour (2 digits 00-23)', value: 'HH' }, { label: 'K    Hour (0-11)', value: 'K' }, { label: 'KK   Hour (2 digits 00-11)', value: 'KK' }, { label: 'k    Hour (1-24)', value: 'k' }, { label: 'kk   Hour (2 digits 01-24)', value: 'kk' }, { label: 'm    Minute (0-59)', value: 'm' }, { label: 'mm   Minute (2 digits 00-59)', value: 'mm' }, { label: 's    Second (0-59)', value: 's' }, { label: 'ss   Second (2 digits 00-59)', value: 'ss' }, { label: 'l    Milliseconds (0-999)', value: 'l' }, { label: 'll   Milliseconds (2 digits 00-99)', value: 'll' }, { label: 'lll  Milliseconds (3 digits 000-999)', value: 'lll' }, { label: 't    AM/PM (1 digit - Lowercase)', value: 't' }, { label: 'tt   AM/PM (2 digits - Lowercase)', value: 'tt' }, { label: 'T    AM/PM (1 digit - Uppercase)', value: 'T' }, { label: 'TT   AM/PM (2 digits - Uppercase)', value: 'TT' }, { label: 'Z    timezone (abbr.)', value: 'Z' }, { label: 'o    timezone offset (abbr.)', value: 'o' }, { label: "S    date's ordinal suffix (st, nd, rd, or th)", value: 'S' }, { label: 'x    Day difference', value: 'x' }, { label: 'xx   Day difference (name)', value: 'xx' }];
            $.fn.getCursorPosition = function () {
                var input = this.get(0);
                if (!input) return; // No (input) element found
                if ('selectionStart' in input) {
                    // Standard-compliant browsers
                    return input.selectionStart;
                } else if (document.selection) {
                    // IE
                    input.focus();
                    var sel = document.selection.createRange();
                    var selLen = document.selection.createRange().text.length;
                    sel.moveStart('character', -input.value.length);
                    return sel.text.length - selLen;
                }
            }

            function multiselect(row) {
                //https://codepen.io/elmahdim/pen/hlmri
                //https://stackoverflow.com/questions/17714705/how-to-use-checkbox-inside-select-option
                //https://codepen.io/arc6789/pen/xzrzja

                //https://www.jqueryscript.net/form/Dynamic-Multi-Select-Plugin-jQuery.html

                var field = $('<div/>', {
                    class: "node-input-rule-operatorType",
                    id: "node-input-rule-operatorType" + containerIndex,
                    style: "width:70px; margin-left: 5px; text-align: center;"
                }).appendTo(row);
                field.multi_select({
                    selectColor: 'lightgrey',
                    selectSize: 'small',
                    selectText: 'type',
                    duration: 300,
                    easing: 'slide',
                    listMaxHeight: 300,
                    selectedCount: 2,
                    sortByText: true,
                    fillButton: true,
                    data: {
                        "MS": "Milliseconds",
                        "SEC": "Seconds",
                        "MIN": "Minutes",
                        "H": "Hours",
                        "DW": "Day of Week",
                        "DM": "Day of Month",
                        "MON": "Month",
                        "Y": "Full Year"
                    },
                    onSelect: function (values) {
                        console.log('return values: ', values);
                    }
                });
            }
            function autocomplete(inputBox, dataList) {
                // don't navigate away from the field on tab when selecting an item
                inputBox.on("keydown", function (event) {
                    if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete("instance") && $(this).autocomplete("instance").menu.active) {
                        event.preventDefault();
                    }
                }).autocomplete({
                    minLength: 0,
                    source: function (request, response) {
                        if (inputBox.getCursorPosition() < request.term.length) {
                            return;
                        }
                        // delegate back to autocomplete, but extract the last term
                        var term = request.term.split(/\W+/).pop()
                        var result = dataList.filter(x => x.value.startsWith(term));
                        response(result);
                    },
                    focus: function () {
                        // prevent value inserted on focus
                        return false;
                    },
                    select: function (event, ui) {
                        var terms = this.value.split(/\W+/);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push("");
                        this.value = terms.join(" ");
                        return false;
                    }
                });
            }

            function appendOptions(parent, elementName) {
                let groups = SelectFields[elementName + 'Groups'];
                let elements = SelectFields[elementName];
                let groupLength = groups.length;
                let elementsLength = elements.length;
                for (let gIndex = 0; gIndex < groupLength; gIndex++) {
                    let group = $('<optgroup/>', { label: node._("time-calc." + elementName + 'Groups.' + gIndex + '.label') }).appendTo(parent);
                    for (let eIndex = 0; eIndex < elementsLength; eIndex++) {
                        if (groups[gIndex].id === elements[eIndex].group) {
                            group.append($("<option></option>").val(elements[eIndex].id).text(node._("time-calc." + elementName + '.' + eIndex + '.label')).attr("addText", elements[eIndex].add));
                        }
                    }
                }
            }
            //#endregion definition
            //#region spinner
            $(".wt-offset-time").spinner({ max: 1439, min: -1439 });
            //#endregion spinner
            //#region operand1
            $("#node-input-operand1Type").val(node.operand1Type);
            $("#node-input-operand1").typedInput({
                default: node.operand1Type || "msg",
                typeField: $("#node-input-operand1Type"),
                types: ["msg", "flow", "global", "date", "str", "num", typeTimeSun, typeTimeMoon, "env"]
            });
            $("#node-input-operand1").on("change", function (type, value) {
                let opType = $("#node-input-operand1").typedInput("type");
                if (opType === typeTimeEntered.value || opType === typeTimeSun.value || opType === typeTimeMoon.value || opType === "date") {
                    $(".time-calc-row-operand1Format").hide();
                    $(".time-calc-row-operand1Offset").show();
                } else if (opType === typeDateEntered.value || opType === "msg" || opType === "flow" || opType === "global" || opType === "str" || opType === "num" || opType === "env") {
                    $(".time-calc-row-operand1Format").show();
                    $(".time-calc-row-operand1Offset").show();
                } else {
                    $(".time-calc-row-operand1Format").hide();
                    $(".time-calc-row-operand1Offset").hide();
                }
            });
            let inputFormatSelField = $('#node-input-operand1Formatsel');
            appendOptions(inputFormatSelField, "parseFormats");
            autocomplete($("#node-input-operand1Format"), dateParseFormat);
            inputFormatSelField.on("change", function (type, value) {
                let inputFormatIpField = $("#node-input-operand1Format");
                let inputFormatSelField = $('#node-input-operand1Formatsel');
                if (Number(inputFormatSelField.val()) == 99) {
                    inputFormatIpField.show();
                    $('#node-input-operand1Format').css({ 'width': '40%' });
                    inputFormatSelField.css({ 'width': '30%' });
                    if (!isNaN(inputFormatIpField.val())) {
                        inputFormatIpField.val(node._("time-calc.timeFormat.default"));
                    }
                } else {
                    inputFormatIpField.hide();
                    inputFormatSelField.css({ 'width': '70%' });
                }
            });
            if (isNaN(node.operand1Format)) {
                inputFormatSelField.val(99);
            } else {
                inputFormatSelField.val(Number(node.operand1Format));
            }
            inputFormatSelField.change();
            var inputMultiplierField = $('#node-input-operand1OffsetMultiplier');
            appendOptions(inputMultiplierField, "multiplier");
            inputMultiplierField.val(node.operand1OffsetMultiplier);
            //#endregion operand1
            //#region rule-container
            function resizeRule(rule) {
                var newWidth = rule.width() - 10;
                var operatorField = rule.find(".node-input-rule-operator");
                var operandField = rule.find(".node-input-rule-operand");
                var formatSelField = rule.find(".node-input-rule-operandFormatSel");
                var formatIpField = rule.find(".node-input-rule-operandFormatIp");
                var offsetField = rule.find(".node-input-rule-offset");
                var multipierField = rule.find(".node-input-rule-multipier");
                var propertyField = rule.find(".node-input-rule-property");
                var propertyLblSpanField = rule.find(".node-input-rule-property-span");
                var propertyLblField = rule.find(".node-input-rule-property-lbl");
                var lblWidth = 25;
                //row1
                var operatorWidth = 90;
                operatorField.width(operatorWidth);
                operandField.typedInput("width", (newWidth - operatorWidth - lblWidth - 50));
                //row2
                var formatWidth = (newWidth - lblWidth - 18);
                if (Number(formatSelField.val()) == 99) {
                    formatIpField.show();
                    formatWidth = Math.floor(formatWidth / 3);
                    formatSelField.width(formatWidth - 5);
                    formatIpField.width((formatWidth * 2) - 10);
                } else {
                    formatIpField.hide();
                    //formatIpField.width(0);
                    formatSelField.width(formatWidth);
                }
                //row3
                let multiplierWidth = 100;
                multipierField.width(multiplierWidth);
                offsetField.typedInput("width", (newWidth - multiplierWidth - lblWidth - 10));
                //row4
                let lblwidth = propertyLblSpanField.width() + 25;
                propertyField.typedInput("width", (newWidth - lblwidth - 10));
                propertyLblField.width(lblwidth);
            }
            $("#node-input-rule-container").css('min-height', '250px').css('min-width', '300px').editableList({
                addItem: function (containerRow, containerIndex, data) {
                    function addLabel(row, forEl, symb, text) {
                        let lbl = $('<label class="' + forEl + '-lbl"/>').attr("for", forEl).appendTo(row);
                        if (symb) {
                            lbl.append('<i class= "' + symb + '" >');
                        }
                        if (text) {
                            let span = $('<span class="' + forEl + '-span" style="float: right; margin-left: 5px; */">' + text + '</span>');
                            lbl.append(span);
                            lbl.attr("style", 'margin-left: 5px; width:' + 20 + span.width() + 'px;');
                        } else {
                            lbl.attr("style", "margin-left: 5px; width:20px");
                        }
                        return lbl;
                    }
                    containerRow.css({ overflow: 'hidden', whiteSpace: 'nowrap' });
                    var row = $('<div/>').appendTo(containerRow);
                    var row2 = $('<div/>', { style: "padding-top: 5px;" }).appendTo(containerRow);
                    var row3 = $('<div/>', { style: "padding-top: 5px;" }).appendTo(containerRow);
                    var row4 = $('<div/>', { style: "padding-top: 5px;" }).appendTo(containerRow);
                    //row1
                    //operator
                    var operatorField = $('<select/>', {
                        class: "node-input-rule-operator",
                        id: "node-input-rule-operator" + containerIndex,
                        style: "width:70px; margin-left: 5px; text-align: center;"
                    }).appendTo(row);
                    appendOptions(operatorField, "operators");
                    var operatorTypeField = $('<select/>', {
                        class: "node-input-rule-operatorType",
                        id: "node-input-rule-operatorType" + containerIndex,
                        style: "width:70px; margin-left: 5px; text-align: center;"
                    }).appendTo(row);
                    appendOptions(operatorTypeField, "operators");
                    var operandLabel = addLabel(row, "node-input-rule-operand", "fa fa-clock-o");
                    var operandField = $('<input/>', {
                        class: "node-input-rule-operand",
                        id: "node-input-rule-operand" + containerIndex,
                        type: "text",
                        style: "margin-left: 5px;"
                    }).appendTo(row).typedInput({
                        default: "str",
                        types: ["msg", "flow", "global", "date", "str", "num", typeTimeSun, typeTimeMoon, "bin", "env", "jsonata"]
                    });
                    var finalspan = $('<span/>', {
                        style: "float: right;margin-top: 6px;"
                    }).appendTo(row);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">' + (containerIndex + 1) + '</span> ');
                    //row2
                    let soematSelFieldName = "node-input-rule-operandFormatSel";
                    var formatLabel = addLabel(row2, soematSelFieldName, "fa fa-file-code-o");
                    var formatSelField = $('<select/>', {
                        class: soematSelFieldName,
                        id: soematSelFieldName + containerIndex,
                        style: "width:70px; margin-left: 5px; text-align: left;"
                    }).appendTo(row2);
                    appendOptions(formatSelField, "parseFormats");
                    var formatIpField = $('<input/>', {
                        class: "node-input-rule-operandFormatIp",
                        id: "node-input-rule-operandFormatIp" + containerIndex,
                        type: "text",
                        style: "width:0px; margin-left: 5px; text-align: left;"
                    }).appendTo(row2);
                    formatSelField.change(function () {
                        resizeRule(containerRow);
                    });
                    //row3
                    var offsetLabel = addLabel(row3, "node-input-rule-offset", "fa fa-plus");
                    var offsetField = $('<input/>', {
                        class: "node-input-rule-offset",
                        id: "node-input-rule-offset" + containerIndex,
                        type: "text",
                        style: "margin-left: 5px;"
                    }).appendTo(row3).typedInput({
                        default: typeUndefined.value,
                        types: [typeUndefined, "num", "msg", "flow", "global"]
                    });
                    var multiplierField = $('<select/>', {
                        class: "node-input-rule-multiplier",
                        id: "node-input-rule-multiplier" + containerIndex,
                        style: "width:100px; margin-left: 5px;"
                    }).appendTo(row3);
                    appendOptions(multiplierField, "multiplier");
                    //row4
                    var propertyLabel = addLabel(row4, "node-input-rule-property", "fa fa-puzzle-piece", node._('time-calc.label.onlyif'));
                    var propertyField = $('<input/>', {
                        class: "node-input-rule-property",
                        id: "node-input-rule-property" + containerIndex,
                        type: "text",
                        style: "margin-left: 5px; width:70px"
                    }).appendTo(row4).typedInput({
                        default: typeUnlimited.value,
                        types: [typeUnlimited, 'msg', 'flow', 'global', 'env']
                    });
                    //changes
                    operandField.change(function () {
                        operandField.show();
                        let opType = operandField.typedInput("type");
                        if (opType === typeTimeEntered.value || opType === typeTimeSun.value || opType === typeTimeMoon.value || opType === "date") {
                            row2.hide(); //format
                            row3.show(); //offset
                            row4.show(); //limit
                        } else if (opType === typeDateEntered.value || opType === "msg" || opType === "flow" || opType === "global" || opType === "str" || opType === "num" || opType === "env") {
                            row2.show(); //format
                            row3.show(); //offset
                            row4.show(); //limit
                        } else {
                            row2.hide(); //format
                            row3.hide(); //offset
                            row4.show(); //limit
                        }
                    });
                    //defaultValues
                    console.log(data);
                    operatorField.val(data.operator || SelectFields.operators[0].id);
                    operandField.typedInput('type', data.operandType || "str");
                    operandField.typedInput('value', data.operandValue || '');
                    formatIpField.val(data.format || node._("time-calc.timeFormat.default"));
                    formatSelField.val(data.formatSelection || SelectFields.parseFormats[0].id);
                    offsetField.typedInput('type', data.offsetType || typeUndefined.value);
                    offsetField.typedInput('value', data.offsetValue || '');
                    multiplierField.val(data.multiplier || SelectFields.multiplier[0].id);
                    propertyField.typedInput('type', data.propertyType || typeUnlimited.value);
                    propertyField.typedInput('value', data.propertyValue || '');
                    resizeRule(containerRow);
                    autocomplete(formatIpField, dateParseFormat);
                },
                sortItems: function (rules) {
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function (i) {
                        $(this).find(".node-input-rule-index").html(i + 1);
                    });
                },
                resizeItem: resizeRule,
                sortable: true,
                removable: true
            });
            for (let i = 0; i < node.rules.length; i++) {
                let rule = node.rules[i];
                $("#node-input-rule-container").editableList('addItem', rule);
            }
            //#endregion rule-container
            //#region result1
            $("#node-input-result1Type").val(node.result1Type);
            $("#node-input-result1").typedInput({
                default: node.result1Type || typeUndefined.value,
                typeField: $("#node-input-result1Type"),
                types: [typeUndefined, "msg", "flow", "global"]
            });
            $("#node-input-result1ValueType").val(node.result1ValueType);
            $("#node-input-result1Value").typedInput({
                default: node.result1ValueType || "operand1",
                typeField: $("#node-input-result1ValueType"),
                types: [{ value: "operand1", label: "Input value", hasValue: false }, "date",
                    typeTimeEntered,
                    typeTimeSun,
                    typeTimeMoon, "flow", "global", "str", "num", "bool", "json", "bin", "env", "jsonata",
                    typeSunCalc,
                    typeMoonCalc
                ]
            });
            $("#node-input-result1").on("change", function (type, value) {
                if ($("#node-input-result1").typedInput("type") !== typeUndefined.value) {
                    $(".time-result1Value").show();
                    let plVType = $("#node-input-result1Value").typedInput("type");
                    if (plVType === typeTimeEntered.value || plVType === typeTimeSun.value || plVType === typeTimeMoon.value || plVType === "date") {
                        $(".time-calc-row-result1Format").show();
                        $(".time-calc-row-result1Offset").show();
                    } else if (plVType === "operand1") {
                        $(".time-calc-row-result1Format").show();
                        $(".time-calc-row-result1Offset").hide();
                    } else {
                        $(".time-calc-row-result1Format").hide();
                        $(".time-calc-row-result1Offset").hide();
                    }
                } else {
                    $(".time-result1Value").hide();
                    $(".time-calc-row-result1Format").hide();
                    $(".time-calc-row-result1Offset").hide();
                }
            });
            $("#node-input-result1Value").on("change", function (type, value) {
                $("#node-input-result1").change();
            });
            /********************************************************/
            let resultFormatSelField = $('#node-input-result1FormatSel');
            appendOptions(resultFormatSelField, "outputFormats");
            resultFormatSelField.on("change", function (type, value) {
                let resultFormatIpField = $("#node-input-result1Format");
                let resultFormatSelField = $('#node-input-result1FormatSel');
                if (Number(resultFormatSelField.val()) == 99) {
                    resultFormatIpField.show();
                    resultFormatIpField.css({ 'width': '40%' });
                    resultFormatSelField.css({ 'width': '30%' });
                    if (!isNaN(resultFormatIpField.val())) {
                        resultFormatIpField.val(node._("time-calc.timeFormat.default"));
                    }
                } else {
                    resultFormatIpField.hide();
                    resultFormatSelField.css({ 'width': '70%' });
                }
            });
            if (isNaN(node.result1Format)) {
                resultFormatSelField.val(99);
            } else {
                resultFormatSelField.val(Number(node.result1Format));
            }
            resultFormatSelField.change();
            var resultMultiplierField = $('#node-input-result1OffsetMultiplier');
            appendOptions(resultMultiplierField, "multiplier");
            resultMultiplierField.val(node.result1OffsetMultiplier);
            autocomplete($("#node-input-result1Format"), dateOutFormat);
            //#endregion result1
            $("#node-input-time").change();
            $("#node-input-property").change();
            $("#node-input-payload").change();
            $("#node-input-operand1").change();
            $("#node-input-result1").change();
        },
        oneditsave: function () {
            var node = this;
            node.rules = [];
            var rules = $("#node-input-rule-container").editableList('items');
            rules.each(function (i) {
                var rule = $(this);
                var data = {
                    operator: rule.find(".node-input-rule-operator").val(),
                    operatorText: rule.find(".node-input-rule-operator").children(':selected').text(),
                    operandType: rule.find(".node-input-rule-operand").typedInput('type'),
                    operandValue: rule.find(".node-input-rule-operand").typedInput('value'),
                    format: rule.find(".node-input-rule-operandFormatIp").val(),
                    formatSelection: rule.find(".node-input-rule-operandFormatSel").val(),
                    offsetType: rule.find(".node-input-rule-offset").typedInput('type'),
                    offsetValue: rule.find(".node-input-rule-offset").typedInput('value'),
                    multiplier: rule.find(".node-input-rule-multipier").val(),
                    propertyType: rule.find(".node-input-rule-property").typedInput('type'),
                    propertyValue: rule.find(".node-input-rule-property").typedInput('value'),
                };
                node.rules.push(data);
            });
            console.log(this.rules);
            let outputs = node.rules.length + 1;
            $("#node-input-outputs").val(outputs);
            console.log(outputs);
            if (Number($('#node-input-operand1Formatsel').val()) != 99) {
                $('#node-input-operand1Format').val($('#node-input-operand1Formatsel').val());
                node.operand1Format = $('#node-input-operand1Formatsel').val();
            }
            if (Number($('#node-input-result1FormatSel').val()) != 99) {
                $('#node-input-result1Format').val($('#node-input-result1FormatSel').val());
                node.result1Format = $('#node-input-result1FormatSel').val();
            }
            node.operand1Type = $("#node-input-operand1").typedInput("type");
            node.result1Type = $("#node-input-result1").typedInput("type");
            node.result1ValueType = $("#node-input-result1Value").typedInput("type");
            node.result2Type = $("#node-input-result2").typedInput("type");
            node.result2ValueType = $("#node-input-result2Value").typedInput("type");
            console.log($("#node-input-outputs").val());
        },
        oneditresize: function (size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $("#node-input-rule-container").editableList('height', height);
        }
    });
</script>