<!DOCTYPE HTML>
<!--
This code is licensed under the Apache License Version 2.0.

Copyright (c) 2022 Robert Gester

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

-->

<!--
This code is licensed under the Apache License Version 2.0.

Copyright (c) 2022 Robert Gester

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

-->

<script type="text/javascript">
    (function() {
        /**
         * Retrieve editableList items (refactored for re-use in the form inject button)
         */
        function getProps(el, node) {
            const result = {
                props: [],
                payloadLbl : '',
                payloadType : '',
                topicLbl : ''
            };
            const getPropTLbl = prop => {
                if (prop) {
                    if (prop.vt === 'dateSpecific') {
                        if (prop.fS === 99) {
                            return RED.nodes.getType('position-config').clipValueLength(prop.fI, 20);
                        }
                        return RED.nodes.getType('position-config').clipValueLength($.trim(prop.fT.split(',')[0]), 20);
                    }
                    return RED.nodes.getType('position-config').getRDGNodeValLbl(node, prop.vt, prop.v, prop.oT, prop.o, prop.oM);
                }
                return '{}';
            };
            el.each(function(_i) {
                const pElem = $(this);
                const p = {
                    p       : pElem.find('.node-input-prop-property-name').typedInput('value'),
                    pt      : pElem.find('.node-input-prop-property-name').typedInput('type'),
                    v       : pElem.find('.node-input-prop-property-value').typedInput('value'),
                    vt      : pElem.find('.node-input-prop-property-value').typedInput('type'),
                    o       : pElem.find('.node-input-prop-property-offset').typedInput('value'),
                    oT      : pElem.find('.node-input-prop-property-offset').typedInput('type'),
                    oM      : pElem.find('.node-input-prop-property-multiplier').val(),
                    f       : '',
                    fS      : Number(pElem.find('.node-input-prop-property-FormatSel').val()),
                    fT      : pElem.find('.node-input-prop-property-FormatSel option:selected').text(),
                    fI      : pElem.find('.node-input-prop-property-FormatIp').val(),
                    next    : pElem.find('.node-input-prop-property-Next').is(':checked'),
                    days    : getCheckboxesStr(pElem.find('.node-input-prop-property-days input[type=checkbox]:checked'), 7),
                    months  : getCheckboxesStr(pElem.find('.node-input-prop-property-months input[type=checkbox]:checked'), 12),
                    onlyOddDays     : pElem.find('.node-input-prop-property-onlyOddDays').is(':checked'),
                    onlyEvenDays    : pElem.find('.node-input-prop-property-onlyEvenDays').is(':checked'),
                    onlyOddWeeks     : pElem.find('.node-input-prop-property-onlyOddWeeks').is(':checked'),
                    onlyEvenWeeks    : pElem.find('.node-input-prop-property-onlyEvenWeeks').is(':checked')
                };
                p.f = (p.fS !== 99 ? p.fS : p.fI);
                if (p.p === 'payload' && (!p.pt || p.pt === 'msg')) {
                    p.pt = 'msgPayload';
                } else if (p.p === 'topic' && (!p.pt || p.pt === 'msg')) {
                    p.pt = 'msgTopic';
                } else if (p.p === 'ts' && (!p.pt || p.pt === 'msg')) {
                    p.pt =  'msgTs';
                } else if (p.p === 'lc' && (!p.pt || p.pt === 'msg')) {
                    p.pt =  'msgLC';
                } else if (p.p === 'value' && (!p.pt || p.pt === 'msg')) {
                    p.pt = 'msgValue';
                }
                if (p.pt === 'msgPayload') {
                    result.payloadLbl = getPropTLbl(p);
                    result.payloadType = p.vt;
                }
                if (p.pt === 'msgTopic') {
                    result.topicLbl = getPropTLbl(p).replace(/(^")|("↷?↶?$)|({}↷?↶?)/g, '').trim();
                }
                result.props.push(p);
            });
            let pos = 0;
            while (result.payloadLbl === '' && el.length > pos) {
                const p = el[pos];
                if (p.pt !== 'msgTopic') {
                    result.payloadLbl = RED.nodes.getType('position-config').getRDGNodeValLbl(this, p.pt, p.p) + '=' + getPropTLbl(p);
                }
                pos++;
            }
            if (result.payloadLbl === '') {
                result.payloadLbl = '$!{lblInject}!';
            }
            return result;
        }

        /**
         * Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)
         */
        function doInject(node, customMsg) {
            console.log('doInject', customMsg); // eslint-disable-line no-console
            let payload = node.payload;
            if ((node.payloadType === 'flow') ||
                (node.payloadType === 'global')) {
                const key = RED.utils.parseContextKey(payload);
                payload = node.payloadType + '.' + key.key;
            }

            if (node.payloadType === 'str' || node.payloadType === 'string') { payload = '"' + node.payload + '"'; }

            let label = node._def.label.call(node, customMsg?customMsg.__user_inject_props__:undefined);
            if (label.length > 30) {
                label = label.substring(0, 50) + '...';
            }
            label = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            $.ajax({
                url: 'time-inject/' + node.id,
                type: 'POST',
                data: JSON.stringify(customMsg||{}),
                contentType: 'application/json; charset=utf-8',
                success(_resp) {
                    RED.notify(node._('node-red:inject.success',{ label }), { type:'success', id:'inject', timeout: 2000 });
                },
                error(jqXHR, textStatus, _errorThrown) {
                    if (jqXHR.status === 404) {
                        RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.not-deployed')}),'error');
                    } else if (jqXHR.status === 500) {
                        RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:inject.errors.failed')}),'error');
                    } else if (jqXHR.status === 0) {
                        RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.no-response')}),'error');
                    } else {
                        RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.unexpected',{status:jqXHR.status,message:textStatus})}),'error');
                    }
                }
            });
        }

        // category: 'time and astro',
        RED.nodes.registerType('time-inject', {
            category: 'common',
            color: '#a6bbcf',
            icon: 'injectSun-white.svg',
            inputs: 0,
            outputs: 1,
            paletteLabel: 'inject enhanced',
            align: 'left',
            defaults: {
                name: { value: '' },
                nameInt: { value: '' },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                props: {
                    value: [
                        {
                            p    : '',
                            pt   : 'msgPayload',
                            v    : '',
                            vt   : 'date',
                            o    : '',
                            oT   : 'none',
                            oM   : 60000,
                            f    : 0, // = (p.fS !== 99 ? p.fS : p.fI)
                            fS   : 0,
                            fI   : '', // input format
                            next : true,
                            days : '*',
                            months: '*'
                        },{
                            p    : '',
                            pt   : 'msgTopic',
                            v    : '',
                            vt   : 'str',
                            o    : '',
                            oT   : 'none',
                            oM   : 60000,
                            f    : 0, // = (p.fS !== 99 ? p.fS : p.fI)
                            fS   : 0,
                            fI   : '', // input format
                            next : false,
                            days : '*',
                            months: '*'
                        }
                    ]
                },
                injectTypeSelect: {
                    value: 'none'
                },
                intervalCount: {
                    value: 1,
                    validate(v) {
                        return (
                            (typeof this.injectTypeSelect === 'undefined') ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'time') ||
                            (this.injectTypeSelect === 'cron') ||
                            RED.validators.typedInput('intervalCountType')(v) ||
                            (v > 0)
                        );
                    }
                },
                intervalCountType: {
                    value: 'num'
                },
                intervalCountMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v) {
                        return (
                            (typeof this.injectTypeSelect === 'undefined') ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'time') ||
                            (this.injectTypeSelect === 'interval-amount') ||
                            (this.injectTypeSelect === 'cron') ||
                            RED.validators.number()(v)
                        );
                    }
                },
                intervalStart: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            (v === '') ||
                            (typeof v === 'undefined') ||
                            (this.injectTypeSelect !== 'interval') ||
                            RED.validators.regex(/^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}(:\d{1,2})?(.\d{1,3})?Z?$|^\d{2}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}(:\d{1,2})?(.\d{1,3})?Z?$/)(v)
                        );
                    }
                },
                cron: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (this.injectTypeSelect !== 'cron') ||
                                RED.validators.typedInput('cronType')(v);
                    }
                },
                cronType: {
                    value: 'cronexpr'
                },
                time: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            ((this.injectTypeSelect !== 'interval-time') &&
                            (this.injectTypeSelect !== 'interval-amount') &&
                            (this.injectTypeSelect !== 'time')) ||
                            RED.validators.typedInput('timeType')(v)
                        );
                    }
                },
                timeType: {
                    value: 'entered'
                },
                offset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.offsetType === 'undefined') ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'interval') ||
                            (this.injectTypeSelect === 'cron') ||
                            RED.validators.typedInput('offsetType')(v)
                        );
                    }
                },
                offsetType: {
                    value: 'none'
                },
                offsetMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.number()(v) ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'interval') ||
                            (this.injectTypeSelect === 'cron') ||
                            $('#node-input-offsetType').typedInput('type') === 'none' ||
                            this.offsetType === 'none'
                        );
                    }
                },
                timeEnd: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            ((this.injectTypeSelect !== 'interval-time') &&
                            (this.injectTypeSelect !== 'interval-amount')) ||
                            RED.validators.typedInput('timeEndType')(v)
                        );
                    }
                },
                timeEndType: {
                    value: 'entered'
                },
                timeEndOffset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.timeEndOffsetType === 'undefined') ||
                            ((this.injectTypeSelect !== 'interval-time') &&
                            (this.injectTypeSelect !== 'interval-amount')) ||
                            RED.validators.typedInput('timeEndOffsetType')(v)
                        );
                    }
                },
                timeEndOffsetType: {
                    value: 'none'
                },
                timeEndOffsetMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.number()(v) ||
                            ((this.injectTypeSelect !== 'interval-time') &&
                            (this.injectTypeSelect !== 'interval-amount')) ||
                            $('#node-input-timeEndOffsetType').typedInput('type') === 'none' ||
                            this.timeEndOffsetType === 'none'
                        );
                    }
                },
                timeDays: {
                    value: '*',
                    required: true
                },
                timeOnlyOddDays: {
                    value: false,
                    required: true
                },
                timeOnlyEvenDays: {
                    value: false,
                    required: true
                },
                timeOnlyOddWeeks: {
                    value: false,
                    required: true
                },
                timeOnlyEvenWeeks: {
                    value: false,
                    required: true
                },
                timeMonths: {
                    value: '*',
                    required: true
                },
                timedatestart: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'interval') ||
                            (this.injectTypeSelect === 'cron') ||
                            RED.validators.regex(/^$|^\d{4}-\d{1,2}-\d{1,2}$|^\d{2}-\d{1,2}-\d{1,2}$/)(v)
                        );
                    }
                },
                timedateend: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            (this.injectTypeSelect === 'none') ||
                            (this.injectTypeSelect === 'interval') ||
                            (this.injectTypeSelect === 'cron') ||
                            RED.validators.regex(/^$|^\d{4}-\d{1,2}-\d{1,2}$|^\d{2}-\d{1,2}-\d{1,2}$/)(v)
                        );
                    }
                },
                property: {
                    value: '',
                    required: false,
                    validate(v){
                        return (
                            typeof v === 'undefined' ||
                            typeof this.propertyType === 'undefined' ||
                            (this.injectTypeSelect !== 'time') ||
                            RED.validators.typedInput('propertyType')(v)
                        );
                    }
                },
                propertyType: {
                    value: 'none'
                },
                propertyCompare: {
                    value: 'true'
                },
                propertyThreshold: {
                    value: '',
                    validate(v){
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.typedInput('propertyThresholdType')(v) ||
                            (this.injectTypeSelect !== 'time') ||
                            typeof this.propertyType === 'undefined' ||
                            ($('#node-input-propertyType').length ?
                                $('#node-input-property').typedInput('type') === 'none' :
                                this.propertyType === 'none')
                        );
                    }
                },
                propertyThresholdType: {
                    value: 'num'
                },
                timeAlt: {
                    value: '',
                    required: false,
                    validate(v){
                        return (
                            RED.validators.typedInput('timeAltType')(v) ||
                            (this.injectTypeSelect !== 'time') ||
                            typeof this.propertyType === 'undefined' ||
                            ($('#node-input-propertyType').length ?
                                $('#node-input-property').typedInput('type') === 'none' :
                                this.propertyType === 'none')
                        );
                    }
                },
                timeAltType: {
                    value: 'entered'
                },
                timeAltDays: {
                    value: '*',
                    required: true
                },
                timeAltOnlyOddDays: {
                    value: false,
                    required: true
                },
                timeAltOnlyEvenDays: {
                    value: false,
                    required: true
                },
                timeAltOnlyOddWeeks: {
                    value: false,
                    required: true
                },
                timeAltOnlyEvenWeeks: {
                    value: false,
                    required: true
                },
                timeAltMonths: {
                    value: '*',
                    required: true
                },
                timeAltOffset: {
                    value: 0,
                    validate(v){
                        return (
                            typeof v === 'undefined' ||
                            (typeof this.timeAltOffsetType === 'undefined') ||
                            (this.injectTypeSelect !== 'time') ||
                            RED.validators.typedInput('timeAltOffsetType')(v) ||
                            typeof this.propertyType === 'undefined' ||
                            ($('#node-input-propertyType').length ?
                                $('#node-input-property').typedInput('type') === 'none' :
                                this.propertyType === 'none')
                        );
                    }
                },
                timeAltOffsetType: {
                    value: 'none'
                },
                timeAltOffsetMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v){
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.number()(v) ||
                            $('#node-input-timeAltOffsetType').typedInput('type') === 'none' ||
                            this.timeAltOffsetType === 'none' ||
                            (this.injectTypeSelect !== 'time') ||
                            typeof this.propertyType === 'undefined' ||
                            ($('#node-input-propertyType').length ?
                                $('#node-input-property').typedInput('type') === 'none' :
                                this.propertyType === 'none')
                        );
                    }
                },
                once: {
                    value: false
                },
                onceDelay: {
                    value: 0.1,
                    validate(v){
                        return (
                            RED.validators.number()(v) ||
                            v === '' ||
                            v === null ||
                            typeof v === 'undefined'
                        );
                    }
                },
                recalcTime: {
                    value: 2,
                    validate(v){
                        return (
                            RED.validators.number()(v) ||
                            v === '' ||
                            v === null ||
                            typeof v === 'undefined'
                        );
                    }
                },
                payload: { value: '' }, // p
                payloadType: { value: 'date' }, // vt
                payloadTimeFormat: { value: 0 }, // f
                payloadOffset: { value: 0 }, // o
                payloadOffsetType: { value: 'none' }, // oT
                payloadOffsetMultiplier: { value: 60000 }, // oM
                topic: { value: '' }, // p
                addPayload1: { value: '' }, // p
                addPayload2: { value: '' }, // p
                addPayload3: { value: '' }, // p
                addPayload1Type: { value: 'none' },
                addPayload2Type: { value: 'none' },
                addPayload3Type: { value: 'none' },
                addPayload1Value: { value: '' }, // v
                addPayload2Value: { value: '' }, // v
                addPayload3Value: { value: '' }, // v
                addPayload1ValueType: { value: '' },
                addPayload2ValueType: { value: '' },
                addPayload3ValueType: { value: '' },
                addPayload1Format: { value: 0 }, // f
                addPayload2Format: { value: 0 }, // f
                addPayload3Format: { value: 0 }, // f
                addPayload1Offset: { value: 0 }, // o
                addPayload2Offset: { value: 0 }, // o
                addPayload3Offset: { value: 0 }, // o
                addPayload1OffsetType: { value: 'none' },
                addPayload2OffsetType: { value: 'none' },
                addPayload3OffsetType: { value: 'none' },
                addPayload1OffsetMultiplier: { value: 60000 },
                addPayload2OffsetMultiplier: { value: 60000 },
                addPayload3OffsetMultiplier: { value: 60000 },
                addPayload1Next: { value: true },
                addPayload2Next: { value: true },
                addPayload3Next: { value: true },
                addPayload1Days: { value: '*' },
                addPayload2Days: { value: '*' },
                addPayload3Days: { value: '*' }
            },
            outputLabels(_index) {
                const types = {
                    msgPayload : 'msg.payload',
                    msgTopic   : 'msg.topic',
                    msgTs      : 'msg.ts',
                    msgLC      : 'msg.lc',
                    msgValue   : 'msg.value'
                };

                const labels = {
                    str: 'string',
                    num: 'number',
                    bool: 'boolean',
                    flow: 'flow context',
                    global: 'global context',
                    bin: 'binary data',
                    date: 'timestamp',
                    dateSpecific: 'special timestamp',
                    entered: 'timestamp',
                    dateEntered: 'timestamp',
                    env: 'Environment variable',
                    jsonata: 'result of jsonata expression',
                    dayOfMonth: 'timestamp',
                    pdsTime: 'sun time',
                    pdsTimeNow: 'sun time object',
                    pdsTimeCustom: 'sun time (custom)',
                    pdmTime: 'moon time',
                    pdsCalcPercent: 'percent of sun in the sky',
                    pdsCalcAzimuth: 'Azimuth of sun',
                    pdsCalcElevation: 'Elevation of sun',
                    pdsCalcData: 'object of sun position',
                    pdmCalcData: 'object of moon position',
                    pdmPhase: 'object of moon phase',
                    pdmPhaseCheck: 'boolean indicates if moon in specific phase',
                    pdbIsDST: 'is DST',
                    pdnWeekOfYear: 'week number',
                    pdbWeekOfYearEven: 'is week even',
                    pdnDayOfYear: 'day number',
                    pdbDayOfYearEven: 'is day even'
                };

                // if only payload and topic - display payload type
                // if only one property - show it's type
                // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
                // this.props will not be an array for legacy inject nodes until they are re-deployed
                //
                let props = this.props;
                if (!Array.isArray(props)) {
                    props = [{
                        p    : '',
                        pt   : types.MsgPayload.value,
                        v    : this.payload ? this.payload : '',
                        vt   : this.payloadType ? ((this.payloadType === 'string') ? 'str' : this.payloadType) : (this.payload ? 'str' : 'date'),
                        o    : this.payloadOffset ? this.payloadOffset : 1,
                        oT   : (this.payloadOffset === 0 || this.payloadOffset === '') ? types.Undefined.value : (this.payloadOffsetType ? this.payloadOffsetType : 'num'),
                        oM   : this.payloadOffsetMultiplier ? this.payloadOffsetMultiplier : 60000,
                        f    : this.payloadTimeFormat ? this.payloadTimeFormat : 0,
                        next : true,
                        days : '*',
                        months: '*'
                    },{
                        p    : '',
                        pt   : types.MsgTopic.value,
                        v    : this.topic ? this.topic : '',
                        vt   : 'str',
                        o    : 1,
                        oT   : types.Undefined.value,
                        oM   : 60000,
                        f    : 0,
                        next : false,
                        days : '*',
                        months: '*'
                    }];
                }
                let lab = '';
                if (props) {
                    let cnt = -1;
                    for (let i=0, l=props.length; i<l; i++) {
                        if (!props[i].pt.includes('msg')) { continue; }
                        cnt++;
                        if (cnt > 0) lab += '\n';
                        if (cnt === 5) {
                            lab += ' + ' + (props.length - 4);
                            break;
                        }
                        lab += (types[props[i].pt] ? types[props[i].pt] : (props[i].pt + '.' + props[i].p)) + ': ';
                        let propType = labels[props[i].vt] ? labels[props[i].vt] : props[i].vt;
                        if (propType === 'json' || propType === 'object') {
                            try {
                                const parsedProp = JSON.parse(props[i].v);
                                propType = typeof parsedProp;
                                if (propType === 'object' && Array.isArray(parsedProp)) {
                                    propType = 'Array';
                                }
                            } catch(e) {
                                propType = 'invalid';
                            }
                        }
                        lab += propType;
                        // lab += this._('inject.label.'+propType);
                    }
                }
                return lab || '?';
            },
            label(customProps) {
                const injTxt = this._('time-inject.label.time-inject');
                let result = '';
                if (!this.positionConfig || !this.nameInt || !this.injectTypeSelect) {
                    result += '⚠ ';
                }
                if (customProps && customProps.payloadLbl) {
                    if (customProps.topicLbl && customProps.topicLbl.length + customProps.payloadLbl.length <= 45) {
                        return result + customProps.topicLbl + ':' + customProps.payloadLbl.replace('$!{lblInject}!', injTxt);
                    }
                    return result + customProps.payloadLbl.replace('$!{lblInject}!', injTxt);
                }
                if (this.name) {
                    return result + this.name;
                }
                if (this.nameInt) {
                    if (this.topicLbl && this.topicLbl.length + this.nameInt.length <= 45) {
                        return result + this.topicLbl + ':' + this.nameInt.replace('$!{lblInject}!', injTxt);
                    }
                    return result + this.nameInt.replace('$!{lblInject}!', injTxt);
                }
                if (this.topicLbl) {
                    return result + this.topicLbl + ':' + injTxt;
                }
                return result + injTxt;
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            oneditprepare() {
                setTimeout(() => {
                    $('.is-to-show-initial').show();
                    $('.is-to-hide-initial').hide();
                }, 300);
                const node = this;
                const $nodeConfig = $('#node-input-positionConfig');
                const setup = function(node) {
                    setTimeout(() => {
                        $('.is-to-show-normally').show();
                    }, 300);

                    /* global initializeValue getTypes getSelectFields appendOptions setupTInput autocomplete addLabel initCombobox initCheckboxesBlock getBackendData bdDateToTime getCheckboxesStr setTInputValue */
                    const types = getTypes(node, () => $nodeConfig.val());
                    const selFields = getSelectFields();
                    // #region initialize
                    /**
                    * update multiplier settings from a previous version
                    * @param {number} mp - the multiplier value
                    * @param {string} name - the name of the element
                    * @param {function} onchange - the function to be called on field change
                    * @returns {number} the updated multiplier value
                    */
                    function multiplierUpdate(mp, name, onchange) {
                        const $field = $('#node-input-' + name);
                        appendOptions(node, $field, 'multiplier', data => (data.id > 0));
                        if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                            mp = 60000;
                        } else {
                            mp = parseFloat(mp);
                            if (mp === 1) {
                                mp = 1000;
                            } else if (mp === 60) {
                                mp = 60000;
                            } else if (mp === 3600) {
                                mp = 3600000;
                            }
                        }
                        $field.val(mp);
                        $field.on('change', onchange);
                        return mp;
                    }
                    /**
                     * Parse an ISO date string (i.e. "2019-01-18T00:00:00.000Z",
                     * "2019-01-17T17:00:00.000-07:00", or "2019-01-18T07:00:00.000+07:00",
                     * which are the same time) and return a JavaScript Date object with the
                     * value represented by the string.
                     * @param {string} dateString - ISO Date String
                     * @returns {Date} Date object
                     */
                    function parseDate(dateString) {
                        const b = dateString.split(/\D+/);
                        const offsetMult = dateString.indexOf('+') !== -1 ? -1 : 1;
                        const hrOffset = offsetMult * (+b[7] || 0);
                        const minOffset = offsetMult * (+b[8] || 0);
                        return new Date(Date.UTC(+b[0], +b[1] - 1, +b[2], +b[3] + hrOffset, +b[4] + minOffset, +b[5], +b[6] || 0));
                    }


                    initializeValue(node, 'timeDays', '*');
                    initializeValue(node, 'timeAltDays', '*');
                    initializeValue(node, 'timeMonths', '*');
                    initializeValue(node, 'timeAltMonths', '*');
                    // #endregion initialize
                    // #region property Container
                    /**
                     * resizes a rule container
                     */
                    function resizeContainer() {
                        const editorRow = $('.node-input-property-container-row ol');
                        const height =  editorRow.outerHeight(true);
                        const rowCount = $('#node-input-property-container').editableList('length');
                        if (rowCount > 0) {
                            $('#node-input-property-container').editableList('height', height + 40);
                        } else {
                            $('#node-input-property-container').editableList('height', 20);
                        }
                    }

                    const $propList = $('#node-input-property-container').css('min-height', '40px').css('min-width', '420px');

                    $propList.editableList({
                        buttons: [
                            {
                                id: 'node-time-inject-test-inject-button',
                                label: node._('node-red:inject.injectNow'),
                                click(_e) {
                                    const props = getProps($propList.editableList('items'), node);
                                    const m = {__user_inject_props__: props};
                                    doInject(node, m);
                                }
                            }
                        ],
                        addItem($containerRow, containerIndex, data) {
                            $containerRow.css({overflow: 'hidden', whiteSpace: 'nowrap'});
                            const $row1 = $('<div/>').appendTo($containerRow);
                            const $row2 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo($containerRow);
                            const $row3 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo($containerRow);
                            const $row4 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo($containerRow);
                            // row1 - Property / Type Selection
                            let prop = data;
                            if (!Object.prototype.hasOwnProperty.call(prop, 'p')) {
                                prop = {
                                    p    : '',
                                    pt   : types.MsgPayload.value,
                                    v    : '',
                                    vt   : 'str',
                                    o    : '',
                                    oT   : types.Undefined.value,
                                    oM   : 60000,
                                    f    : 0,
                                    next : true,
                                    days : '*',
                                    months: '*'
                                };
                            }

                            if (prop.p === 'payload' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgPayload.value;
                            } else if (prop.p === 'topic' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgTopic.value;
                            } else if (prop.p === 'ts' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgTs.value;
                            } else if (prop.p === 'lc' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgLc.value;
                            } else if (prop.p === 'value' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgValue.value;
                            }
                            const $propertyName = $('<input/>', {
                                class: 'node-input-prop-property-name',
                                type: 'text'
                            })
                                .css('width', '40%')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        types.MsgPayload,
                                        types.MsgTopic,
                                        types.MsgTs,
                                        types.MsgLc,
                                        types.MsgValue,
                                        'msg',
                                        'flow',
                                        'global'
                                    ]
                                });
                            setTInputValue($propertyName, prop.p, prop.pt);

                            $('<div/>', { style: 'display:inline-block; padding:0px 6px;' })
                                .text('=')
                                .appendTo($row1);
                            const $propertyValue = $('<input/>', {
                                class:'node-input-prop-property-value',
                                type: 'text'
                            })
                                .css('width', 'calc(60% - 30px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: 'str',
                                    types: [
                                        'str',
                                        'num',
                                        'bool',
                                        'date',
                                        types.DateSpecific,
                                        types.TimeEntered,
                                        types.DateEntered,
                                        types.TimeSun,
                                        types.TimeSunCustom,
                                        types.TimeSunNow,
                                        types.TimeMoon,
                                        types.DayOfMonth,
                                        types.strPlaceholder,
                                        'json',
                                        'bin',
                                        'env',
                                        'flow',
                                        'global',
                                        'jsonata',
                                        types.SunCalc,
                                        types.SunInSky,
                                        types.MoonCalc,
                                        types.MoonPhase,
                                        types.SunAzimuth,
                                        types.SunElevation,
                                        types.SunTimeByAzimuth,
                                        types.SunTimeByElevationObj,
                                        types.SunTimeByElevationNext,
                                        types.SunTimeByElevationRise,
                                        types.SunTimeByElevationSet,
                                        types.isDST,
                                        types.WeekOfYear,
                                        types.WeekOfYearEven,
                                        types.DayOfYear,
                                        types.DayOfYearEven,
                                        types.numPercent,
                                        types.randomNumber,
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek,
                                        types.nodeId,
                                        types.nodeName,
                                        types.nodePath
                                    ]
                                });
                            setTInputValue($propertyValue, prop.v, prop.vt);

                            // row2 - Format Selection
                            const operandSelFieldName = 'node-input-prop-property-FormatSel';
                            addLabel($row2, operandSelFieldName, 'fa fa-file-code-o');

                            const $formatSel = $('<select/>', {
                                class: operandSelFieldName
                            }).appendTo($row2);
                            const $formatIp = $('<input/>', {
                                class: 'node-input-prop-property-FormatIp',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 30px)')
                                .appendTo($row2);
                            initCombobox(node, $formatSel, $formatIp, 'dateOutFormat', 'outputFormats', prop.f ? prop.f : 0, -70);

                            // row3 - Offset and Multiplier
                            addLabel($row3, 'node-input-prop-property-offset', 'fa fa-plus');

                            const $offset = $('<input/>', {
                                class: 'node-input-prop-property-offset',
                                type: 'text',
                                value: (prop.o ? prop.o : '')
                            })
                                .css('width', '70%')
                                .appendTo($row3)
                                .typedInput({
                                    default: (prop.oT ? prop.oT : types.Undefined.value),
                                    types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek]
                                });
                            setTInputValue($offset, prop.o, prop.oT);

                            const $multiplier = $('<select/>', {
                                class: 'node-input-prop-property-multiplier'
                            })
                                .css('width', 'calc(30% - 30px)')
                                .appendTo($row3);
                            appendOptions(node, $multiplier, 'multiplier');
                            $multiplier.val(prop.oM ? prop.oM: 60000);

                            // row4 - Next, Day, Month selection
                            // row4 - 1 - Next selection
                            const $divNext = $('<div/>').appendTo($row4);
                            addLabel($divNext, 'node-input-prop-property-Next', 'fa fa-clock-o', node._('node-red-contrib-sun-position/position-config:common.label.nextOccurrence'));
                            const $cbNext = $('<input/>', {
                                class: 'node-input-prop-property-Next',
                                type: 'checkbox',
                                style: 'display:inline-block; width:15px; vertical-align:baseline;'
                            })
                                .css('width', 'calc(30% - 30px)')
                                .appendTo($divNext);
                            if (typeof prop.next === 'undefined' || prop.next === null || prop.next == true) { // eslint-disable-line eqeqeq
                                $cbNext.prop('checked', true);
                            } else {
                                $cbNext.prop('checked', false);
                            }
                            // row4 - 2 - Day selection
                            const $divMnDays = $('<div/>', {
                                style: 'margin-top:5px;border-top: 1px solid #000;margin-bottom: 0;'
                            }
                            ).appendTo($row4);
                            addLabel($divMnDays, 'node-input-prop-property-days', 'fa fa-clock-o', node._('node-red-contrib-sun-position/position-config:common.label.validForDays'));

                            const $divDays = $('<div/>', {
                                class: 'node-input-prop-property-days',
                                style: 'style="display:inline-block;'
                            }).appendTo($divMnDays);
                            const $divDays2 = $('<div/>').appendTo($divDays);

                            for (let d = 0; d < 7; d++) {
                                const $lbl = $('<label/>', {
                                    title: node._('node-red-contrib-sun-position/position-config:common.days.' + d)
                                })
                                    .css('width', 'calc(14% - 7px)') // (100% / 7 = 14%) - (30 px / 7 = 7px)
                                    .appendTo($divDays2);
                                const $cb = $('<input/>', {
                                    type: 'checkbox',
                                    class: 'node-input-prop-property-day-' + d,
                                    value: d,
                                    style: 'width: auto;'
                                }).appendTo($lbl);
                                $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.days.' + (d + 7))).appendTo($lbl);
                                if (typeof prop.days === 'undefined' || prop.days === null || prop.days === '*') {
                                    $cb.prop('checked', true);
                                } else if (prop.days !== '' && prop.days !== 'none') {
                                    $cb.prop('checked', false);
                                    prop.days.split(',').forEach(v => {
                                        if (v == d) { // eslint-disable-line eqeqeq
                                            $cb.prop('checked', true);
                                        }
                                    });
                                }
                            }
                            // row4 - 3 - Special Limit selection
                            const $divSpecLimit = $('<div/>', {
                                style: 'margin-top:5px;border-top: 1px solid #000;margin-bottom: 0;'
                            }
                            ).appendTo($row4);
                            addLabel($divSpecLimit, 'node-input-prop-property-speciallimits', 'fa fa-clock-o', node._('node-red-contrib-sun-position/position-config:common.label.specialLimits'));

                            const $divSpecLimits = $('<div/>', {
                                class: 'node-input-prop-property-speciallimits',
                                style: 'style="display:inline-block;'
                            }).appendTo($divSpecLimit);
                            const $divSpecLimits2 = $('<div/>').appendTo($divSpecLimits);
                            const $divSpecLimits3 = $('<div/>').appendTo($divSpecLimits);

                            const $lblSL1 = $('<label/>', {
                                title: node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenDays'),
                                style: 'width:calc(50% - 15px);'  // (100% / 2) - (30 px / 2)
                            })
                                .appendTo($divSpecLimits2);
                            const $cbOnlyEvenDays = $('<input/>', {
                                type: 'checkbox',
                                class: 'node-input-prop-property-onlyEvenDays',
                                style: 'width: auto;'
                            }).appendTo($lblSL1);
                            $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenDays')).appendTo($lblSL1);
                            $cbOnlyEvenDays.prop('checked', (prop.onlyEvenDays === 'true' || prop.onlyEvenDays === true));

                            const $lblSL2 = $('<label/>', {
                                title: node._('node-red-contrib-sun-position/position-config:common.label.onlyOddDays'),
                                style: 'width:calc(50% - 15px);'  // (100% / 2) - (30 px / 2)
                            })
                                .appendTo($divSpecLimits2);
                            const $cbOnlyOddDays = $('<input/>', {
                                type: 'checkbox',
                                class: 'node-input-prop-property-onlyOddDays',
                                style: 'width: auto;'
                            }).appendTo($lblSL2);
                            $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddDays')).appendTo($lblSL2);
                            $cbOnlyOddDays.prop('checked', (prop.onlyOddDays === 'true' || prop.onlyOddDays === true));

                            const $lblSL3 = $('<label/>', {
                                title: node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks'),
                                style: 'width:calc(50% - 15px);'  // (100% / 2) - (30 px / 2)
                            })
                                .appendTo($divSpecLimits3);
                            const $cbOnlyEvenWeeks = $('<input/>', {
                                type: 'checkbox',
                                class: 'node-input-prop-property-onlyEvenWeeks',
                                style: 'width: auto;'
                            }).appendTo($lblSL3);
                            $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks')).appendTo($lblSL3);
                            $cbOnlyEvenWeeks.prop('checked', (prop.onlyEvenWeeks === 'true' || prop.onlyEvenWeeks === true));

                            const $lblSL4 = $('<label/>', {
                                title: node._('node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks'),
                                style: 'width:calc(50% - 15px);'  // (100% / 2) - (30 px / 2)
                            })
                                .appendTo($divSpecLimits3);
                            const $cbOnlyOddWeeks = $('<input/>', {
                                type: 'checkbox',
                                class: 'node-input-prop-property-onlyOddWeeks',
                                style: 'width: auto;'
                            }).appendTo($lblSL4);
                            $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks')).appendTo($lblSL4);
                            $cbOnlyOddWeeks.prop('checked', (prop.onlyOddWeeks === 'true' || prop.onlyOddWeeks === true));
                            // row4 - 3 - Month selection
                            const $divMnMonth = $('<div/>', {
                                style: 'margin-top:5px;border-top: 1px solid #000;margin-bottom: 0;'
                            }
                            ).appendTo($row4);
                            addLabel($divMnMonth, 'node-input-prop-property-months', 'fa fa-clock-o', node._('node-red-contrib-sun-position/position-config:common.label.validForMonths'));

                            const $divMonths = $('<div/>', {
                                class: 'node-input-prop-property-months',
                                style: 'style="display:inline-block;'
                            }).appendTo($divMnMonth);
                            const $divMonths2 = $('<div/>').appendTo($divMonths);
                            const $divMonths3 = $('<div/>').appendTo($divMonths);

                            for (let m = 0; m < 12; m++) {
                                const $lbl = $('<label/>', {
                                    title: node._('node-red-contrib-sun-position/position-config:common.months.' + m)
                                })
                                    .css('width', 'calc(16% - 6px)') // (100% / 7 = 14%) - (30 px / 7 = 6px)
                                    .appendTo((m>5) ? $divMonths3 : $divMonths2);
                                const $cb = $('<input/>', {
                                    type: 'checkbox',
                                    class: 'node-input-prop-property-month-' + m,
                                    value: m,
                                    style: 'width: auto;'
                                }).appendTo($lbl);
                                $('<span/>').text(node._('node-red-contrib-sun-position/position-config:common.months.' + (m + 12))).appendTo($lbl);
                                if (typeof prop.months === 'undefined' || prop.months === null || prop.months === '*') {
                                    $cb.prop('checked', true);
                                } else if (prop.months !== '' && prop.months !== 'none') {
                                    $cb.prop('checked', false);
                                    prop.months.split(',').forEach(v => {
                                        if (v == m) { // eslint-disable-line eqeqeq
                                            $cb.prop('checked', true);
                                        }
                                    });
                                }
                            }

                            // changes
                            $propertyValue.change(() => {
                                // $operand.show();
                                // const plNType = $propertyName.typedInput('type');
                                const plVType = $propertyValue.typedInput('type');
                                if (plVType === types.TimeEntered.value ||
                                    plVType === types.TimeSun.value ||
                                    plVType === types.TimeSunCustom.value ||
                                    plVType === types.TimeMoon.value) {
                                    $row2.show(); // format
                                    $row3.show(); // offset
                                    $row4.show(); // next + days
                                } else if ( plVType === types.DateEntered.value ||
                                            plVType === types.DateSpecific.value ||
                                            plVType === types.DayOfMonth.value) {
                                    $row2.show(); // format
                                    $row3.show(); // offset
                                    $row4.hide(); // next + days + month
                                } else if (plVType === types.TimeSunNow.value) {
                                    $row2.hide(); // format
                                    $row3.show(); // offset
                                    $row4.hide(); // next + days + month
                                } else {
                                    $row2.hide(); // format
                                    $row3.hide(); // offset
                                    $row4.hide(); // next + days + month
                                }
                                getBackendData(d => {
                                    $containerRow.attr('title', bdDateToTime(d));
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           plVType,
                                    value:          $propertyValue.typedInput('value'),
                                    format:         $formatIp.val(),
                                    offsetType:     $offset.typedInput('type'),
                                    offset:         $offset.typedInput('value'),
                                    multiplier:     $multiplier.val(),
                                    next:           $cbNext.is(':checked'),
                                    days:           getCheckboxesStr($divDays.find('input[type=checkbox]:checked'), 7),
                                    months:         getCheckboxesStr($divMonths.find('input[type=checkbox]:checked'), 12),
                                    onlyOddDays:    $cbOnlyEvenDays.is(':checked'),
                                    onlyEvenDays:   $cbOnlyOddDays.is(':checked'),
                                    onlyOddWeeks:    $cbOnlyEvenWeeks.is(':checked'),
                                    onlyEvenWeeks:   $cbOnlyOddWeeks.is(':checked'),
                                    noOffsetError:  true
                                });
                                resizeContainer();
                            });
                            $multiplier.change(() => $propertyValue.change());
                            $offset.change(() => {
                                const type = $offset.typedInput('type');
                                if (type === types.Undefined.value) {
                                    $multiplier.prop('disabled', true);
                                } else {
                                    $multiplier.prop('disabled', false);
                                }
                                $propertyValue.change();
                            });
                            $formatSel.change(() => $propertyValue.change());
                            $formatIp.change(() => $propertyValue.change());
                            $propertyValue.change();
                            autocomplete($formatIp, 'dateParseFormat');
                            resizeContainer();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                $(this).find('.node-input-rule-index').html(i + 1);
                            });
                        },
                        // resizeItem: resizeRule,
                        sortable: true,
                        removable: true,
                        removeItem: resizeContainer
                    });
                    $('#node-time-inject-test-inject-button').css('float', 'right').css('margin-right', 'unset');

                    if (RED.nodes.subflow(node.z)) {
                        $('#node-time-inject-test-inject-button').attr('disabled', true);
                    }

                    if (!node.props) {
                        node.props = [];
                        node.props.push({
                            p    : '',
                            pt   : types.MsgPayload.value,
                            v    : node.payload ? node.payload : '',
                            vt   : node.payloadType ? ((node.payloadType === 'string') ? 'str' : node.payloadType) : (node.payload ? 'str' : 'date'),
                            o    : node.payloadOffset ? node.payloadOffset : 1,
                            oT   : (node.payloadOffset === 0 || node.payloadOffset === '') ? types.Undefined.value : (node.payloadOffsetType ? node.payloadOffsetType : 'num'),
                            oM   : node.payloadOffsetMultiplier ? node.payloadOffsetMultiplier : 60000,
                            f    : node.payloadTimeFormat ? node.payloadTimeFormat : 0,
                            next : true,
                            days : '*',
                            months: '*'
                        });

                        node.props.push({
                            p    : '',
                            pt   : types.MsgTopic.value,
                            v    : node.topic ? node.topic : '',
                            vt   : 'str',
                            o    : 1,
                            oT   : types.Undefined.value,
                            oM   : 60000,
                            f    : 0,
                            next : false,
                            days : '*',
                            months: '*'
                        });

                        if (node.addPayload1Type && node.addPayload1Type !== types.Undefined.value) {
                            node.props.push({
                                p    : node.addPayload1,
                                pt   : node.addPayload1Type,
                                v    : node.addPayload1Value,
                                vt   : node.addPayload1ValueType ? ((node.addPayload1ValueType === 'string') ? 'str' : node.addPayload1ValueType) : (node.addPayload1Value ? 'str' : 'date'),
                                o    : node.addPayload1Offset ? node.addPayload1Offset : 1,
                                oT   : (node.addPayload1Offset === 0 || node.addPayload1Offset === '') ? types.Undefined.value : (node.addPayload1OffsetType ? node.addPayload1OffsetType : 'num'),
                                oM   : node.addPayload1OffsetMultiplier ? node.addPayload1OffsetMultiplier : 60000,
                                f    : node.addPayload1Format ? node.addPayload1Format : 0,
                                next : node.addPayload1Next,
                                days : node.addPayload1Days ? node.addPayload1Days : '*',
                                months: '*'
                            });
                        }
                        if (node.addPayload2Type && node.addPayload2Type !== types.Undefined.value) {
                            node.props.push({
                                p    : node.addPayload2,
                                pt   : node.addPayload2Type,
                                v    : node.addPayload2Value,
                                vt   : node.addPayload2ValueType ? ((node.addPayload2ValueType === 'string') ? 'str' : node.addPayload2ValueType) : (node.addPayload2Value ? 'str' : 'date'),
                                o    : node.addPayload2Offset ? node.addPayload2Offset : 1,
                                oT   : (node.addPayload2Offset === 0 || node.addPayload2Offset === '') ? types.Undefined.value : (node.addPayload2OffsetType ? node.addPayload2OffsetType : 'num'),
                                oM   : node.addPayload2OffsetMultiplier ? node.addPayload2OffsetMultiplier : 60000,
                                f    : node.addPayload2Format ? node.addPayload2Format : 0,
                                next : node.addPayload2Next,
                                days : node.addPayload2Days ? node.addPayload2Days : '*',
                                months: '*'
                            });
                        }

                        if (node.addPayload3Type && node.addPayload3Type !== types.Undefined.value) {
                            node.props.push({
                                p    : node.addPayload3,
                                pt   : node.addPayload3Type,
                                v    : node.addPayload3Value,
                                vt   : node.addPayload3ValueType ? ((node.addPayload3ValueType === 'string') ? 'str' : node.addPayload3ValueType) : (node.addPayload3Value ? 'str' : 'date'),
                                o    : node.addPayload3Offset ? node.addPayload3Offset : 1,
                                oT   : (node.addPayload3Offset === 0 || node.addPayload3Offset === '') ? types.Undefined.value : (node.addPayload3OffsetType ? node.addPayload3OffsetType : 'num'),
                                oM   : node.addPayload3OffsetMultiplier ? node.addPayload3OffsetMultiplier : 60000,
                                f    : node.addPayload3Format ? node.addPayload3Format : 0,
                                next : node.addPayload3Next,
                                days : node.addPayload3Days ? node.addPayload3Days : '*',
                                months: '*'
                            });
                        }
                    }

                    for (let i = 0; i < node.props.length; i++) {
                        const prop = node.props[i];
                        $propList.editableList('addItem', prop);
                    }
                    // #endregion property Container
                    // #region spinner
                    $('#node-input-once').change(() => {
                        $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
                    });

                    $('.wt-offset-time').spinner({
                        max: 1439,
                        min: -1439
                    });
                    $('#node-input-onceDelay').spinner({
                        step: 0.1,
                        numberFormat: 'n'
                    });
                    $('#node-input-recalcTime').spinner({
                        step: 0.1,
                        numberFormat: 'n'
                    });
                    // #endregion spinner
                    // #region onceDelay + TimeType
                    $('#node-input-once').change(() => {
                        $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
                    });
                    const id = $('#node-input-injectTypeSelect').val();
                    if (!id) {
                        const timeType = $('#node-input-timeType').val();
                        if (!timeType || timeType === types.Undefined.value) {
                            $('#node-input-injectTypeSelect').val('none');
                            $('#node-input-timeType').val(types.TimeEntered.value);
                            node.timeType = types.TimeEntered.value;
                        } else {
                            $('#node-input-injectTypeSelect').val('time');
                        }
                    }
                    $('#node-input-injectTypeSelect').on('change', () => {
                        const id = $('#node-input-injectTypeSelect').val();
                        $('.time-inject-row-all').hide();
                        switch (id) {
                            case 'interval':
                                $('.time-inject-row-interval').show();
                                $('.time-inject-row-intervalFromStart').show();
                                $('#node-input-intervalCountMultiplier').show();
                                $("#node-input-intervalCountMultiplier option[value='86400000']").prop('disabled',false); // days
                                $("#node-input-intervalCountMultiplier option[value='604800000']").prop('disabled',false); // weeks
                                break;
                            case 'interval-time':
                                $('.time-inject-row-intervalTime').show();
                                $('#node-input-intervalCountMultiplier').show();
                                $("#node-input-intervalCountMultiplier option[value='86400000']").prop('disabled',true); // days
                                $("#node-input-intervalCountMultiplier option[value='604800000']").prop('disabled',true); // weeks
                                $('#node-input-intervalCountLabel').text(node._('node-red:inject.every'));
                                break;
                            case 'interval-amount':
                                $('.time-inject-row-intervalTime').show();
                                $('#node-input-intervalCountMultiplier').hide();
                                $('#node-input-intervalCountLabel').text(node._('time-inject.label.count'));
                                break;
                            case 'time':
                                $('.time-inject-row-timeOnly').show();
                                $('#node-input-intervalCountMultiplier').hide();
                                break;
                            case 'cron':
                                $('#time-inject-row-cron').show();
                                break;
                            default:
                                break;
                        }
                        $('#node-input-offset').change(); // includes time + property change
                        $('#node-input-timeEndOffset').change(); // also timeEnd change
                        $('#node-input-timeAltOffset').change(); // includes time + property change
                    });
                    // #endregion onceDelay + TimeType
                    // #region interval
                    node.intervalCountMultiplier = multiplierUpdate(node.intervalCountMultiplier, 'intervalCountMultiplier');
                    setupTInput(node, {
                        typeProp: 'intervalCountType',
                        valueProp: 'intervalCount',
                        width: 'calc(100% - 255px)',
                        defaultType: 'num',
                        defaultValue: 1,
                        types: ['num', 'env', 'flow', 'global']
                    }); // intervalCount

                    if (node.intervalStart) {
                        const d = parseDate(node.intervalStart);
                        const dateTimeLocalValue = (new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString()).slice(0, -1);
                        $('#node-myinput-intervalStart').val(dateTimeLocalValue);
                        const dMax = new Date();
                        dMax.setFullYear(dMax.getFullYear() + 1);
                        const dateTimeLocalValueMax = (new Date(dMax.getTime() - dMax.getTimezoneOffset() * 60000).toISOString()).slice(0, -1);
                        $('#node-myinput-intervalStart').attr('max',dateTimeLocalValueMax);

                    }
                    // #endregion interval
                    // #region time
                    if ($('#node-input-timeOnlyOddDays').prop('checked') && $('#node-input-timeOnlyEvenDays').prop('checked') ) {
                        $('#node-input-timeOnlyOddDays').prop('checked',false);
                        $('#node-input-timeOnlyEvenDays').prop('checked',false);
                    }
                    if ($('#node-input-timeOnlyOddWeeks').prop('checked') && $('#node-input-timeOnlyEvenWeeks').prop('checked') ) {
                        $('#node-input-timeOnlyOddWeeks').prop('checked',false);
                        $('#node-input-timeOnlyEvenWeeks').prop('checked',false);
                    }

                    setupTInput(node, {
                        typeProp: 'timeType',
                        valueProp: 'time',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onChange(_type, _value) {
                            const injectType = $('#node-input-injectTypeSelect').val();
                            // console.log('time onChange -> ' + injectType + ' / type = ' + type);
                            if (injectType === 'none' || injectType === 'interval' || injectType === 'cron') {
                                $('.time-inject-row-timeStartOffset').hide();
                                $('.time-inject-row-timeLimits').hide();
                                $('.time-inject-row-altStart').hide();
                                const $div = $('#time-inject-row-timeStart');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', titleOrg);
                                $('#node-input-property').typedInput('type',  types.Undefined.value);
                                $('#node-input-property').change();
                                return;
                            }
                            const type = $('#node-input-time').typedInput('type');
                            if (type === types.TimeSunNow.value) {
                                $('.time-inject-row-timeStartOffset').show();
                                $('.time-inject-row-timeLimits').hide();
                            } else {
                                $('.time-inject-row-timeStartOffset').show();
                                $('.time-inject-row-timeLimits').show();
                            }
                            if (injectType === 'time') {
                                $('.time-inject-row-altStart').show();
                            }
                            $('#node-input-property').change();
                            getBackendData(d => {
                                const $div = $('#time-inject-row-timeStart');
                                const $div2 = $('#time-inject-row-timeStartOffset');
                                $div.attr('title', bdDateToTime(d, ' - ') + $div.attr('titleOrg'));
                                $div2.attr('title', bdDateToTime(d, ' - ') + $div2.attr('titleOrg'));
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type,
                                value:          $('#node-input-time').typedInput('value'),
                                offsetType:     $('#node-input-offset').typedInput('type'),
                                offset:         $('#node-input-offset').typedInput('value'),
                                multiplier:     parseInt($('#node-input-offsetMultiplier').val()),
                                next:           1,
                                days:           getCheckboxesStr($('#time-inject-timeDays input[type=checkbox]:checked'), 7),
                                months:         getCheckboxesStr($('#time-inject-timeMonths input[type=checkbox]:checked'), 12),
                                onlyOddDays:    $('#node-input-timeOnlyOddDays').prop('checked'),
                                onlyEvenDays:   $('#node-input-timeOnlyEvenDays').prop('checked'),
                                onlyOddWeeks:    $('#node-input-timeOnlyOddWeeks').prop('checked'),
                                onlyEvenWeeks:   $('#node-input-timeOnlyEvenWeeks').prop('checked'),
                                noOffsetError:  true
                            });
                        }
                    }); // time
                    node.offsetMultiplier = multiplierUpdate(node.offsetMultiplier, 'offsetMultiplier', () => $('#node-input-time').change());
                    setupTInput(node, {
                        typeProp: 'offsetType',
                        valueProp: 'offset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.offset === 0 || node.offset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            const type = $('#node-input-offset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-offsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-offsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-time').change();
                        }
                    }); // offset
                    // #endregion time
                    // #region timeEnd
                    setupTInput(node, {
                        typeProp: 'timeEndType',
                        valueProp: 'timeEnd',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeMoon,
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onChange(_type, _value) {
                            const injectType = $('#node-input-injectTypeSelect').val();
                            if ((injectType !== 'interval-time') && (injectType !== 'interval-amount')) {
                                $('.time-inject-row-timeEndOffset').hide();

                                const $div = $('#time-inject-row-timeEnd');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', titleOrg);
                                return;
                            }
                            $('.time-inject-row-timeEndOffset').show();
                            getBackendData(d => {
                                const $div = $('#time-inject-row-timeEnd');
                                const $div2 = $('#time-inject-row-timeEndOffset');
                                $div.attr('title', bdDateToTime(d, ' - ') + $div.attr('titleOrg'));
                                $div2.attr('title', bdDateToTime(d, ' - ') + $div2.attr('titleOrg'));
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           $('#node-input-timeEnd').typedInput('type'),
                                value:          $('#node-input-timeEnd').typedInput('value'),
                                offsetType:     $('#node-input-timeEndOffset').typedInput('type'),
                                offset:         $('#node-input-timeEndOffset').typedInput('value'),
                                multiplier:     parseInt($('#node-input-timeEndOffsetMultiplier').val()),
                                next:           1,
                                days:           getCheckboxesStr($('#time-inject-timeDays input[type=checkbox]:checked'), 7),
                                months:         getCheckboxesStr($('#time-inject-timeMonths input[type=checkbox]:checked'), 12),
                                onlyOddDays:    $('#node-input-timeOnlyOddDays').prop('checked'),
                                onlyEvenDays:   $('#node-input-timeOnlyEvenDays').prop('checked'),
                                onlyOddWeeks:    $('#node-input-timeOnlyOddWeeks').prop('checked'),
                                onlyEvenWeeks:   $('#node-input-timeOnlyEvenWeeks').prop('checked'),
                                noOffsetError:  true
                            });
                        }
                    }); // timeEnd

                    node.timeEndOffsetMultiplier = multiplierUpdate(node.timeEndOffsetMultiplier, 'timeEndOffsetMultiplier');
                    setupTInput(node, {
                        typeProp: 'timeEndOffsetType',
                        valueProp: 'timeEndOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.timeEndOffset === 0 || node.timeEndOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            const type = $('#node-input-timeEndOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-timeEndOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-timeEndOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-timeEnd').change();
                        }
                    }); // timeEndOffset
                    // #endregion timeEnd
                    // #region time constraints
                    initCheckboxesBlock('#time-inject-timeDays', node.timeDays);
                    initCheckboxesBlock('#time-inject-timeMonths', node.timeMonths);

                    const getDateShort = value => {
                        if (value) {
                            const val = value.split('-');
                            if (val.length > 2) {
                                return val[1] + '-' + val[2];
                            } else if (val.length === 2) {
                                return val[0] + '-' + val[1];
                            }
                        }
                        return '';
                    };
                    const $timeLimitDateStart = $('#node-input-timedatestart');
                    const $timeLimitDateEnd = $('#node-input-timedateend');
                    $timeLimitDateStart.change(() => {
                        const year = (new Date()).getFullYear();
                        $timeLimitDateEnd.attr('min', year + '-' + (getDateShort($timeLimitDateStart.val() || '01-01')));
                        $timeLimitDateEnd.attr('max', (year + 1) + '-' + (getDateShort($timeLimitDateStart.val()) || '12-31'));
                    });
                    $timeLimitDateEnd.change(() => {
                        const year = (new Date()).getFullYear();
                        $timeLimitDateStart.attr('min', year + '-01-01');
                        $timeLimitDateStart.attr('max', $timeLimitDateEnd.val() || (year + '-12-31'));
                    });

                    const year = (new Date()).getFullYear();
                    if (node.timedatestart) {
                        $timeLimitDateStart.val(year + '-' +(getDateShort(node.timedatestart) || '01-01'));
                    }
                    if (node.timedatestart && node.timedateend) {
                        const year = (new Date()).getFullYear();
                        const d1 = new Date(node.timedatestart);
                        const d2 = new Date(node.timedateend);
                        d1.setFullYear(year);
                        d2.setFullYear(year);
                        if (d2.getTime() < d1.getTime()) {
                            d2.setFullYear(year + 1);
                        }
                        const pad = (n, z = 2) => ('00' + n).slice(-z);
                        $timeLimitDateEnd.val(year + '-' + pad(d2.getMonth() + 1) + '-' + pad(d2.getDate()));
                    } else if (node.timedateend) {
                        $timeLimitDateEnd.val(year + '-' + (getDateShort(node.timedateend) || '12-31'));
                    }
                    $timeLimitDateStart.change();
                    $timeLimitDateEnd.change();
                    // #endregion time constraints
                    // #region property
                    setupTInput(node, {
                        typeProp: 'propertyType',
                        valueProp: 'property',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [types.Undefined,
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.PhaseMoon,
                            types.SunInSky,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ],
                        onChange(_type, _value) {
                            const injectType = $('#node-input-injectTypeSelect').val();
                            const propType = $('#node-input-property').typedInput('type');
                            if ( injectType !== 'time' || propType === types.Undefined.value ) {
                                $('.time-inject-row-timeAlt').hide();
                                $('.time-inject-row-timeAltOffset').hide();
                                $('.time-inject-row-timeAltLimits').hide();
                                $('#node-input-propertyCompare').hide();
                                $('.row-propertyThreshold').hide();
                                $('#node-input-property').typedInput('width', 'calc(100% - 110px)');
                            } else if(propType === 'jsonata' ||
                                      propType === types.PhaseMoon.value) {
                                $('.time-inject-row-timeAlt').show();
                                $('.time-inject-row-timeAltOffset').show();
                                $('.time-inject-row-timeAltLimits').show();
                                $('#node-input-propertyCompare').show();
                                $('#node-input-propertyCompare').attr('disabled', true);
                                $('#node-input-propertyCompare').val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-propertyThreshold').hide();
                                $('#node-input-property').typedInput('width', 'calc(100% - 220px)');
                            } else {
                                $('.time-inject-row-timeAlt').show();
                                $('.time-inject-row-timeAltOffset').show();
                                $('.time-inject-row-timeAltLimits').show();
                                $('#node-input-propertyCompare').show();
                                $('#node-input-propertyCompare').attr('disabled', false);
                                $('#node-input-property').typedInput('width', 'calc(100% - 220px)');
                                const condOp = $('#node-input-propertyCompare').val();
                                let operandCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for(let index = 0; index<fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operandCount = el.operandCount;
                                        break;
                                    }
                                }

                                if (operandCount > 1) {
                                    $('.row-propertyThreshold').show(); // condOpB
                                } else {
                                    $('.row-propertyThreshold').hide(); // condOpB
                                }
                            }
                            const timeType = $('#node-input-time').typedInput('type');
                            if ( timeType === 'flow' || timeType === 'global' || propType !== types.Undefined.value ) {
                                $('.time-inject-recalc').show();
                            } else {
                                $('.time-inject-recalc').hide();
                                $('#time-inject-recalcTime').val('');
                            }
                            $('#node-input-propertyThreshold').change();
                        }
                    }); // property
                    const propertyCompareField = $('#node-input-propertyCompare');
                    appendOptions(node, propertyCompareField, 'comparator');
                    propertyCompareField.val(node.propertyCompare || 'true');
                    propertyCompareField.change(() => { $('#node-input-property').change(); });
                    setupTInput(node, {
                        typeProp: 'propertyThresholdType',
                        valueProp: 'propertyThreshold',
                        width: 'calc(100% - 130px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', 'str', 'flow', 'global', 'env']
                    });
                    // #endregion property
                    // #region timeAlt
                    if ($('#node-input-timeAltOnlyOddDays').prop('checked') && $('#node-input-timeOnlyEvenDays').prop('checked') ) {
                        $('#node-input-timeAltOnlyOddDays').prop('checked',false);
                        $('#node-input-timeAltOnlyEvenDays').prop('checked',false);
                    }
                    if ($('#node-input-timeAltOnlyOddWeeks').prop('checked') && $('#node-input-timeOnlyEvenWeeks').prop('checked') ) {
                        $('#node-input-timeAltOnlyOddWeeks').prop('checked',false);
                        $('#node-input-timeAltOnlyEvenWeeks').prop('checked',false);
                    }
                    setupTInput(node, {
                        typeProp: 'timeAltType',
                        valueProp: 'timeAlt',
                        width: 'calc(100% - 120px)',
                        defaultType: 'entered',
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet

                        ],
                        onChange (_type, _value) {
                            if (!$('.time-inject-row-timeAlt').is(':hidden')) {
                                const type = $('#node-input-timeAlt').typedInput('type');
                                if (type === types.TimeSunNow.value){
                                    $('.time-inject-row-timeAltOffset').show();
                                    $('.time-inject-row-timeAltLimits').hide();
                                } else {
                                    $('.time-inject-row-timeAltOffset').show();
                                    $('.time-inject-row-timeAltLimits').show();
                                }
                                getBackendData(d => {
                                    const $div = $('#node-input-timeAlt-div');
                                    const $div2 = $('#node-input-timeAltOffset-div');
                                    $div.attr('title', bdDateToTime(d, ' - ') + $div.attr('titleOrg'));
                                    $div2.attr('title', bdDateToTime(d, ' - ') + $div2.attr('titleOrg'));
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getTimeData',
                                    config:         $nodeConfig.val(),
                                    type,
                                    value:          $('#node-input-timeAlt').typedInput('value'),
                                    offsetType:     $('#node-input-timeAltOffset').typedInput('type'),
                                    offset:         $('#node-input-timeAltOffset').typedInput('value'),
                                    multiplier:     $('#node-input-timeAltOffsetMultiplier').val(),
                                    next:           1,
                                    days:           getCheckboxesStr($('#time-inject-timeAltDays input[type=checkbox]:checked'), 7),
                                    months:         getCheckboxesStr($('#time-inject-timeAltMonths input[type=checkbox]:checked'), 12),
                                    onlyOddDays:     $('#node-input-timeAltOnlyOddDays').val(),
                                    onlyEvenDays:    $('#node-input-timeAltOnlyEvenDays').val(),
                                    onlyOddWeeks:    $('#node-input-timeAltOnlyOddWeeks').val(),
                                    onlyEvenWeeks:   $('#node-input-timeAltOnlyEvenWeeks').val(),
                                    noOffsetError:  true
                                });
                            }
                        }
                    });

                    initCheckboxesBlock('#time-inject-timeAltDays', node.timeAltDays);
                    initCheckboxesBlock('#time-inject-timeAltMonths', node.timeAltMonths);

                    node.timeAltOffsetMultiplier = multiplierUpdate(node.timeAltOffsetMultiplier, 'timeAltOffsetMultiplier', () => $('#node-input-timeAlt').change());
                    setupTInput(node, {
                        typeProp: 'timeAltOffsetType',
                        valueProp: 'timeAltOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.timeAltOffset === 0 || node.timeAltOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            const type = $('#node-input-timeAltOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-timeAltOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-timeAltOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-timeAlt').change();
                        }
                    });
                    // #endregion timeAlt
                    // #region cron
                    setupTInput(node, {
                        typeProp: 'cronType',
                        valueProp: 'cron',
                        width: 'calc(100% - 110px)',
                        defaultType: types.cronExpr.value,
                        defaultValue: '',
                        types: [
                            types.cronExpr
                        ],
                        onChange(_type, _value) {
                            $('#node-input-time').change();
                        }
                    }); // cron
                    // # endregion cron
                    // console.log('Loading done, trigegr changes');
                    $('#node-input-injectTypeSelect').change();
                    setTimeout(() => {
                        $('.hide-after-setup-loaded').hide();
                    }, 300);
                }; // setup

                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus, _jqxhr) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }
                    })
                    .fail((jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                const node = this;
                const dvalue = $('#node-myinput-intervalStart').val();
                if (dvalue) {
                    const dIvStart = Date.parse(dvalue);
                    node.intervalStart = dIvStart.toISOString();
                } else {
                    delete node.intervalStart;
                }

                node.timeDays = getCheckboxesStr($('#time-inject-timeDays input[type=checkbox]:checked'), 7);
                node.timeAltDays = getCheckboxesStr($('#time-inject-timeAltDays input[type=checkbox]:checked'), 7);
                node.timeMonths = getCheckboxesStr($('#time-inject-timeMonths input[type=checkbox]:checked'), 12);
                node.timeAltMonths = getCheckboxesStr($('#time-inject-timeAltMonths input[type=checkbox]:checked'), 12);

                delete node.payload;
                delete node.payloadType;
                delete node.payloadTimeFormat;
                delete node.payloadOffset;
                delete node.payloadOffsetType;
                delete node.payloadOffsetMultiplier;
                delete node.topic;
                delete node.addPayload1;
                delete node.addPayload1Type;
                delete node.addPayload1Value;
                delete node.addPayload1ValueType;
                delete node.addPayload1Format;
                delete node.addPayload1Offset;
                delete node.addPayload1OffsetType;
                delete node.addPayload1OffsetMultiplier;
                delete node.addPayload1Next;
                delete node.addPayload1Days;
                delete node.addPayload2;
                delete node.addPayload2Type;
                delete node.addPayload2Value;
                delete node.addPayload2ValueType;
                delete node.addPayload2Format;
                delete node.addPayload2Offset;
                delete node.addPayload2OffsetType;
                delete node.addPayload2OffsetMultiplier;
                delete node.addPayload2Next;
                delete node.addPayload2Days;
                delete node.addPayload3;
                delete node.addPayload3Type;
                delete node.addPayload3Value;
                delete node.addPayload3ValueType;
                delete node.addPayload3Format;
                delete node.addPayload3Offset;
                delete node.addPayload3OffsetType;
                delete node.addPayload3OffsetMultiplier;
                delete node.addPayload3Next;
                delete node.addPayload3Days;

                /* Gather the properties */
                const items = $('#node-input-property-container').editableList('items');
                const propData = getProps(items, node);

                node.props = propData.props;
                node.topicLbl = propData.topicLbl;
                this.nameInt = '';
                if ($('#node-input-once').prop('checked')) {
                    this.nameInt += '¹';
                }
                const getTimeConstraints = () => {
                    let suffix = '';
                    if (this.timeDays && this.timeDays !== '*') {
                        const daysarr = this.timeDays.split(',');
                        if (daysarr.length === 1) {
                            suffix += '[' + RED._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7)) + ']';
                        } else if (this.timeDays === '5,6,0') {
                            suffix += '[';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.days.12');
                            suffix += '-';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.days.7');
                            suffix += ']';
                        } else if (daysarr.length === 2) {
                            suffix += '[';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7));
                            suffix += ',';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[1]) + 7));
                            suffix += ']';
                        } else {
                            daysarr.sort((a, b) => parseInt(a) - parseInt(b));
                            let isok = true;
                            let elF = parseInt(daysarr[0]);
                            suffix += '[';
                            daysarr[0] = RED._('node-red-contrib-sun-position/position-config:common.days.'+(elF + 7));
                            for (let index = 1; index < daysarr.length; index++) {
                                const element = parseInt(daysarr[index]);
                                isok = isok && (element === elF+1);
                                elF = element;
                                daysarr[index] = RED._('node-red-contrib-sun-position/position-config:common.days.'+(element + 7));
                            }
                            if (isok) {
                                suffix += daysarr[0];
                                suffix += '-';
                                suffix += daysarr[daysarr.length-1];
                            } else if (daysarr.length < 5) {
                                suffix += daysarr.join(',');
                            } else  {
                                suffix += this._('time-inject.label.fewDays');
                            }
                            suffix += ']';
                        }
                    }

                    if (this.timeMonths && this.timeMonths !== '*') {
                        const montharr = this.timeMonths.split(',');
                        if (montharr.length === 2) {
                            suffix += '[';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                            suffix += ',';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[1]) + 12));
                            suffix += ']';
                        } else if (montharr.length === 1) {
                            suffix += '[';
                            suffix += RED._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                            suffix += ']';
                        } else {
                            montharr.sort((a, b) => parseInt(a) - parseInt(b));
                            let isok = true;
                            let elF = parseInt(montharr[0]);
                            suffix += '[';
                            montharr[0] = RED._('node-red-contrib-sun-position/position-config:common.months.'+(elF + 12));
                            for (let index = 1; index < montharr.length; index++) {
                                const element = parseInt(montharr[index]);
                                isok = isok && (element === elF+1);
                                elF = element;
                                montharr[index] = RED._('node-red-contrib-sun-position/position-config:common.months.'+(element + 12));
                            }
                            if (isok) {
                                suffix += montharr[0];
                                suffix += '-';
                                suffix += montharr[montharr.length-1];
                            } else if (montharr.length < 5) {
                                suffix += montharr.join(',');
                            } else  {
                                suffix += this._('time-inject.label.fewMonths');
                            }

                            suffix += ']';
                        }
                    }
                    if ($('#node-input-timedatestart').val() && $('#node-input-timedateend').val()) {
                        const getDateShort = value => {
                            if (value) {
                                const val = value.split('-');
                                if (val.length > 2) {
                                    return val[1] + '-' + val[2];
                                } else if (val.length === 2) {
                                    return val[0] + '-' + val[1];
                                }
                            }
                            return '';
                        };
                        suffix += '[';
                        suffix += (getDateShort($('#node-input-timedatestart').val()) || '01-01');
                        suffix += '>';
                        suffix += (getDateShort($('#node-input-timedateend').val()) || '12-31');
                        suffix += ']';
                    }
                    return suffix;
                };

                const getTimeId = () => {
                    const part1 = RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                        $('#node-input-time').typedInput('type'),
                        $('#node-input-time').typedInput('value'),
                        $('#node-input-offset').typedInput('type'),
                        $('#node-input-offset').typedInput('value'),
                        $('#node-input-offsetMultiplier').val());
                    if ($('#node-input-property').typedInput('type') !== 'none') {
                        return (part1 + '/' + RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                            $('#node-input-timeAlt').typedInput('type'),
                            $('#node-input-timeAlt').typedInput('value'),
                            $('#node-input-timeAltOffset').typedInput('type'),
                            $('#node-input-timeAltOffset').typedInput('value'),
                            $('#node-input-timeAltOffsetMultiplier').val())) +
                                getTimeConstraints();
                    }
                    return part1 + getTimeConstraints();
                };

                const getInterval = () => {
                    let res = ' ↻';
                    if ($('#node-input-intervalCount').typedInput('type') === 'num') {
                        res += $('#node-input-intervalCount').typedInput('value');
                        const num = parseInt($('#node-input-intervalCountMultiplier').val());
                        if (num === 1) {
                            res += 'ms';
                        } else if (num === 1000) {
                            res += 's';
                        } else if (num === 60000) {
                            res += 'min';
                        } else if (num === 3600000) {
                            res += 'h';
                        } else if (num === 86400000) {
                            res += 'd';
                        } else if (num === 604800000) {
                            res += 'w';
                        }
                    }
                    return res;
                };

                if ($('#node-input-injectTypeSelect').val() === 'none' ||
                    this.timeType === 'none' ||
                    this.timeType === '') {
                    this.nameInt += propData.payloadLbl;
                } else if ($('#node-input-injectTypeSelect').val() === 'interval') {
                    this.nameInt += propData.payloadLbl;
                    this.nameInt += getInterval();
                } else if ($('#node-input-injectTypeSelect').val() === 'interval-time') {
                    this.nameInt += RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                        $('#node-input-time').typedInput('type'),
                        $('#node-input-time').typedInput('value'),
                        $('#node-input-offset').typedInput('type'),
                        $('#node-input-offset').typedInput('value'),
                        $('#node-input-offsetMultiplier').val(), 20);
                    this.nameInt += ' - ';
                    this.nameInt += RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                        $('#node-input-timeEnd').typedInput('type'),
                        $('#node-input-timeEnd').typedInput('value'),
                        $('#node-input-timeEndOffset').typedInput('type'),
                        $('#node-input-timeEndOffset').typedInput('value'),
                        $('#node-input-timeEndOffsetMultiplier').val(), 20);
                    this.nameInt += getTimeConstraints();
                    if (this.nameInt.length > 35) {
                        this.nameInt += ' =...';
                    } else {
                        this.nameInt += ' = ';
                        this.nameInt += propData.payloadLbl;
                    }
                    this.nameInt += getInterval();
                } else if ($('#node-input-injectTypeSelect').val() === 'interval-amount') {
                    this.nameInt += RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                        $('#node-input-time').typedInput('type'),
                        $('#node-input-time').typedInput('value'),
                        $('#node-input-offset').typedInput('type'),
                        $('#node-input-offset').typedInput('value'),
                        $('#node-input-offsetMultiplier').val(), 20);
                    this.nameInt += ' - ';
                    this.nameInt += RED.nodes.getType('position-config').getRDGNodeValLbl(this,
                        $('#node-input-timeEnd').typedInput('type'),
                        $('#node-input-timeEnd').typedInput('value'),
                        $('#node-input-timeEndOffset').typedInput('type'),
                        $('#node-input-timeEndOffset').typedInput('value'),
                        $('#node-input-timeEndOffsetMultiplier').val(), 20);
                    this.nameInt += getTimeConstraints();
                    if (this.nameInt.length > 35) {
                        this.nameInt += ' =...';
                    } else {
                        this.nameInt += ' = ';
                        this.nameInt += propData.payloadLbl;
                    }
                    this.nameInt += ' ↻';
                    if ($('#node-input-intervalCount').typedInput('type') === 'num') {
                        this.nameInt += $('#node-input-intervalCount').typedInput('value');
                    }
                } else if ($('#node-input-injectTypeSelect').val() === 'cron') {
                    this.nameInt += $('#node-input-cron').typedInput('value');
                    this.nameInt += ' = ';
                    this.nameInt += propData.payloadLbl;
                } else {
                    this.nameInt += '⏲ ';
                    if ($('#node-input-time').typedInput('type') === propData.payloadType) {
                        this.nameInt += '...';
                        this.nameInt += getTimeConstraints();
                        this.nameInt += ' = ';
                        this.nameInt += propData.payloadLbl;
                    } else {
                        const timeText = getTimeId();
                        if (timeText.length > 26) {
                            this.nameInt += timeText + ' =...';
                        } else {
                            this.nameInt += timeText;
                            this.nameInt += ' = ';
                            this.nameInt += propData.payloadLbl;
                        }
                    }
                }
            },
            oneditresize(_size) {
                try {
                    const editorRow = $('.node-input-property-container-row ol');
                    const height = editorRow.outerHeight(true);
                    const rowCount = $('#node-input-property-container').editableList('length');
                    if (rowCount > 0) {
                        $('#node-input-property-container').editableList('height', height + 40);
                    } else {
                        $('#node-input-property-container').editableList('height', 20);
                    }
                } catch (err) {
                    console.debug(err); // eslint-disable-line no-console
                }
            },
            button: {
                enabled: function() { // eslint-disable-line object-shorthand
                    return !this.changed;
                },
                onclick: function() { // eslint-disable-line object-shorthand
                    if (this.changed) {
                        return RED.notify(RED._('node-red:notification.warning', { message: RED._('node-red:notification.warnings.undeployedChanges') }), 'warning');
                    }
                    doInject(this);
                    return undefined;
                }
            }
        });
    })();</script>

<script type="text/html" data-template-name="time-inject">
    <div class="form-row block-noindent is-to-show-initial">
        <span><i class="fa fa-info-circle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.infoText" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row block-noindent is-to-show-initial hide-after-setup-loaded">
        <span><i class="fa fa-exclamation-triangle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.loadingInfo" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <div class="form-row" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row node-input-property-container-row is-to-show-normally">
        <ol id="node-input-property-container"></ol>
    </div>
    <div class="form-row is-to-show-normally" id="node-once" data-i18n="[title]time-inject.placeholder.once">
        <label for="node-input-once"><i class="fa fa-play-circle"></i> <span data-i18n="time-inject.label.once"></span></label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="time-inject.label.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:65px; height:28px;">&nbsp;
        <span data-i18n="time-inject.label.onceDelay"></span>
    </div>
    <div class="form-row block-noindent is-to-show-normally">
        <label for=""><i class="fa fa-repeat"></i> <span data-i18n="node-red:inject.label.repeat"></span></label>
        <select id="node-input-injectTypeSelect" class="node-input-injectTypeSelect row-full-width">
            <option value="none" data-i18n="node-red:inject.none"></option>
            <option value="interval" data-i18n="node-red:inject.interval"></option>
            <option value="interval-time" data-i18n="node-red:inject.interval-time"></option>
            <option value="interval-amount" data-i18n="time-inject.label.interval-amount"></option>
            <option value="time" data-i18n="node-red:inject.time"></option>
            <option value="cron" data-i18n="time-inject.label.cron"></option>
        </select>
    </div>
    <div class="form-row time-inject-row-all block-noindent time-inject-row-interval time-inject-row-intervalFromStart time-inject-row-intervalTime is-initial-hidden" id="time-inject-row-interval">
        <label for="node-input-intervalCount"><i class="fa fa-hourglass"></i> <span id="node-input-intervalCountLabel" data-i18n="node-red:inject.every"></span></label>
        <input id="node-input-intervalCount" class="time-inject-intervalCount" data-i18n="[placeholder]time-inject.placeholder.intervalCount"/>
        <input type="hidden" id="node-input-intervalCountType">
        <select id="node-input-intervalCountMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-all block-noindent time-inject-row-intervalFromStart is-initial-hidden" id="time-inject-row-interval-start">
        <label for="node-myinput-intervalStart"><i class="fa fa-fa-hourglass-start"></i> <span id="node-myinput-intervalStartLabel" data-i18n="time-inject.label.intervalStart"></span></label>
        <input type="datetime-local" id="node-myinput-intervalStart" class="time-inject-intervalStart" data-i18n="[placeholder]time-inject.placeholder.intervalStart"/>
    </div>

    <div class="form-row time-inject-row-all time-inject-row-intervalTime is-initial-hidden ">
        <span data-i18n="node-red-contrib-sun-position/position-config:common.label.between"></span>
    </div>
    <div class="form-row time-inject-row-all block-noindent time-inject-row-cron is-initial-hidden" id="time-inject-row-cron"  data-i18n="[titleOrg]time-inject.placeholder.cron">
        <label for="node-input-cron"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.cron"></span></label>
        <input type="text" id="node-input-cron" />
        <input type="hidden" id="node-input-cronType">
    </div>
    <div class="form-row time-inject-row-all block-noindent time-inject-row-timeStart time-inject-row-intervalTime time-inject-row-timeOnly is-initial-hidden" id="time-inject-row-timeStart"  data-i18n="[titleOrg]time-inject.placeholder.time">
        <label for="node-input-time"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.time"></span></label>
        <input type="text" id="node-input-time" />
        <input type="hidden" id="node-input-timeType">
    </div>
    <div class="form-row time-inject-row-all block-indent1 time-inject-row-timeStartOffset is-initial-hidden"  id="time-inject-row-timeStartOffset" data-i18n="[titleOrg]time-inject.placeholder.timeOffset">
        <label for="node-input-offset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.timeOffset"></span></label>
        <input id="node-input-offset" data-i18n="[placeholder]time-inject.placeholder.timeOffset"/>
        <input type="hidden" id="node-input-offsetType">
        <select id="node-input-offsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-all time-inject-row-intervalTime is-initial-hidden">
        <span data-i18n="node-red-contrib-sun-position/position-config:common.label.and"></span>
    </div>
    <div class="form-row time-inject-row-all block-noindent time-inject-row-intervalTime is-initial-hidden" id="time-inject-row-timeEnd"  data-i18n="[titleOrg]time-inject.placeholder.timeEnd">
        <label for="node-input-timeEnd"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.timeEnd"></span></label>
        <input type="text" id="node-input-timeEnd" />
        <input type="hidden" id="node-input-timeEndType">
    </div>
    <div class="form-row time-inject-row-all block-indent1 time-inject-row-timeEndOffset is-initial-hidden" id="time-inject-row-timeEndOffset" data-i18n="[title]time-inject.placeholder.timeOffset">
        <label for="node-input-timeEndOffset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.timeEndOffset"></span></label>
        <input id="node-input-timeEndOffset" data-i18n="[placeholder]time-inject.placeholder.timeEndOffset"/>
        <input type="hidden" id="node-input-timeEndOffsetType">
        <select id="node-input-timeEndOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-all time-inject-row-timeLimits is-initial-hidden" data-i18n="[title]time-inject.placeholder.timeLimits">
        <div id="time-inject-timeDays" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDays"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                </div>
            </div>
        </div>
        <div class="time-inject-limits" style="margin-top:5px-; border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.specialLimits"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' id="node-input-timeOnlyEvenDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeOnlyOddDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeOnlyEvenWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks"></span></label>
                    <label><input type='checkbox'  id="node-input-timeOnlyOddWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks"></span></label>
                </div>
            </div>
        </div>
        <div id="time-inject-timeMonths" class="time-inject-months" style="margin-top:5px; border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForMonths"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                </div>
            </div>
        </div>
        <div id="time-inject-timeDateLimit" class="time-inject-datelimit" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;"><i class="fa fa-calendar-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDates"></span></div>
            <div style="display:inline-block;">
                <input type="date" id="node-input-timedatestart" class="ipMain time-inject-timedatelimit" value="" data-i18n="[placeholder]time-inject.placeholder.start" min="2000-01-01" max="2000-12-31">
                <input type="date" id="node-input-timedateend" class="ipMain time-inject-timedatelimit" value="" data-i18n="[placeholder]time-inject.placeholder.end" min="2000-01-01" max="2000-12-31">
            </div>
        </div>
    </div>
    <hr class="time-inject-row-all block-noindent time-inject-row-altStart is-initial-hidden">
    <div class="form-row time-inject-row-all time-inject-row-altStart is-initial-hidden time-inject-row-timeOnly" data-i18n="[title]time-inject.placeholder.property">
        <label for="node-input-property"><i class="fa fa-sun-o"></i> <span data-i18n="time-inject.label.property"></span></label>
        <input type="text" id="node-input-property" data-i18n="[placeholder]time-inject.placeholder.property"/>
        <input type="hidden" id="node-input-propertyType">
        <select id="node-input-propertyCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row time-inject-row-all block-indent2 row-propertyThreshold is-initial-hidden" data-i18n="[title]time-inject.placeholder.propertyThreshold">
        <label for="node-input-propertyThreshold"><i class="fa fa-compress"></i> <span data-i18n="time-inject.label.propertyThreshold"></span></label>
        <input type="text" id="node-input-propertyThreshold" data-i18n="[placeholder]time-inject.placeholder.propertyThreshold">
        <input type="hidden" id="node-input-propertyThresholdType">
    </div>
    <div class="form-row block-indent1 time-inject-row-timeAlt is-initial-hidden" id="node-input-timeAlt-div" data-i18n="[titleOrg]time-inject.placeholder.timeAlt">
        <label for="node-input-timeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.timeAlt"></span></label>
        <input type="text" id="node-input-timeAlt" data-i18n="[placeholder]time-inject.placeholder.timeAlt"/>
        <input type="hidden" id="node-input-timeAltType">
    </div>
    <div class="form-row time-inject-row-all block-indent1 time-inject-row-timeAltOffset is-initial-hidden" id="node-input-timeAltOffset-div" data-i18n="[titleOrg]time-inject.placeholder.timeAltOffset">
        <label for="node-input-timeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.timeAltOffset"></span></label>
        <input id="node-input-timeAltOffset" data-i18n="[placeholder]time-inject.placeholder.timeAltOffset"/>
        <input type="hidden" id="node-input-timeAltOffsetType">
        <select id="node-input-timeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-all form-tips time-inject-row-altStart is-initial-hidden">
        <span data-i18n="[html]time-inject.tips.addTimes"></span>&nbsp;
    </div>
    <div class="form-row time-inject-row-all time-inject-row-timeAltLimits is-initial-hidden" data-i18n="[title]time-inject.placeholder.timeLimits">
        <div id="time-inject-timeAltDays" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDays"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                </div>
            </div>
        </div>
        <div class="time-inject-limits" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.specialLimits"></div>
            <div style="display:inline-block">
                <div>
                    <label><input type='checkbox' id="node-input-timeAltOnlyEvenDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeAltOnlyOddDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeAltOnlyEvenWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks"></span></label>
                    <label><input type='checkbox' id="node-input-timeAltOnlyOddWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks"></span></label>
                </div>
            </div>
        </div>
        <div id="time-inject-timeAltMonths" class="time-inject-months" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForMonths"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                </div>
            </div>
        </div>
    </div>
    <hr class="time-inject-recalc is-initial-hidden">
    <div class="form-row time-inject-recalc is-initial-hidden" data-i18n="[title]time-inject.placeholder.recalcTime">
        <label for="node-input-recalcTime"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.recalcTime"></span></label>
        <input type="text" id="node-input-recalcTime" placeholder="2" style="width:65px; height:28px;">&nbsp;
        <span data-i18n="time-inject.label.hours"></span>
    </div>
    <div class="form-tips time-inject-recalc is-initial-hidden" data-i18n="[html]time-inject.tips.recalc"></div>
    <div class="form-tips is-to-show-initial">
        <span data-i18n="[html]time-inject.tips.documentation" style="word-wrap:break-word;"></span>
    </div>
</script>
<style>
    hr {
        width: 100%
    }
    .is-to-show-initial {
        display:none
    }
    .is-initial-hidden {
        display:none
    }
    .is-to-show-normally {
        display:none
    }
    .form-tips {
        width: 90%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .time-inject-row-timeLimits,
    .time-inject-row-timeAltLimits,
    .time-inject-row-addPayload1days,
    .time-inject-row-addPayload2days,
    .time-inject-row-addPayload3days {
        padding-left: 110px;
    }
    .time-inject-row-timeLimits input,
    .time-inject-row-timeAltLimits input,
    .time-inject-row-addPayload1days input,
    .time-inject-row-addPayload2days input,
    .time-inject-row-addPayload3days input {
        width: auto !important;
    }
    .time-inject-row-timeLimits select,
    .time-inject-row-timeAltLimits select,
    .time-inject-row-addPayload1days select,
    .time-inject-row-addPayload2days select,
    .time-inject-row-addPayload2days select {
        margin: 3px 0;
    }
    .time-inject-days label,
    .time-inject-months label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        max-width: 55px;
        width: 100px;
    }
    .time-inject-days input {
        width: auto;
        vertical-align: baseline;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
</style>