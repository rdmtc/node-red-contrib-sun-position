<!DOCTYPE HTML>
<!--
This code is licensed under the Apache License Version 2.0.

Copyright (c) 2022 Robert Gester

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

-->

<script type="text/javascript">
    /* eslint-env browser es6 */
    // Isolate this code
    (function() {
        'use strict';
        /// <reference path="./types/typedefs.js" />
        /// <reference lib="./static/htmlglobal.js" />

        /** --- Type Defs ---
         * @typedef {import("node-red").Red} Red
         */

        const cNBC_RULE_EXEC = {
            auto: 0,
            first:1,
            last:2
        };
        const cNBC_RULE_TYPE_UNTIL = 0;
        const cNBC_RULE_TYPE_FROM = 1;

        /** @type {Red} */
        // @ts-ignore
        RED.nodes.registerType('clock-timer', {
            category: 'time and astro',
            color: '#FFCC66',
            icon: 'clock-timer-white.svg',
            inputs: 1,
            outputs: 2,
            defaults: {
                name: {
                    value: '',
                    required: false
                },
                topic: {
                    value: '',
                    required: false
                },
                addIdType: {
                    value: 'none'
                },
                addId: {
                    value: '',
                    // @ts-ignore
                    validate: RED.validators.typedInput('addIdType')
                },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                autoTrigger: { value: true },
                autoTriggerTime: {
                    value: 1200000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                        // @ts-ignore
                               (RED.validators.number()(v) &&
                               (n >= 60000) && (n < 0x7FFFFFFF));
                    }
                },
                startDelayTime: {
                    value: 10000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                        // @ts-ignore
                               (RED.validators.number()(v) &&
                               (n >= 0) && (n < 0x7FFFFFFF));
                    },
                    required: false
                },
                contextStore: {value: ''},
                results: {
                    value: [
                        {
                            p: '',
                            pt: 'msgTopic',
                            v: '',
                            vt: 'topic'
                        },
                        {
                            p: '',
                            pt: 'msgPayload',
                            v: '',
                            vt: 'payload'
                        },
                        {
                            p: 'timeCtrl',
                            pt: 'msg',
                            v: '',
                            vt: 'ctrlObj'
                        }
                    ]
                },
                // #region overwrite settings
                overwriteExpire: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (v === '') ||
                               // @ts-ignore
                               (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }
                },
                // #endregion overwrite settings
                // #region rule settings
                rules: {
                    value: {}
                },
                payloadDefault: {
                    value: '',
                    // @ts-ignore
                    validate: RED.validators.typedInput('payloadDefaultType')
                },
                payloadDefaultType: {
                    value: 'none'
                },
                payloadDefaultTimeFormat: {
                    value: 0
                },
                payloadDefaultOffset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.payloadOffsetType === 'undefined') ||
                            // @ts-ignore
                            RED.validators.typedInput('payloadOffsetType')(v)
                        );
                    }
                },
                payloadDefaultOffsetType: {
                    value: 'none'
                },
                payloadDefaultOffsetMultiplier: {
                    value: 60000,
                    // @ts-ignore
                    validate : RED.validators.number()
                }
                // #endregion time settings
            },
            outputLabels(index) {
                if (index > 0) {
                    return this._('clock-timer.label.output' + (index + 1));
                }
                const types = {
                    msgPayload : 'msg.payload',
                    msgTopic   : 'msg.topic',
                    msgValue   : 'msg.value'
                };
                const labels = {
                    payload: 'the payload',
                    topic: 'topic',
                    ctrlObj: 'status object',
                    str: 'string',
                    num: 'number',
                    bool: 'boolean',
                    flow: 'flow context',
                    global: 'global context',
                    bin: 'binary data',
                    date: 'timestamp',
                    dateSpecific: 'special timestamp',
                    entered: 'timestamp',
                    dateEntered: 'timestamp',
                    env: 'Environment variable',
                    jsonata: 'result of jsonata expression',
                    nodeId: 'additional node ID',
                    nodeName: this.name,
                    nodePath: this._path || this.name
                };

                // if only payload and topic - display payload type
                // if only one property - show it's type
                // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
                // this.results will not be an array for legacy inject nodes until they are re-deployed
                //
                let results = this.results;
                if (!results || !Array.isArray(results)) {
                    results = [
                        {
                            p: '',
                            pt: 'msgTopic',
                            v: '',
                            vt: 'topic'
                        },
                        {
                            p: '',
                            pt: 'msgPayload',
                            v: '',
                            vt: 'payload'
                        },
                        {
                            p: 'timeCtrl',
                            pt: 'msg',
                            v: '',
                            vt: 'ctrlObj'
                        }];
                }
                let lab = '';
                if (results) {
                    let cnt = -1;
                    for (let i=0, l=results.length; i<l; i++) {
                        if (!results[i].pt.includes('msg')) { continue; }
                        cnt++;
                        if (cnt > 0) lab += '\n';
                        if (cnt === 5) {
                            lab += ' + ' + (results.length - 4);
                            break;
                        }
                        lab += (types[results[i].pt] ? types[results[i].pt] : (results[i].pt + '.' + results[i].p)) + ': ';
                        let propType = labels[results[i].vt] ? labels[results[i].vt] : results[i].vt;
                        if (propType === 'json' || propType === 'object') {
                            try {
                                const parsedProp = JSON.parse(results[i].v);
                                propType = typeof parsedProp;
                                if (propType === 'object' && Array.isArray(parsedProp)) {
                                    propType = 'Array';
                                }
                            } catch (ex) {
                                propType = 'invalid';
                            }
                        }
                        lab += propType;
                    }
                }
                return lab || '?';
            },
            label() {
                if (this.name) {
                    return this.name;
                }
                const result = this._('clock-timer.label.clock-timer');
                if (this.topic && (this.topic.length + result.length <= 32)) {
                    return this.topic + ':' + result;
                }
                return result;
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            paletteLabel() { return this._('clock-timer.label.clock-timer-palette'); },
            oneditprepare() {
                // @ts-check
                /** resizes a rule container */
                function resizeRuleContainer() {
                    try {
                        const editorRow = $('.node-input-rule-container-row ol');
                        const height = editorRow.outerHeight(true);
                        const rowCount = $('#node-input-rule-container').editableList('length');
                        if (rowCount > 0) {
                            // $('#node-input-rule-container').editableList('height', height + 40);
                            $('#node-input-rule-container').css('min-height', height + 'px');
                        } else {
                            // $('#node-input-rule-container').editableList('height', 40);
                            $('#node-input-rule-container').css('min-height', '40px');
                        }
                    } catch (ex) {
                        console.log(ex); // eslint-disable-line
                    }
                }

                /** resizes the rule container */
                function resizeRuleContainerCheck(node) {
                    if (node.dialogAddData.resizeRuleContainerTO) { clearTimeout(node.dialogAddData.resizeRuleContainerTO); }
                    node.dialogAddData.resizeRuleContainerTO = setTimeout(() => {
                        delete node.dialogAddData.resizeRuleContainerTO;
                        resizeRuleContainer();
                    }, 600);
                }

                setTimeout(() => {
                    $('.is-to-show-initially').show();
                    $('.is-to-hide-initially').hide();
                }, 300);
                $('.rdg-ui-btn').button();

                const $nodeConfig = $('#node-input-positionConfig');
                const node = this;

                const $nodeInputContextStore = $('#node-input-contextStore');
                // @ts-ignore
                RED.settings.context.stores.forEach(store => {
                    $nodeInputContextStore.append('<option value="' + store + '"' + (this.contextStore === store ? ' selected' : '') + '>' + store + '</option>');
                });

                // @ts-ignore
                const tabs = RED.tabs.create({
                    id: 'node-config-clock-timer-tabs',
                    onchange(tab) {
                        $('#node-config-clock-timer-tabs-content').children().hide();
                        $('#' + tab.id).show();
                        resizeRuleContainerCheck(node);
                    },
                    scrollable: true,
                    collapsible: true
                });

                node.dialogAddData = { time:{ start:{ min:{}, max:{} }, end:{ min:{}, max:{} } }, timeReg:{} };
                const setup = function(node) {
                    /* global getTypes getSelectFields setupTInput appendOptions getBackendData bdDateToTime initCombobox initCheckboxesBlock autocomplete getCheckboxesStr setTInputValue */
                    // #region initialize
                    const types = /** @type {Object} */ getTypes(node, () => $nodeConfig.val());
                    types.OutputPayload = {
                        value: 'payload',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.payload'),
                        hasValue: false
                    };
                    types.OutputTopic = {
                        value: 'topic',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.topic'),
                        hasValue: false
                    };
                    types.OutputCtrlObj = {
                        value: 'ctrlObj',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.ctrlObj'),
                        hasValue: false
                    };
                    types.OutputCtrlObj = {
                        value: 'ctrlObj',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.ctrlObj'),
                        hasValue: false
                    };
                    types.OutputCtrlObj = {
                        value: 'ctrlObj',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.ctrlObj'),
                        hasValue: false
                    };
                    types.UndefinedTimeFrom = Object.assign({}, types.Undefined, {
                        label: node._('node-red-contrib-sun-position/position-config:common.types.undefinedTimeFrom')
                    });
                    types.UndefinedTimeUntil = Object.assign({}, types.Undefined, {
                        label: node._('node-red-contrib-sun-position/position-config:common.types.undefinedTimeUntil')
                    });

                    const selFields = getSelectFields();
                    /**
                    * update multiplier settings from a previous version
                    * @param {number} mp - the multiplier value
                    * @param {string} name - the name of the element
                    * @param {function} onchange - the function to be called on field change
                    * @returns {number} the updated multiplier value
                    */
                    function multiplierUpdate(mp, name, onchange) {
                        const $field = $('#node-input-' + name);
                        appendOptions(node, $field, 'multiplier', data => (data.id > 0));
                        if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                            mp = 60000;
                        } else {
                            mp = parseFloat(mp);
                            if (mp === 1) {
                                mp = 1000;
                            } else if (mp === 60) {
                                mp = 60000;
                            } else if (mp === 3600) {
                                mp = 3600000;
                            }
                        }
                        $field.val(mp);
                        $field.on('change', onchange);
                        return mp;
                    }
                    /**
                     * save rules
                     * @param {*} node - the node representation
                     * @param {string} name - the node representation
                     * @param {*} element - the node representation
                     * @param {function} validate - ovalidation function of the input
                     * @param {number} defMultiplier - default multiplier (in ms)
                     * @param {number} minMultiplier - minimum multiplier (in ms)
                    */
                    function setMultiplier(node, name, element, validate, defMultiplier, minMultiplier) {
                        const c = Number(node[name]);
                        if (node[name] !== '' && !isNaN(c) && c !== 0) {
                            let r = minMultiplier || 1000;
                            if (c % 86400000 === 0) {
                                r = 86400000; // Days
                            } else if (c % 3600000 === 0) {
                                r = 3600000; // Hours
                            } else if (c % 60000 === 0) {
                                r = 60000; // Minutes
                            }
                            $('#time-control-' + name).val(c/r);
                            $('#time-control-' + name + '-multiplier').val(r);
                        } else {
                            $('#time-control-' + name).val('');
                            $('#time-control-' + name + '-multiplier').val(defMultiplier || 1000);
                        }
                        $('#time-control-' + name).on('change focus focusout', () => {
                            const el = $('#time-control-' + name);
                            let val = el.val();
                            const mp = $('#time-control-' + name + '-multiplier').val();
                            if (isNaN(val) || val === '' || val === 0) {
                                val = '';
                                $('node-input-' + name).val('');
                            } else {
                                val = val * mp;
                                $('#node-input-' + name).val(val);
                            }

                            if (typeof validate === 'function') {
                                if (validate(val)) {
                                    el.removeClass( 'input-error' );
                                } else {
                                    el.addClass( 'input-error' );
                                }
                            }
                        });

                        $('#time-control-' + name + '-multiplier').change( () => {
                            $('#time-control-' + name).change();
                        });
                        $('#time-control-' + name).change();
                    }
                    // #endregion initialize
                    // #region payloadDefault
                    // console.log('clock-timer payloadDefault');
                    if (node.payloadDefaultType === null) {
                        node.payloadDefaultType = types.Undefined.value;
                    } else if (node.payloadDefaultType === 'string') {
                        node.payloadDefaultType = 'str';
                    }
                    setupTInput(node, {
                        typeProp: 'payloadDefaultType',
                        valueProp: 'payloadDefault',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [
                            types.Undefined,
                            'str',
                            'num',
                            'bool',
                            'date',
                            types.DateSpecific,
                            types.MsgPayload,
                            types.MsgValue,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.randomNumber,
                            types.TimeEntered,
                            types.DateEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            types.DayOfMonth,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationObj,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ],
                        onChange(_type, _value) {
                            const plVType = $('#node-input-payloadDefault').typedInput('type');
                            if (plVType ===  types.TimeEntered.value ||
                                plVType === types.TimeSun.value ||
                                plVType === types.TimeSunCustom.value ||
                                plVType === types.TimeMoon.value ||
                                plVType === types.DateSpecific.value) {
                                $('.rdgtimer-rule-row-payloadDefaultTimeFormat').show();
                                $('.rdgtimer-rule-row-payloadDefaultOffset').show();
                            } else if (plVType ===  types.TimeSunNow.value) {
                                $('.rdgtimer-rule-row-payloadDefaultTimeFormat').hide();
                                $('.rdgtimer-rule-row-payloadDefaultOffset').show();
                            } else {
                                $('.rdgtimer-rule-row-payloadDefaultTimeFormat').hide();
                                $('.rdgtimer-rule-row-payloadDefaultOffset').hide();
                            }
                            getBackendData(d => {
                                const $div = $('#node-input-payloadDefault-div');
                                const titleOrg = $div.attr('titleOrg');
                                // $div.attr('title', ((d) ? (String(d) + ' - ') : '') + titleOrg);
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:     node.id,
                                kind:       'getOutDataData',
                                config:     $nodeConfig.val(),
                                type:       plVType,
                                value:      $('#node-input-payloadDefault').typedInput('value'),
                                format:     $('#node-input-payloadDefaultTimeFormat').val(),
                                offsetType: $('#node-input-payloadDefaultOffset').typedInput('type'),
                                offset:     $('#node-input-payloadDefaultOffset').typedInput('value'),
                                multiplier: $('#node-input-payloadDefaultOffsetMultiplier').val(),
                                noOffsetError: true
                            });
                        }
                    });
                    initCombobox(node, $('#node-input-payloadDefaultTimeFormatsel'), $('#node-input-payloadDefaultTimeFormat'), 'dateOutFormat', 'outputFormats', node.payloadDefaultTimeFormat || 0, 30);

                    node.payloadDefaultOffsetMultiplier = multiplierUpdate(node.payloadDefaultOffsetMultiplier, 'payloadDefaultOffsetMultiplier', () => $('#node-input-payloadDefault').change());
                    setupTInput(node, {
                        typeProp: 'payloadDefaultOffsetType',
                        valueProp: 'payloadDefaultOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.payloadDefaultOffset === 0 || node.payloadDefaultOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            const type = $('#node-input-payloadDefaultOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-payloadDefaultOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-payloadDefaultOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-payloadDefault').change();
                        }
                    });

                    setupTInput(node, {
                        typeProp: 'addIdType',
                        valueProp: 'addId',
                        width: 'calc(100% - 110px)',
                        defaultType: node.addIdType || (node.addId ? 'str' : types.Undefined.value),
                        defaultValue: '',
                        types: [types.Undefined, 'str', 'flow', 'global', 'env'] // types.MsgPayload, types.MsgTopic, types.MsgPayloadByTopic, types.MsgValue, 'msg',
                    });
                    // #endregion payloadDefault
                    // #region rules
                    const ruleVersion = 4;
                    /**
                     * get a time in millisecond as string of the format hh:mm, hh:mm:ss or hh:mm:ss.mss
                     * @param {number} s - milisecond
                     * @returns {string} time as string
                     */
                    function msToTime(s) {
                        // Pad to 2 or 3 digits, default is 2
                        const pad = (n, z = 2) => ('00' + n).slice(-z);
                        const sec = (s%6e4)/1000|0;
                        const msec = s%1000;
                        return pad(s/3.6e6|0) + ':' + pad((s%3.6e6)/6e4 | 0) + ((msec >0) ? (':' + pad(sec) +'.' + pad(msec, 3) ) : ((sec>0) ? ':' + pad(sec) : ''));
                    }

                    /**
                     * get the time offset text
                     */
                    function _getOffsetText(node, t,v,m) {
                        let result = '';
                        if (t && t !== 'none') {
                            if (t === 'num') {
                                const osmillis = v * m;
                                if (osmillis>0) {
                                    result += ' + ' + msToTime(osmillis);
                                } else {
                                    result += ' - ' +msToTime(osmillis * -1);
                                }
                            } else {
                                result += ' offset <var>' + RED.nodes.getType('position-config').getRDGNodeValLbl(node, t, v) + '</var>';
                                // result += ' * ' + data.multiplier/1000 + 's';
                            }
                        }
                        return result;
                    }
                    /**
                     * get a formated date limit
                    */
                    function getDateShort(value) {
                        if (value) {
                            const val = value.split('-');
                            if (val.length > 2) {
                                return val[1] + '-' + val[2];
                            } else if (val.length === 2) {
                                return val[0] + '-' + val[1];
                            }
                        }
                        return '';
                    }
                    /**
                     * sets a property of an object
                     * @param {object} obj - object to set property
                     * @param {string|array} arr - property of object to set 'sub1.sub2.propA' or ['sub1', 'sub2', 'propA']
                     * @param {*} val - value to set
                     * @returns {object} description of the rule
                     */
                    function addProps(obj, arr, val) {
                        if (typeof arr === 'string')
                            arr = arr.split('.');
                        obj[arr[0]] = obj[arr[0]] || {};
                        const tmpObj = obj[arr[0]];
                        if (arr.length > 1) {
                            arr.shift();
                            addProps(tmpObj, arr, val); // eslint-disable-line no-unused-vars
                        } else {
                            obj[arr[0]] = val;
                        }
                        return obj;
                    }
                    /**
                     * get number of operand for a comparision opeator
                     * @param {object} selFields - fields object
                     * @param {string} operator - value of comperator selection
                     * @returns {number} description of the rule
                     */
                    function getOperandCount(selFields, operator) {
                        operator = operator || selFields.comparator[0].id;
                        const fields = selFields.comparator;
                        const fieldsLength = fields.length;
                        for (let index = 0; index < fieldsLength; index++) {
                            const el = fields[index];
                            if (el.id === operator) {
                                return el.operandCount;
                            }
                        }
                        return 1;
                    }
                    /**
                     * get a description of the rule rules
                     * @param {object} data - a rule description
                     * @returns {string} description of the rule
                     */
                    function getRuleDescription(node, selFields, data, enh) {
                        let result = '';
                        const length = (enh) ? 60 : 30;
                        try {
                            if (typeof data.isValid === 'undefined' || typeof data.version === 'undefined' || (!data.isValid && !data.validationError && typeof data.validation === 'undefined')) {
                                result += '<div>';
                                result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.outDated');
                                result += '</div>';
                            } else if (!data.isValid) {
                                result += '<div>';
                                result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.isInValid');
                                result += '</div><div>';
                                result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleInValidText');
                                result += data.validationError;
                                result += '</div>';
                                if (data.validation && Object.keys(data.validation).length > 0) {
                                    const lines = JSON.stringify(data.validation,
                                        (key, value) => {
                                            if (value === true || (Array.isArray(value) && value.length === 0) || (typeof value === 'object' && Object.keys(value).length === 0))
                                                return undefined;
                                            if (value === false)
                                                return node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleInValidElement');
                                            return value;
                                        }, '\t').split('\n');
                                    lines.splice(0,1); // remove first line
                                    lines.pop(); // remove last line
                                    result += '<div><pre>';
                                    result += lines.join('\n');
                                    result += '</pre></div>';
                                }
                            }
                            if (data.conditions && data.conditions.length > 0) {
                                result += '<div>';
                                result += '<i class="fa fa-code-fork" aria-hidden="true"></i> ';
                                const l = data.conditions.length-1;
                                const addBrac = l > 1;

                                for (let i = 0; i <= l; i++) {
                                    const cond = data.conditions[i];
                                    if (i > 0) {
                                        result += '&nbsp;<strong>' + cond.conditionText + '</strong><br/><span class="indent-enh-text" >&nbsp;</span>';
                                    }
                                    if (addBrac && i > 0 && i < l) {
                                        result += '(&nbsp;';
                                    }
                                    if (cond.valueType === 'pdmPhaseCheck') {
                                        result += 'Moon phase is <var>' + cond.value + '</var>';
                                    } else {
                                        result += '<var>' + RED.nodes.getType('position-config').getRDGNodeValLbl(node, cond.valueType, cond.value, null, null, null, length) + '</var>';
                                        result += ' ' + cond.operatorText;
                                        const oc = getOperandCount(selFields, cond.operator);
                                        if (oc > 1) {
                                            const ttext = RED.nodes.getType('position-config').getRDGNodeValLbl(node, cond.thresholdType, cond.threshold, null, null, null, length);
                                            result += ' ';
                                            result += ttext;
                                            if (enh && enh.cond && enh.cond[i] && enh.cond[i].operand) {
                                                result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.cond[i].operand + '</code>';
                                                result += ' ' + cond.operatorText + '&nbsp;<code>';
                                                if(enh.cond[i].threshold) {
                                                    result += enh.cond[i].threshold;
                                                } else {
                                                    result += ttext;
                                                }
                                                result += '</code>]</span>';
                                            }
                                        } else if (enh && enh.cond && enh.cond[i] && enh.cond[i].operand) {
                                            result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;is&nbsp;<code>' + enh.cond[i].operand + '</code>]</span>';
                                        }
                                    }
                                }
                                if (addBrac) {
                                    result += '&nbsp;';
                                    result += Array(l).join(')');
                                }
                                result += '</div>';
                            }
                            if (data.time) {
                                const gettime = (ttype, text) => {
                                    if (data.time[ttype] && data.time[ttype].type && data.timeType !== 'none') {
                                        result += '<div>';
                                        result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
                                        result += text;
                                        result += ' <var>' + RED.nodes.getType('position-config').getRDGNodeValLbl(node, data.time[ttype].type, data.time[ttype].value, null, null, null, length) + '</var>';
                                        result += _getOffsetText(node, data.time[ttype].offsetType, data.time[ttype].offset, data.time[ttype].multiplier);
                                        if (enh && enh.timeReg && enh.timeReg.text) {
                                            result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.timeReg.text + '</code>]</span>';
                                        }

                                        if (data.time[ttype].min && data.time[ttype].min.type && data.time[ttype].min.type !== 'none') {
                                            result += '<div class="indent-time-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                                            result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMin_'+ttype);
                                            result += '</span> <var>';
                                            result += RED.nodes.getType('position-config').getRDGNodeValLbl(node, data.time[ttype].min.type, data.time[ttype].min.value, null, null, null, length);
                                            result += '</var>';
                                            result += _getOffsetText(node, data.time[ttype].min.offsetType, data.time[ttype].min.offset, data.time[ttype].min.multiplier);
                                            if (enh && enh.time[ttype].min && enh.time[ttype].min.text) {
                                                result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.time[ttype].min.text + '</code>]</span>';
                                            }
                                            result += '</div>';
                                        }
                                        if (data.time[ttype].max && data.time[ttype].max.type && data.time[ttype].max.type !== 'none') {
                                            result += '<div class="indent-time-text"><i class="fa fa-step-forward" aria-hidden="true"></i> <span>';
                                            result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMax_'+ttype);
                                            result += '</span> <var>';
                                            result += RED.nodes.getType('position-config').getRDGNodeValLbl(node, data.time[ttype].max.type, data.time[ttype].max.value, null, null, null, length);
                                            result += '</var>';
                                            result += _getOffsetText(node, data.time[ttype].max.offsetType, data.time[ttype].max.offset, data.time[ttype].max.multiplier);
                                            if (enh && enh.time[ttype].max && enh.time[ttype].max.text) {
                                                result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.time[ttype].max.text + '</code>]</span>';
                                            }
                                            result += '</div>';
                                        }
                                        result += '</div>';
                                    }
                                };
                                gettime('start',node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeStart'));
                                gettime('end',node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeEnd'));
                                result += '<div>';
                                if (data.time.days && data.time.days !== '*') {
                                    result += '<div class="indent-time-days"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeDays');
                                    result += '</span> <var>';
                                    const daysarr = data.time.days.split(',');
                                    if (daysarr.length === 1) {
                                        result += (node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7)));
                                    } else if (data.time.days === '5,6,0') {
                                        result += node._('node-red-contrib-sun-position/position-config:common.days.12');
                                        result += '-';
                                        result += node._('node-red-contrib-sun-position/position-config:common.days.7');
                                    } else if (daysarr.length === 2) {
                                        result += node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7));
                                        result += ' ';
                                        result += node._('node-red-contrib-sun-position/position-config:common.label.and');
                                        result += ' ';
                                        result += node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[1]) + 7));
                                    } else {
                                        daysarr.sort((a, b) => parseInt(a) - parseInt(b));
                                        let isok = true;
                                        let elF = parseInt(daysarr[0]);
                                        daysarr[0] = node._('node-red-contrib-sun-position/position-config:common.days.'+(elF + 7));
                                        for (let index = 1; index < daysarr.length; index++) {
                                            const element = parseInt(daysarr[index]);
                                            isok = isok && (element === elF+1);
                                            elF = element;
                                            daysarr[index] = node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(element) + 7));
                                        }
                                        if (isok) {
                                            result += (daysarr[0] + '-' + daysarr[daysarr.length-1]);
                                        } else {
                                            result += (daysarr.join(','));
                                        }
                                    }
                                    result += '</var></div>';
                                }
                                if (data.time.onlyEvenDays || data.time.onlyOddDays || data.time.onlyEvenWeeks || data.time.onlyOddWeeks) {
                                    result += '<div class="indent-time-special"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimit');
                                    result += '</span> <var>';
                                    const resultArr = [];
                                    if (data.time.onlyEvenDays) {
                                        resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenDays'));
                                    }
                                    if (data.time.onlyOddDays) {
                                        resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddDays'));
                                    }
                                    if (data.time.onlyEvenWeeks) {
                                        resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks'));
                                    }
                                    if (data.time.onlyOddWeeks) {
                                        resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks'));
                                    }
                                    result += resultArr.join(' <b>' + node._('node-red-contrib-sun-position/position-config:common.label.and') + '</b> ');
                                    result += '</var></div>';
                                }
                                if (data.time.months && data.time.months !== '*') {
                                    result += '<div class="indent-time-months"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMonths');
                                    result += '</span> <var>';
                                    const montharr = data.time.months.split(',');
                                    if (montharr.length === 2) {
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                        result += ' ';
                                        result += node._('node-red-contrib-sun-position/position-config:common.label.and');
                                        result += ' ';
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[1]) + 12));
                                    } else if (montharr.length === 1) {
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                    } else {
                                        montharr.sort((a, b) => parseInt(a) - parseInt(b));
                                        let isok = true;
                                        let elF = parseInt(montharr[0]);
                                        montharr[0] = node._('node-red-contrib-sun-position/position-config:common.months.'+(elF + 12));
                                        for (let index = 1; index < montharr.length; index++) {
                                            const element = parseInt(montharr[index]);
                                            isok = isok && (element === elF+1);
                                            elF = element;
                                            montharr[index] = node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(element) + 12));
                                        }
                                        if (isok) {
                                            result += montharr[0];
                                            result += '-';
                                            result += montharr[montharr.length-1];
                                        } else {
                                            result += montharr.join(',');
                                        }
                                    }
                                    result += '</var></div>';
                                }
                                if (data.time.dateStart || data.time.dateEnd) {
                                    result += '<div class="indent-time-datelimit"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimitStart');
                                    result += '</span> <var>';
                                    if (enh) {
                                        const year = (new Date()).getFullYear();
                                        result += data.time.dateStart || year + '-01-01';
                                    } else {
                                        result += (getDateShort(data.time.dateStart) || '01-01');
                                    }
                                    result += '</var> <span> ';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimitEnd');
                                    result += '</span> <var>';
                                    if (enh) {
                                        const year = (new Date()).getFullYear();
                                        result += data.time.dateEnd || year + '-12-31';
                                    } else {
                                        result += (getDateShort(data.time.dateEnd) || '12-31');
                                    }
                                    result += '</var></div>';
                                }
                                result += '</div>';
                            }
                            result += '<div>';
                            if (data.payload) {
                                if (data.payload.type && data.payload.type !== 'none') {
                                    result += '<div class="indent-payload-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.rulePayload');
                                    result += '</span> <var>';
                                    result += RED.nodes.getType('position-config').getRDGNodeValLbl(node, data.payload.type, data.payload.value, null, null, null, length);
                                    result += '</var>';
                                    result += _getOffsetText(node, data.payload.offsetType, data.payload.offset, data.payload.multiplier);
                                    result += '</div>';
                                    if (data.topic) {
                                        result += '<div class="indent-topic-text"> <i class="fa fa-tasks" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTopic');
                                        result += ': </span> <var>';
                                        result += data.topic;
                                        result += '</var>';
                                        result += '</div>';
                                    }
                                    if (data.resetOverwrite) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-thumbs-o-down" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleResetOverwrite');
                                        result += '</span> </div>';
                                    }
                                    if (data.importance > 0) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-hand-spock-o" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance');
                                        result += ' = </span><var>';
                                        result += data.importance;
                                        result += '</var></div>';
                                    }
                                } else {
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.rulePayloadND');
                                }
                            }
                            result += '</div>';
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            result = 'Error: "' + err.message + '"';
                        }
                        return result;
                    }

                    $('#node-input-rule-container').css('min-height', '40px').css('min-width', '300px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            if (data === {}) {
                                data.description = 'please edit rule';
                                data.name = 'empty';
                                data.exec = cNBC_RULE_EXEC.auto;
                                data.version = ruleVersion;
                                data.enabled = true;
                            }
                            data.index = containerIndex;
                            data.importance = 0;
                            if (!data.conditions) {
                                data.conditions = [];
                                if (data.validOperandAType && data.validOperandAType !== types.Unlimited.value) {
                                    data.conditions.push({
                                        condition       : 1,        // condition
                                        conditionText   : '',
                                        valueType       : data.validOperandAType,
                                        value           : data.validOperandAValue,
                                        operator        : data.validOperator || selFields.comparator[0].id,
                                        operatorText    : data.validOperatorText,
                                        thresholdType   : (data.validOperandBType || 'num'),
                                        threshold       : data.validOperandBValue
                                    });
                                    if ((parseInt(data.valid2LogOperator) > 0) && data.valid2OperandAType) {
                                        data.conditions.push({
                                            condition       : (parseInt(data.valid2LogOperator) || 1), // condition
                                            conditionText   : data.valid2LogOperatorText,
                                            valueType       : (data.valid2OperandAType || 'msg'),
                                            value           : data.valid2OperandAValue,
                                            operator        : data.valid2Operator || selFields.comparator[0].id,
                                            operatorText    : data.valid2OperatorText,
                                            thresholdType   : (data.valid2OperandBType || 'num'),
                                            threshold       : data.valid2OperandBValue
                                        });
                                    }
                                }
                                delete data.validOperandAValue;
                                delete data.validOperandAType;
                                delete data.validOperator;
                                delete data.validOperatorText;
                                delete data.validOperandBValue;
                                delete data.validOperandBType;
                                delete data.valid2LogOperator;
                                delete data.valid2LogOperatorText;
                                delete data.valid2OperandAValue;
                                delete data.valid2OperandAType;
                                delete data.valid2Operator;
                                delete data.valid2OperatorText;
                                delete data.valid2OperandBValue;
                                delete data.valid2OperandBType;
                            }
                            if (data.timeBType) {
                                if (data.timeBType === types.TimeSun.value ||
                                    data.timeBType === types.TimeSunCustom.value ||
                                    data.timeBType === types.TimeMoon.value) {
                                    data.timeMinType = data.timeType;
                                    data.timeMinValue = data.timeValue;
                                    data.timeType = data.timeBType;
                                    data.timeValue = data.timeBValue;
                                } else {
                                    data.timeMinType = data.timeBType;
                                    data.timeMinValue = data.timeBValue;
                                }
                                delete data.timeBType;
                                delete data.timeBValue;
                                delete data.timeBOp;
                                delete data.timeBOpText;
                                delete data.isValid; // need retrigger of validation, because rule is outdated
                                data.description = node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleIsOutdated');
                            }
                            if (data.timeMinType) {
                                if (!data.timeMin && data.timeMinType !== types.Undefined.value) {
                                    data.timeMin = Object.assign({
                                        type            : data.timeMinType,
                                        value           : (data.timeMinValue || ''),
                                        offsetType      : (data.offsetMinType || types.Undefined.value),
                                        offset          : (data.offsetMinValue || '1'),
                                        multiplier      : (parseInt(data.multiplierMin) || 60000)
                                    }, data.timeMin);
                                }
                                delete data.timeMinType;
                                delete data.timeMinValue;
                                delete data.offsetMinType;
                                delete data.offsetMinValue;
                                delete data.multiplierMin;
                                delete data.timeMinOp;
                            }
                            if (data.timeMaxType) {
                                if (!data.timeMax && data.timeMaxType !== types.Undefined.value) {
                                    data.timeMax = Object.assign({
                                        type            : data.timeMaxType,
                                        value           : (data.timeMaxValue || ''),
                                        offsetType      : (data.offsetMaxType || types.Undefined.value),
                                        offset          : (data.offsetMaxValue || '1'),
                                        multiplier      : (parseInt(data.multiplierMax) || 60000)
                                    }, data.timeMax);
                                }
                                delete data.timeMaxType;
                                delete data.timeMaxValue;
                                delete data.offsetMaxType;
                                delete data.offsetMaxValue;
                                delete data.multiplierMax;
                                delete data.timeMaxOp;
                            }
                            if (data.timeType) {
                                if (!data.time && data.timeType !== types.Undefined.value) {
                                    const operator = (parseInt(data.timeOp) || cNBC_RULE_TYPE_UNTIL);
                                    data.time = { };
                                    let ttype = 'end'; // cNBC_RULE_TYPE_UNTIL
                                    data.exec = cNBC_RULE_EXEC.auto;
                                    if (operator === cNBC_RULE_TYPE_FROM) {
                                        data.time.start = {};
                                        ttype = 'start';
                                    }
                                    data.time[ttype] = {
                                        type            : data.timeType,
                                        value           : (data.timeValue || ''),
                                        offsetType      : (data.offsetType || 'none'),
                                        offset          : (data.offsetValue || 1),
                                        multiplier      : (parseInt(data.multiplier) || 60000)
                                    };

                                    if (data.timeMinType && data.timeMinType !== 'none') {
                                        data.time[ttype].min = {
                                            type            : data.timeMinType,
                                            value           : (data.timeMinValue || ''),
                                            offsetType      : (data.offsetMinType || 'none'),
                                            offset          : (data.offsetMinValue || 1),
                                            multiplier      : (parseInt(data.multiplierMin) || 60000)
                                        };
                                    }
                                    if (data.timeMin) {
                                        data.time[ttype].min = {
                                            type            : data.timeMin.type,
                                            value           : data.timeMin.value,
                                            offsetType      : data.timeMin.offsetType,
                                            offset          : data.timeMin.offset,
                                            multiplier      : data.timeMin.multiplier
                                        };
                                        delete data.timeMin;
                                    }
                                    if (data.timeMaxType && data.timeMaxType !== 'none') {
                                        data.time[ttype].max = {
                                            type            : data.timeMaxType,
                                            value           : (data.timeMaxValue || ''),
                                            offsetType      : (data.offsetMaxType || 'none'),
                                            offset          : (data.offsetMaxValue || 1),
                                            multiplier      : (parseInt(data.multiplierMax) || 60000)
                                        };
                                    }
                                    if (data.timeMax) {
                                        data.time[ttype].max = {
                                            type            : data.timeMax.type,
                                            value           : data.timeMax.value,
                                            offsetType      : data.timeMax.offsetType,
                                            offset          : data.timeMax.offset,
                                            multiplier      : data.timeMax.multiplier
                                        };
                                        delete data.timeMax;
                                    }
                                    if (data.timeDays && data.timeDays !== '*') data.time.days = data.timeDays;
                                    if (data.timeMonths && data.timeMonths !== '*') data.time.months = data.timeMonths;
                                    if (data.timeOnlyOddDays) data.time.onlyOddDays = data.timeOnlyOddDays;
                                    if (data.timeOnlyEvenDays) data.time.onlyEvenDays = data.timeOnlyEvenDays;
                                    if (data.timeDateStart) data.time.dateStart = data.timeDateStart;
                                    if (data.timeDateEnd) data.time.dateEnd = data.timeDateEnd;
                                }
                                delete data.timeType;
                                delete data.timeValue;
                                delete data.timeOp;
                                delete data.timeOpText;
                                delete data.offsetType;
                                delete data.offsetValue;
                                delete data.multiplier;
                                delete data.timeDays;
                                delete data.timeMonths;
                                delete data.timeOnlyOddDays;
                                delete data.timeOnlyEvenDays;
                                delete data.timeDateStart;
                                delete data.timeDateEnd;
                                if (data.time && data.time.onlyEvenDays && data.time.onlyOddDays) {
                                    delete data.time.onlyEvenDays;
                                    delete data.time.onlyOddDays;
                                }
                            }
                            if (data.time && (typeof data.time.operator !== 'undefined')) {
                                let ttype = 'end'; // cNBC_RULE_TYPE_UNTIL
                                data.exec = cNBC_RULE_EXEC.auto;
                                if (data.time.operator === cNBC_RULE_TYPE_FROM) {
                                    ttype = 'start';
                                }
                                data.time[ttype] = Object.assign({
                                    type            : data.time.type,
                                    value           : data.time.value,
                                    offsetType      : data.time.offsetType,
                                    offset          : data.time.offset,
                                    multiplier      : data.time.multiplier
                                }, data.time[ttype]);
                                if (data.timeMin && data.timeMin.type !== 'none' ) {
                                    data.time[ttype].min = Object.assign({
                                        type            : data.timeMin.type,
                                        value           : (data.timeMin.value || ''),
                                        offsetType      : (data.timeMin.offsetType || 'none'),
                                        offset          : (data.timeMin.offset || 1),
                                        multiplier      : (parseInt(data.timeMin.multiplier) || 60000)
                                    }, data.time[ttype].min);
                                }
                                if (data.timeMax && data.timeMax.type !== 'none' ) {
                                    data.time[ttype].max = Object.assign({
                                        type            : data.timeMax.type,
                                        value           : (data.timeMax.value || ''),
                                        offsetType      : (data.timeMax.offsetType || 'none'),
                                        offset          : (data.timeMax.offset || 1),
                                        multiplier      : (parseInt(data.timeMax.multiplier) || 60000)
                                    }, data.time[ttype].max);
                                }
                                delete data.time.operator;
                                delete data.time.operatorText;
                                delete data.time.type;
                                delete data.time.value;
                                delete data.time.offsetType;
                                delete data.time.offset;
                                delete data.time.multiplier;
                                delete data.timeMin;
                                delete data.timeMax;
                            }
                            if (data.payloadType) {
                                if (!data.payload && data.payloadType !== types.Undefined.value) {
                                    data.payload = {
                                        type            : data.payloadType,
                                        value           : (data.payloadValue || ''),
                                        offsetType      : (data.payloadOffsetType || types.Undefined.value),
                                        offset          : (data.payloadOffsetValue || '1'),
                                        multiplier      : (parseInt(data.payloadOffsetMultiplier) || 60000),
                                        format          : (parseInt(data.payloadFormat) || 99)
                                    };
                                }
                                delete data.payloadType;
                                delete data.payloadValue;
                                delete data.payloadOffsetType;
                                delete data.payloadOffsetValue;
                                delete data.payloadOffsetMultiplier;
                                delete data.payloadFormat;
                            } else if (!data.payload) {
                                data.payload = {
                                    type            : types.Undefined.value,
                                    value           : '',
                                    offsetType      : types.Undefined.value,
                                    offset          : '1',
                                    multiplier      : 60000,
                                    format          : 99
                                };
                            }
                            if (!data.description || !data.version || data.version !== ruleVersion) {
                                data.description = getRuleDescription(node, selFields, data);
                                data.version = ruleVersion;
                            }
                            if (typeof data.exec === 'undefined') {
                                data.exec = cNBC_RULE_EXEC.auto;
                            }
                            $containerRow.data('ruleData', JSON.stringify(data));
                            $containerRow.css({ overflow: 'hidden'}); // , whiteSpace: 'nowrap'

                            const $row0 = $('<div/>', {
                                class: 'rdgtimer-rule-row'
                            }).appendTo($containerRow);
                            const $div = $('<div/>', {
                                class: 'rdgtimer-rule-mainblock'
                            }).appendTo($row0);

                            $('<span />', {
                                id: 'rule-name-'+containerIndex,
                                class: 'rdgtimer-rule-name-span'
                            }).append(data.name || 'rule ' + (containerIndex + 1)).appendTo( $div );
                            let exec = data.exec;
                            if (data.time) {
                                exec = cNBC_RULE_EXEC.first;
                                if (data.exec === cNBC_RULE_EXEC.last || (data.time.start && !data.time.end)) {
                                    exec = cNBC_RULE_EXEC.last;
                                }
                            }
                            $('<span />', {
                                id: 'rule-exec-'+containerIndex,
                                class: 'rdgtimer-rule-exec-span'
                            }).append(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleExecShort.'+exec)).appendTo( $div );
                            $('<div />', {
                                id: 'rule-description-'+containerIndex,
                                class: 'rdgtimer-rule-description-span'
                            }).append(data.description).appendTo( $div );
                            const finalspan1 = $('<span/>',{
                                class:'rdgtimer-rule-finalspan'
                            }).appendTo($row0);
                            finalspan1.append('<span class="node-input-rule-index">'+(containerIndex+1)+'</span> ');

                            const $ctrldiv = $('<div />', {
                                class:'rdgtimer-rule-ctrl-div'
                            }).appendTo( $row0 );
                            const $btnEdit = $('<a />', {
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-editBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.editRule')
                            }).append('<i class= "fa fa-pencil-square-o" ></i>').appendTo($ctrldiv);
                            const $btnCpy = $('<a />', {
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-duplicateBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.duplicateRule')
                            }).append('<i class= "fa fa-clone" ></i>').appendTo($ctrldiv);
                            const $btnState = $('<a />', {
                                id: 'rule-btn-state-'+containerIndex,
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-stateBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleState')
                            }).append('<i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i>').appendTo($ctrldiv);

                            $btnEdit.click(() => {
                                _dialogLoadData(containerIndex, $containerRow);
                            });
                            $btnCpy.click(() => {
                                _dialogDuplicateRule(containerIndex, $containerRow);
                            });
                            $btnState.click(() => {
                                const data = JSON.parse($containerRow.data('ruleData'));
                                data.enabled = (data.enabled === false || data.enabled === 'false');
                                $containerRow.data('ruleData', JSON.stringify(data));
                                $btnState.trigger('setRuleEnabledState');
                            });
                            $btnState.bind('setRuleEnabledState',() => {
                                const data = JSON.parse($containerRow.data('ruleData'));
                                const en = !(data.enabled === false || data.enabled === 'false');
                                $row0.toggleClass('rule-disabled', !en );
                                if (en) {
                                    $btnState.find('.fa-circle-thin').show();
                                    $btnState.find('.fa-ban').hide();
                                } else {
                                    $btnState.find('.fa-circle-thin').hide();
                                    $btnState.find('.fa-ban').show();
                                }
                            });
                            $btnState.trigger('setRuleEnabledState');
                            resizeRuleContainerCheck(node);
                        },
                        addButton: false,
                        sortable: true,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem(_opt) {
                            $('#node-input-rule-container').editableList('items').each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                            resizeRuleContainerCheck(node);
                        },
                        sortItems(rules) {
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                        }
                    });

                    // #region Button
                    const $btnAdd = $('#node-button-add');
                    $btnAdd.click(() => {
                        $('#node-input-rule-container').editableList('addItem', {});
                        resizeRuleContainerCheck(node);
                    });

                    const $btnClear = $('#node-button-clear');
                    $btnClear.click(() => {
                        $('#node-input-rule-container').editableList('empty');
                        resizeRuleContainerCheck(node);
                    });

                    const $btnSort = $('#node-button-sort');
                    $btnSort.click(() => {
                        $('#node-input-rule-container').editableList('items').each(function(i) {
                            const data = $(this).data('data');
                            data.index = i;
                            // data.conditional = ((data.conditions.length > 0) ? 1 : 0);
                            // data.timeLimited = ((data.time && data.time.type !== 'none') ? 1 : 0);
                            // TODO: node-input-rule-timeReg does not exists
                            // WARNING: node-input-rule-timeReg does not exists
                            data.timeData = (parseFloat($(this).find('.node-input-rule-timeReg').attr('timedata')) || 0);
                        });
                        /**
                         * 1 no time
                         * 2 time    - until
                         * 3 time    - from
                         */
                        $('#node-input-rule-container').editableList('sort', (a, b) => {
                            const pos = (a.index - b.index);
                            if (!a.time && !b.time) { // both not time limited
                                return pos;
                            }
                            // both are time limited
                            const atimeop = (a.time) ? (Number(a.time.operator) || 0) : -1;
                            const btimeop = (b.time) ? (Number(b.time.operator) || 0) : -1;
                            const top = (atimeop - btimeop);
                            if (top !== 0) {
                                return top; // from before until; not timeLimited before timeLimited (1-3)
                            }

                            const time = a.timeData - b.timeData;
                            if ((a.timeData !== 0) && (b.timeData !== 0) && (time !== 0)) { // time is different
                                return time;
                            }
                            return pos;
                        });
                        $('#node-input-rule-container').editableList('items').each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                    });

                    const $btnExport = $('#node-button-export');
                    $btnExport.click(() => {
                        const rules = [];
                        $('#node-input-rule-container').editableList('items').each(function (_i) {
                            const rule = $(this);
                            const data = JSON.parse(rule.data('ruleData'));
                            delete data.description; // will causte trouble
                            data.index = _i;
                            rules.push(data);
                        });
                        console.log('export to clipboard', rules); // eslint-disable-line no-console
                        navigator.clipboard.writeText(JSON.stringify(rules, null, '\t'));
                    });

                    const $btnImport = $('#node-button-import');
                    $btnImport.click(() => {
                        navigator.clipboard.readText().then(
                            clipText => {
                                try {
                                    const rules = JSON.parse(clipText);
                                    console.log('import from clipboard', rules); // eslint-disable-line no-console
                                    if (Array.isArray(rules)) {
                                        for (let i = 0; i < rules.length; i++) {
                                            const rule = rules[i];
                                            if (typeof rule.name === 'string' &&
                                                rule.version) {
                                                $('#node-input-rule-container').editableList('addItem', rule);
                                            }
                                        }
                                    }
                                    resizeRuleContainerCheck(node);
                                } catch (err) {
                                    console.log(err.message); // eslint-disable-line no-console
                                    console.log(err.stack); // eslint-disable-line no-console
                                    alert(`Clipboard Data has wrong Format! (${err.message})`);
                                }
                            });
                    });
                    // #endregion Button
                    // fill rules
                    if (node.rules) {
                        $('#node-input-rule-container').editableList('empty');
                        for (let i = 0; i < node.rules.length; i++) {
                            const rule = node.rules[i];
                            // rule.index = i;
                            $('#node-input-rule-container').editableList('addItem', rule);
                        }
                        resizeRuleContainerCheck(node);
                    }
                    // #endregion rules
                    // #region result-container
                    /** resizes result container */
                    function resizeResultContainer() {
                        const editorRow = $('.node-input-result-container-row ol');
                        const height = editorRow.outerHeight(true);
                        const rowCount = $('#node-input-result-container').editableList('length');
                        if (rowCount > 0) {
                            $('#node-input-result-container').css('min-height', height + 'px');
                        } else {
                            $('#node-input-result-container').css('min-height', '20px');
                        }
                    }

                    $('#node-input-result-container').css('min-height', '40px').css('min-width', '400px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            $containerRow.css({ overflow: 'hidden', whiteSpace: 'nowrap' });
                            const $row1 = $('<div/>').appendTo($containerRow);
                            // row1 - Property / Type Selection
                            let prop = data;
                            if (!Object.prototype.hasOwnProperty.call(prop, 'p')) {
                                prop = {
                                    p: '',
                                    pt: types.MsgPayload.value,
                                    v: '',
                                    vt: types.OutputPayload.value
                                };
                            }
                            if (prop.p === 'payload' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgPayload.value;
                            } else if (prop.p === 'topic' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgTopic.value;
                            } else if (prop.p === 'value' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgValue.value;
                            }
                            const $propertyName = $('<input/>', {
                                class: 'node-input-prop-result-name',
                                type: 'text'
                            })
                                .css('width', '40%')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        types.MsgPayload,
                                        types.MsgTopic,
                                        types.MsgValue,
                                        types.MsgTs,
                                        types.MsgLc,
                                        'msg',
                                        'flow',
                                        'global'
                                    ]
                                });
                            setTInputValue($propertyName, prop.p, prop.pt);

                            $('<div/>', { style: 'display:inline-block; padding:0px 6px;' })
                                .text('=')
                                .appendTo($row1);
                            const $propertyValue = $('<input/>', {
                                class: 'node-input-prop-result-value',
                                type: 'text'
                            })
                                .css('width', 'calc(60% - 30px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.OutputPayload.value,
                                    types: [
                                        types.OutputPayload,
                                        types.OutputTopic,
                                        types.OutputCtrlObj,
                                        'date',
                                        'str',
                                        types.strPlaceholder,
                                        'num',
                                        'bool',
                                        'json',
                                        'bin',
                                        'env',
                                        'msg',
                                        'flow',
                                        'global',
                                        'jsonata',
                                        types.randomNumber,
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek,
                                        types.nodeId,
                                        types.nodeName,
                                        types.nodePath
                                    ]
                                });
                            setTInputValue($propertyValue, prop.v, prop.vt);

                            // changes
                            $propertyValue.change(() => {
                                // $operand.show();
                                // const plNType = $propertyName.typedInput('type');
                                const plVType = $propertyValue.typedInput('type');
                                const plVValue = $propertyValue.typedInput('value');
                                if (plVValue === types.OutputPayload.value ||
                                    plVValue === types.OutputTopic.value ||
                                    plVValue === types.OutputCtrlObj.value) {
                                    $containerRow.attr('title', $('#node-input-input').attr('title'));
                                } else {
                                    getBackendData(d => {
                                        $containerRow.attr('title', bdDateToTime(d));
                                    }, {
                                        nodeId:         node.id,
                                        kind:           'getOutDataData',
                                        config:         $nodeConfig.val(),
                                        type:           plVType,
                                        value:          plVValue
                                    });
                                }
                                resizeResultContainer();
                            });
                            $propertyValue.change();
                            resizeResultContainer();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                $(this).find('.node-input-rule-index').html(i + 1);
                            });
                        },
                        // resizeItem: resizeRule,
                        sortable: true,
                        removable: true,
                        removeItem: resizeResultContainer
                    });

                    if (!node.results) {
                        node.results = [
                            {
                                p: '',
                                pt: 'msgTopic',
                                v: '',
                                vt: 'topic'
                            },
                            {
                                p: '',
                                pt: 'msgPayload',
                                v: '',
                                vt: 'payload'
                            },
                            {
                                p: 'timeCtrl',
                                pt: 'msg',
                                v: '',
                                vt: types.OutputCtrlObj.value
                            }
                        ];
                    }
                    for (let i = 0; i < node.results.length; i++) {
                        const res = node.results[i];
                        $('#node-input-result-container').editableList('addItem', res);
                    }
                    // #endregion result-container
                    // #region Enhanced settings
                    setMultiplier(node,'overwriteExpire', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }, 3600000, 1000);
                    setMultiplier(node,'autoTriggerTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 60000) && (n < 0x7FFFFFFF));
                    }, 3600000, 60000);
                    setMultiplier(node,'startDelayTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 0) && (n < 0x7FFFFFFF));
                    }, 600000, 0);
                    $('.spinner-time').spinner({
                        max: 1439,
                        min: 0,
                        step: 1
                    });
                    $('#node-input-autoTrigger').change( () => {
                        if ($('#node-input-autoTrigger').is(':checked')) {
                            $('#time-control-autoTriggerTime-edit').show();
                        } else {
                            $('#time-control-autoTriggerTime-edit').hide();
                        }
                    });
                    $('#node-input-autoTrigger').change();
                    // #endregion Enhanced settings
                    // #region dialog
                    const $dialog = $('#dialog-edit-rule').dialog({
                        title: node._('clock-timer.label.dialogtitle'),
                        autoOpen: false,
                        resizable: true,
                        height: Math.min(750, $(window).height() * 0.9), // 1024
                        width: Math.min(850, $(window).width() * 0.9),
                        modal: false, // allow to use JSON and JSONATA editor
                        closeOnEscape: true,
                        classes : {
                            'ui-dialog': 'ui-dialog-rdg ',
                            'ui-dialog-content': 'ui-dialog-content-rdg ',
                            'ui-dialog-titlebar': 'ui-dialog-titlebar-rdg'
                        },
                        buttons: [
                            {
                                text: 'state',
                                'class': 'dialog-stateBtn',
                                'id': 'dlg-ip-btctl-rule-state',
                                click() {
                                    const $btn = $('#dialog-edit-rule').parent().find('#dlg-ip-btctl-rule-state');
                                    const state = !($btn.attr('is_enabled') === false || $btn.attr('is_enabled') === 'false');
                                    $btn.attr('is_enabled', !state);
                                    $btn.trigger('setRuleEnabledState');
                                }
                            },
                            {
                                text: node._('node-red-contrib-sun-position/position-config:common.label.ok'),
                                icons: { primary: 'ui-icon-check' },
                                click() {
                                    _dialogSaveData();
                                    $dialog.dialog( 'close' );
                                    $dialogDataRow = null;
                                    dialogDataIndex = -1;
                                }
                            },
                            {
                                text: node._('node-red-contrib-sun-position/position-config:common.label.cancel'),
                                icons: { primary: 'ui-icon-closethick' },
                                click() {
                                    $dialog.dialog( 'close' );
                                    $dialogDataRow = null;
                                    dialogDataIndex = -1;
                                }
                            }
                        ],
                        dialogClass: 'overflow-fix',
                        close() {
                            $dialog.dialog( 'close' );
                            $dialogDataRow = null;
                            dialogDataIndex = -1;
                        }
                    });

                    const $dialogName = $dialog.find('#dlg-ip-btctl-rule-name');

                    const $dialogExec = $dialog.find('#dlg-ip-btctl-rule-exec');
                    $dialogExec.append($('<option></option>').val(cNBC_RULE_EXEC.auto).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleExecAuto')));
                    $dialogExec.append($('<option></option>').val(cNBC_RULE_EXEC.first).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleExecFirst')));
                    $dialogExec.append($('<option></option>').val(cNBC_RULE_EXEC.last).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleExecLast')));

                    let $dialogDataRow = null;
                    let dialogDataOnLoading = false;
                    let dialogDataIndex = -1;
                    const $dialogRuleEnableBtn = $dialog.parent().find('#dlg-ip-btctl-rule-state');
                    $dialogRuleEnableBtn.append('<i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i>');
                    $dialogRuleEnableBtn.bind('setRuleEnabledState',() => {
                        const state = !($dialogRuleEnableBtn.attr('is_enabled') === false || $dialogRuleEnableBtn.attr('is_enabled') === 'false');
                        $dialog.toggleClass('rule-disabled', state );
                        if (state) {
                            $dialogRuleEnableBtn.text(' '+node._('node-red-contrib-sun-position/position-config:common.label.enabled'));
                            $dialogRuleEnableBtn.prepend('<i class="fa fa-circle-thin"></i>');
                        } else {
                            $dialogRuleEnableBtn.text(' '+node._('node-red-contrib-sun-position/position-config:common.label.disabled'));
                            $dialogRuleEnableBtn.prepend('<i class="fa fa-ban"></i>');
                        }
                    });
                    // #region dialogConditions
                    const $dialogConditionContainer = $dialog.find('#dlg-ip-btctl-rule-condition-container');
                    /** resizes a rule container */
                    function resizeConditionContainer() {
                        const editorRow = $('.dlg-ip-btctl-rule-condition-container-row ol');
                        const height =  editorRow.outerHeight(true);
                        const rowCount = $('#node-input-rule-container').editableList('length');
                        if (rowCount > 0) {
                            $dialogConditionContainer.editableList('height', height + 30);
                        } else {
                            $dialogConditionContainer.editableList('height', 0);
                        }
                    }

                    $dialogConditionContainer.css('min-width', '400px').editableList({
                        addItem(containerRow, containerIndex, data) {
                            if (!Object.prototype.hasOwnProperty.call(data, 'value')) {
                                data = {
                                    condition       : 1,        // condition
                                    valueType       : 'msg',    // operand type
                                    value           : '',       // operand
                                    operator        : 'gte',    // operator
                                    operatorText    : '>=',
                                    thresholdType   : 'num',    // threshold type
                                    threshold       : ''        // threshold
                                };
                            }

                            containerRow.css({overflow: 'hidden', whiteSpace: 'nowrap'});
                            const $row1 = $('<div/>').appendTo(containerRow);
                            const $row2 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            // row1 - index + logOperator + condOperand
                            $('<input/>',{
                                type: 'hidden',
                                id:'dlg-ip-btctl-rule-condIndex' + containerIndex,
                                class:'dlg-ip-btctl-rule-condIndex',
                                value:(containerIndex+1)
                            }).appendTo($row1);

                            const $dialogCondLogOperator = $('<select/>', {
                                class: 'dlg-ip-btctl-rule-condLogOperator',
                                id: 'dlg-ip-btctl-rule-condLogOperator' + containerIndex
                            })
                                .css('width', '90px')
                                .css('margin-bottom', '0px')
                                .appendTo($row1);
                            $dialogCondLogOperator.append($('<option></option>').val(1).text(node._('node-red-contrib-sun-position/position-config:common.label.or')));
                            $dialogCondLogOperator.append($('<option></option>').val(2).text(node._('node-red-contrib-sun-position/position-config:common.label.and')));
                            $dialogCondLogOperator.val(data.condition || 1);

                            const $dialogCondOperand = $('<input/>', {
                                class: 'dlg-ip-btctl-rule-condOperand',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 95px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        types.Unlimited,
                                        'msg',
                                        'flow',
                                        'global',
                                        'env',
                                        'jsonata',
                                        types.PhaseMoon,
                                        types.MsgPayload,
                                        types.MsgValue,
                                        types.MsgPayloadByTopic,
                                        types.SunInSky,
                                        types.SunAzimuth,
                                        types.SunElevation,
                                        types.isDST,
                                        types.WeekOfYear,
                                        types.WeekOfYearEven,
                                        types.DayOfYear,
                                        types.DayOfYearEven,
                                        types.nodeId,
                                        types.nodeName,
                                        types.nodePath
                                    ]
                                });
                            setTInputValue($dialogCondOperand, data.value, data.valueType);

                            // row2 - compare + Thersold
                            const $dialogCondOperator = $('<select/>', {
                                class: 'dlg-ip-btctl-rule-condOperator',
                                id: 'dlg-ip-btctl-rule-condOperator' + containerIndex
                            })
                                .css('width', '140px')
                                .css('margin-bottom', '0px')
                                .appendTo($row2);
                            appendOptions(node, $dialogCondOperator, 'comparator');
                            $dialogCondOperator.val(data.operator || 'gte');

                            const $dialogCondThreshold = $('<input/>', {
                                class: 'dlg-ip-btctl-rule-condThreshold',
                                id: 'dlg-ip-btctl-rule-condThreshold' + containerIndex,
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 145px)')
                                .appendTo($row2)
                                .typedInput({
                                    default: 'num',
                                    types: [
                                        'num',
                                        types.numAzimuth,
                                        types.numAltitude,
                                        types.numAnglePreDef,
                                        'str',
                                        'bool',
                                        'flow',
                                        'global',
                                        'env',
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek
                                    ]
                                });
                            setTInputValue($dialogCondThreshold, data.threshold, data.thresholdType);
                            // changes
                            $dialogCondOperand.change(() => {
                                $dialogCondThreshold.change();
                                // if (dialogDataOnLoading) { return; }
                                const propType = $dialogCondOperand.typedInput('type');
                                if (propType === types.PhaseMoon.value ||
                                        propType === types.MsgPayloadByTopic.value) {
                                    $dialogCondOperator.val(selFields.comparator[0].id); // only true is valid
                                    $dialogCondOperator.attr('disabled', true);
                                    $dialogCondOperator.hide();
                                    $dialogCondThreshold.typedInput('hide');
                                    $row2.hide();
                                } else if (propType === 'jsonata') {
                                    $dialogCondOperator.show();
                                    $dialogCondOperator.attr('disabled', true);
                                    $dialogCondOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                                    $dialogCondThreshold.typedInput('hide');
                                    $row2.show();
                                } else {
                                    $dialogCondOperator.show();
                                    $dialogCondOperator.attr('disabled', false);
                                    if (getOperandCount(selFields, $dialogCondOperator.val()) > 1) {
                                        $dialogCondThreshold.typedInput('show');
                                    } else {
                                        $dialogCondThreshold.typedInput('hide');
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        if (propType === types.SunAzimuth.value || types.SunElevation.value) { d.value = d.value.toFixed(3); }
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'operand'], d.value);
                                        $dialogCondOperand.attr('title', d.value);
                                        $row1.attr('title', d.value);
                                    } else {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'operand'], '');
                                        $dialogCondOperand.attr('title', '');
                                        $row1.attr('title', '');
                                    }
                                    _dialogGenHelpText();
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           propType,
                                    value:          $dialogCondOperand.typedInput('value'),
                                    noOffsetError:  true
                                });
                                $dialogCondLogOperator.change();
                                resizeConditionContainer();
                            });
                            if (containerIndex === 0) {
                                $dialogCondLogOperator.hide();
                            } else {
                                $dialogCondLogOperator.show();
                            }
                            $dialogCondOperator.change(() => {
                                $dialogCondOperand.change();
                            });
                            $dialogCondThreshold.change(() => {
                                const propType = $dialogCondOperand.typedInput('type');
                                const thresholdValueType = $dialogCondThreshold.typedInput('type');
                                if (propType === types.SunAzimuth.value) {
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $dialogCondThreshold.typedInput('type', types.numAzimuth.value);
                                    }
                                } else if (propType === types.SunElevation.value) {
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $dialogCondThreshold.typedInput('type', types.numAltitude.value);
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'threshold'], d.value);
                                        $dialogCondThreshold.attr('title', d.value);
                                        $row2.attr('title', d.value);
                                    } else {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'threshold'], '');
                                        $dialogCondThreshold.attr('title', '');
                                        $row2.attr('title', '');
                                    }
                                    _dialogGenHelpText();
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           thresholdValueType,
                                    value:          $dialogCondThreshold.typedInput('value'),
                                    noOffsetError:  true
                                });
                            });
                            $dialogCondOperand.change();
                            resizeConditionContainer();
                            _dialogGenHelpText();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                const $rule = $(this);
                                $rule.find('.dlg-ip-btctl-rule-condIndex').val(i + 1);
                                if (i === 0) {
                                    $rule.find('.dlg-ip-btctl-rule-condLogOperator').hide();
                                } else {
                                    $rule.find('.dlg-ip-btctl-rule-condLogOperator').show();
                                }
                            });
                            _dialogGenHelpText();
                        },
                        // resizeItem: resizeRule,
                        sortable: true,
                        removable: true,
                        removeItem() {
                            resizeConditionContainer();
                            _dialogGenHelpText();
                        }
                    }); // condition-container
                    $dialog.find('#dlg-ip-btctl-rule-condition-text').html(node._('node-red-contrib-sun-position/position-config:ruleCtrl.text.ruleCondition'));
                    // #endregion dialogConditions
                    // #region dialogTimeReg Start
                    const $dialogTimeStartRegInput = $dialog.find('#dlg-ip-btctl-rule-timeStartReg');
                    $dialogTimeStartRegInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.UndefinedTimeFrom,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeStartRegInput.typedInput('width', '40%');

                    const $dialogTimeStartRegMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeStartReg');
                    appendOptions(node, $dialogTimeStartRegMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeStartRegOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeStartReg');
                    $dialogTimeStartRegOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeStartRegOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeStartRegMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeStartRegMultiplier.prop('disabled', false);
                        }
                        $dialogTimeStartRegInput.change();
                    });
                    $dialogTimeStartRegOffset.typedInput('width', '40%');
                    // #endregion dialogTimeReg Start
                    // #region dialogTimeMin Start
                    const $dialogTimeStartMinInput = $dialog.find('#dlg-ip-btctl-rule-timeStartMin');
                    $dialogTimeStartMinInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeStartMinInput.typedInput('width', '40%');

                    const $dialogTimeStartMinMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeStartMin');
                    appendOptions(node, $dialogTimeStartMinMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeStartMinOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeStartMin');
                    $dialogTimeStartMinOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeStartMinOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeStartMinMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeStartMinMultiplier.prop('disabled', false);
                        }
                        $dialogTimeStartMinInput.change();
                    });
                    $dialogTimeStartMinOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMin Start
                    // #region dialogTimeMax Start
                    const $dialogTimeStartMaxInput = $dialog.find('#dlg-ip-btctl-rule-timeStartMax');
                    $dialogTimeStartMaxInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeStartMaxInput.typedInput('width', '40%');

                    const $dialogTimeStartMaxMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeStartMax');
                    appendOptions(node, $dialogTimeStartMaxMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeStartMaxOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeStartMax');
                    $dialogTimeStartMaxOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeStartMaxOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeStartMaxMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeStartMaxMultiplier.prop('disabled', false);
                        }
                        $dialogTimeStartMaxInput.change();
                    });
                    // #endregion dialogTimeMax  Start

                    // #region dialogTimeReg End
                    const $dialogTimeEndRegInput = $dialog.find('#dlg-ip-btctl-rule-timeEndReg');
                    $dialogTimeEndRegInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.UndefinedTimeUntil,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeEndRegInput.typedInput('width', '40%');

                    const $dialogTimeEndRegMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeEndReg');
                    appendOptions(node, $dialogTimeEndRegMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeEndRegOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeEndReg');
                    $dialogTimeEndRegOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeEndRegOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeEndRegMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeEndRegMultiplier.prop('disabled', false);
                        }
                        $dialogTimeEndRegInput.change();
                    });
                    $dialogTimeEndRegOffset.typedInput('width', '40%');
                    // #endregion dialogTimeReg End
                    // #region dialogTimeMin End
                    const $dialogTimeEndMinInput = $dialog.find('#dlg-ip-btctl-rule-timeEndMin');
                    $dialogTimeEndMinInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeEndMinInput.typedInput('width', '40%');

                    const $dialogTimeEndMinMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeEndMin');
                    appendOptions(node, $dialogTimeEndMinMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeEndMinOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeEndMin');
                    $dialogTimeEndMinOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeEndMinOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeEndMinMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeEndMinMultiplier.prop('disabled', false);
                        }
                        $dialogTimeEndMinInput.change();
                    });
                    $dialogTimeEndMinOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMin End
                    // #region dialogTimeMax End
                    const $dialogTimeEndMaxInput = $dialog.find('#dlg-ip-btctl-rule-timeEndMax');
                    $dialogTimeEndMaxInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ]
                    });
                    $dialogTimeEndMaxInput.typedInput('width', '40%');

                    const $dialogTimeEndMaxMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeEndMax');
                    appendOptions(node, $dialogTimeEndMaxMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeEndMaxOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeEndMax');
                    $dialogTimeEndMaxOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeEndMaxOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeEndMaxMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeEndMaxMultiplier.prop('disabled', false);
                        }
                        $dialogTimeEndMaxInput.change();
                    });
                    // #endregion dialogTimeMax End

                    // #region dialogTimeLimit
                    $dialog.find('#dialog-row-timeConstraints-show').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').hide();
                        $dialog.find('#dialog-row-timeConstraints').fadeIn('slow');
                    });

                    $dialog.find('#dialog-row-timeConstraints-hide').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').fadeIn('slow');
                        $dialog.find('#dialog-row-timeConstraints').hide();
                    });

                    const $dialogTimeLimitOnlyEvenDays = $dialog.find('#dlg-ip-btctl-rule-timeOnlyEvenDays');
                    const $dialogTimeLimitOnlyOddDays = $dialog.find('#dlg-ip-btctl-rule-timeOnlyOddDays');
                    const $dialogTimeLimitOnlyEvenWeeks = $dialog.find('#dlg-ip-btctl-rule-timeOnlyEvenWeeks');
                    const $dialogTimeLimitOnlyOddWeeks = $dialog.find('#dlg-ip-btctl-rule-timeOnlyOddWeeks');
                    const $dialogTimeLimitDateStart = $dialog.find('#dlg-ip-btctl-rule-timedatelimit-start');
                    const $dialogTimeLimitDateEnd = $dialog.find('#dlg-ip-btctl-rule-timedatelimit-end');
                    $dialogTimeLimitDateStart.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateEnd.attr('min', year + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '01-01'));
                        $dialogTimeLimitDateEnd.attr('max', (year + 1) + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '12-31'));
                        _dialogGenHelpText();
                    });
                    $dialogTimeLimitDateEnd.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateStart.attr('min', year + '-01-01');
                        $dialogTimeLimitDateStart.attr('max', $dialogTimeLimitDateEnd.val() || (year + '-12-31'));
                        _dialogGenHelpText();
                    });
                    // #endregion dialogTimeLimit
                    // #region overwrite + importance
                    const $dialogImportance = $dialog.find('#dlg-ip-btctl-rule-importance');
                    $dialogImportance.spinner({
                        max: 1000,
                        min: 0,
                        step: 1,
                        stop:(_e, _ui) => { _dialogGenHelpText(); }
                    });
                    $dialogImportance.change(() => { _dialogGenHelpText(); });
                    const $dialogResetOverwrite = $dialog.find('#dlg-ip-btctl-rule-resetOverwrite');
                    $dialogResetOverwrite.change(() => { _dialogGenHelpText(); });
                    // #endregion overwrite + importance
                    // #region dialogPayload
                    const $dialogPayload = $dialog.find('#dlg-ip-btctl-rule-payload');
                    $dialogPayload.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.MsgPayload,
                            types.MsgValue,
                            'str',
                            'num',
                            'bool',
                            'date',
                            types.DateSpecific,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.randomNumber,
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek,
                            types.TimeEntered,
                            types.DateEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            types.DayOfMonth,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationObj,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ]
                    });
                    $dialogPayload.typedInput('width', '40%');

                    const $dialogPayloadOffset = $dialog.find('#dlg-ip-btctl-rule-payloadOffset');
                    $dialogPayloadOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek]
                    }).change(() => { $dialogPayload.change(); });
                    $dialogPayloadOffset.typedInput('width', '40%');

                    const $dialogPayloadMultiplier = $dialog.find('#dlg-ip-btctl-rule-payloadOffsetMultiplier');
                    appendOptions(node, $dialogPayloadMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogPayloadTimeFormat = $dialog.find('#dlg-ip-btctl-rule-payloadTimeFormat');
                    const $dialogPayloadTimeFormatsel = $dialog.find('#dlg-ip-btctl-rule-payloadTimeFormatsel');

                    appendOptions(node, $dialogPayloadTimeFormatsel, 'outputFormats');
                    autocomplete($dialogPayloadTimeFormat, 'dateOutFormat');
                    // #endregion dialogPayload
                    // #region topic
                    const $dialogTopic = $dialog.find('#dlg-ip-btctl-rule-topic');
                    $dialogTopic.change(() => { _dialogGenHelpText(); });
                    // #endregion topic
                    // #region dialogChange
                    $dialogTimeStartRegInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opType = $dialogTimeStartRegInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            node.dialogAddData.timeReg = {
                                ts : 0,
                                data : null,
                                text : 'N/A'
                            };
                            $('#dialog-row-timeStartReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeStartRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            $('#dialog-row-offset-timeStartReg').hide();
                            $('#dialog-row-timeStartReg').attr('title', opType);

                            $('#dialog-row-timeStartMin').hide();
                            $('#dialog-row-timeStartMax').hide();
                            $('#dialog-row-offset-timeStartMin').hide();
                            $('#dialog-row-offset-timeStartMax').hide();
                            $('.dialog-row-timeStartLimits').hide();
                            $('.dialog-row-timeStartLimits-ph').hide();
                            if ($dialogTimeStartMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeStartMaxInput.typedInput('type', types.Undefined.value);
                            }
                            if ($dialogTimeStartMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeStartMaxInput.typedInput('type', types.Undefined.value);
                            }
                            _dialogGenHelpText();
                            return;
                        }
                        if (opType === types.TimeEntered.value ||
                            opType === types.TimeSun.value ||
                            opType === types.TimeSunCustom.value ||
                            opType === types.TimeMoon.value) {
                            $('#dialog-row-offset-timeStartReg').show();
                        } else {
                            $('#dialog-row-offset-timeStartReg').hide();
                        }

                        const noLimit = getCheckboxesStr($('#dlg-ip-btctl-rule-timeDays input[type=checkbox]:checked'), 7) === '*' &&
                                        getCheckboxesStr($('#dlg-ip-btctl-rule-timeMonths input[type=checkbox]:checked'), 12) === '*' &&
                                        $dialogTimeLimitOnlyEvenDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyEvenWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitDateStart.val() === '' &&
                                        $dialogTimeLimitDateEnd.val() === '';
                        if (noLimit) {
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').show();
                        } else {
                            $('.dialog-row-timeLimits').show();
                            $('.dialog-row-timeLimits-ph').hide();
                        }
                        getBackendData(d => {
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                node.dialogAddData.timeReg = {
                                    ts : dv.getTime(),
                                    data : d,
                                    text : bdDateToTime(dv)
                                };
                            } else {
                                node.dialogAddData.timeReg = {
                                    ts : 0,
                                    data : null,
                                    text : bdDateToTime(d)
                                };
                            }
                            $('#dialog-row-timeStartReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeStartRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            _dialogGenHelpText();
                        }, {
                            nodeId:         node.id,
                            kind:           'getTimeData',
                            config:         $nodeConfig.val(),
                            type:           opType,
                            value:          $dialogTimeStartRegInput.typedInput('value'),
                            offsetType:     $dialogTimeStartRegOffset.typedInput('type'),
                            offset:         $dialogTimeStartRegOffset.typedInput('value'),
                            multiplier:     parseInt($dialogTimeStartRegMultiplier.val()),
                            noOffsetError:  true
                        });
                        $dialogTimeStartMinInput.change();
                        $dialogTimeStartMaxInput.change();
                    });

                    $dialogTimeStartMinInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeStartRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeStartMin').show();
                            const opType = $dialogTimeStartMinInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeStartMin').hide();
                                node.dialogAddData.time.start.min = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeStartMin').attr('title', node.dialogAddData.time.start.min.text);
                                $dialogTimeStartMinInput.attr('timedata', node.dialogAddData.time.start.min.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeSunCustom.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeStartMin').show();
                            } else {
                                $('#dialog-row-offset-timeStartMin').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.time.start.min = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.time.start.min = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeStartMin').attr('title', node.dialogAddData.time.start.min.text);
                                $dialogTimeStartMinInput.attr('timedata', node.dialogAddData.time.start.min.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeStartMinInput.typedInput('value'),
                                offsetType:     $dialogTimeStartMinOffset.typedInput('type'),
                                offset:         $dialogTimeStartMinOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeStartMinMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });

                    $dialogTimeStartMaxInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeStartRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeStartMax').show();
                            const opType = $dialogTimeStartMaxInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeStartMax').hide();
                                node.dialogAddData.time.start.max = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeStartMax').attr('title', node.dialogAddData.time.start.max.text);
                                $dialogTimeStartMaxInput.attr('timedata', node.dialogAddData.time.start.max.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeSunCustom.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeStartMax').show();
                            } else {
                                $('#dialog-row-offset-timeStartMax').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.time.start.max = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.time.start.max = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeStartMax').attr('title', node.dialogAddData.time.start.max.text);
                                $dialogTimeStartMaxInput.attr('timedata', node.dialogAddData.time.start.max.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeStartMaxInput.typedInput('value'),
                                offsetType:     $dialogTimeStartMaxOffset.typedInput('type'),
                                offset:         $dialogTimeStartMaxOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeStartMaxMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });

                    $dialogTimeEndRegInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opType = $dialogTimeEndRegInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            node.dialogAddData.timeReg = {
                                ts : 0,
                                data : null,
                                text : 'N/A'
                            };
                            $('#dialog-row-timeEndReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeEndRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            $('#dialog-row-timeEndReg-offset').hide();
                            $('#dialog-row-timeEndReg').attr('title', opType);

                            $('#dialog-row-timeEndMin').hide();
                            $('#dialog-row-timeEndMax').hide();
                            $('#dialog-row-timeEndMin-offset').hide();
                            $('#dialog-row-timeEndMax-offset').hide();
                            $('.dialog-row-timeEndLimits').hide();
                            $('.dialog-row-timeEndLimits-ph').hide();
                            if ($dialogTimeEndMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeEndMaxInput.typedInput('type', types.Undefined.value);
                            }
                            if ($dialogTimeEndMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeEndMaxInput.typedInput('type', types.Undefined.value);
                            }
                            _dialogGenHelpText();
                            return;
                        }
                        if (opType === types.TimeEntered.value ||
                           opType === types.TimeSun.value ||
                           opType === types.TimeSunCustom.value ||
                           opType === types.TimeMoon.value) {
                            $('#dialog-row-timeEndReg-offset').show();
                        } else {
                            $('#dialog-row-timeEndReg-offset').hide();
                        }

                        const noLimit = getCheckboxesStr($('#dlg-ip-btctl-rule-timeDays input[type=checkbox]:checked'), 7) === '*' &&
                                        getCheckboxesStr($('#dlg-ip-btctl-rule-timeMonths input[type=checkbox]:checked'), 12) === '*' &&
                                        $dialogTimeLimitOnlyEvenDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyEvenWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitDateStart.val() === '' &&
                                        $dialogTimeLimitDateEnd.val() === '';
                        if (noLimit) {
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').show();
                        } else {
                            $('.dialog-row-timeLimits').show();
                            $('.dialog-row-timeLimits-ph').hide();
                        }
                        getBackendData(d => {
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                node.dialogAddData.timeReg = {
                                    ts : dv.getTime(),
                                    data : d,
                                    text : bdDateToTime(dv)
                                };
                            } else {
                                node.dialogAddData.timeReg = {
                                    ts : 0,
                                    data : null,
                                    text : bdDateToTime(d)
                                };
                            }
                            $('#dialog-row-timeEndReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeEndRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            _dialogGenHelpText();
                        }, {
                            nodeId:         node.id,
                            kind:           'getTimeData',
                            config:         $nodeConfig.val(),
                            type:           opType,
                            value:          $dialogTimeEndRegInput.typedInput('value'),
                            offsetType:     $dialogTimeEndRegOffset.typedInput('type'),
                            offset:         $dialogTimeEndRegOffset.typedInput('value'),
                            multiplier:     parseInt($dialogTimeEndRegMultiplier.val()),
                            noOffsetError:  true
                        });
                        $dialogTimeEndMinInput.change();
                        $dialogTimeEndMaxInput.change();
                    });

                    $dialogTimeEndMinInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeEndRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeEndMin').show();
                            const opType = $dialogTimeEndMinInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-timeEndMin-offset').hide();
                                node.dialogAddData.time.end.min = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeEndMin').attr('title', node.dialogAddData.time.end.min.text);
                                $dialogTimeEndMinInput.attr('timedata', node.dialogAddData.time.end.min.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeSunCustom.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-timeEndMin-offset').show();
                            } else {
                                $('#dialog-row-timeEndMin-offset').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.time.end.min = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.time.end.min = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeEndMin').attr('title', node.dialogAddData.time.end.min.text);
                                $dialogTimeEndMinInput.attr('timedata', node.dialogAddData.time.end.min.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeEndMinInput.typedInput('value'),
                                offsetType:     $dialogTimeEndMinOffset.typedInput('type'),
                                offset:         $dialogTimeEndMinOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeEndMinMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });

                    $dialogTimeEndMaxInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeEndRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeEndMax').show();
                            const opType = $dialogTimeEndMaxInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-timeEndMax-offset').hide();
                                node.dialogAddData.time.end.max = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeEndMax').attr('title', node.dialogAddData.time.end.max.text);
                                $dialogTimeEndMaxInput.attr('timedata', node.dialogAddData.time.end.max.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeSunCustom.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-timeEndMax-offset').show();
                            } else {
                                $('#dialog-row-timeEndMax-offset').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.time.end.max = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.time.end.max = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeEndMax').attr('title', node.dialogAddData.time.end.max.text);
                                $dialogTimeEndMaxInput.attr('timedata', node.dialogAddData.time.end.max.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeEndMaxInput.typedInput('value'),
                                offsetType:     $dialogTimeEndMaxOffset.typedInput('type'),
                                offset:         $dialogTimeEndMaxOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeEndMaxMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });

                    $('.dialog-row-timeLimits :input').change(() => {
                        if (node.dialogAddData.timeout2) { clearTimeout(node.dialogAddData.timeout2); }
                        node.dialogAddData.timeout2 = setTimeout(() => {
                            delete node.dialogAddData.timeout2;
                            $dialogTimeStartRegInput.change();
                            $dialogTimeEndRegInput.change();
                        },1000);
                    });

                    $dialogPayload.change(() => {
                        const plVType = $dialogPayload.typedInput('type');
                        if (plVType === types.Undefined.value) {
                            $('#dialog-row-topic').hide();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').hide();
                            _dialogGenHelpText();
                            return;
                        } else if (plVType ===  types.TimeEntered.value ||
                            plVType === types.TimeSun.value ||
                            plVType === types.TimeSunCustom.value ||
                            plVType === types.TimeMoon.value ||
                            plVType === types.DateSpecific.value) {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').show();
                            $('#dialog-row-payloadOffset').show();
                        } else if (plVType ===  types.TimeSunNow.value) {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').show();
                        } else {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').hide();
                        }
                        getBackendData(d => {
                            const $div = $('#dialog-row-payload');
                            const titleOrg = $div.attr('titleOrg');
                            // $div.attr('title', ((d) ? (String(d) + ' - ') : '') + titleOrg);
                            $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                        }, {
                            nodeId:     node.id,
                            kind:       'getOutDataData',
                            config:     $nodeConfig.val(),
                            type:       plVType,
                            value:      $('#dlg-ip-btctl-rule-payload').typedInput('value'),
                            format:     $('#dlg-ip-btctl-rule-payloadTimeFormat').val(),
                            offsetType: $('#dlg-ip-btctl-rule-payloadOffset').typedInput('type'),
                            offset:     $('#dlg-ip-btctl-rule-payloadOffset').typedInput('value'),
                            multiplier: $('#dlg-ip-btctl-rule-payloadOffsetMultiplier').val(),
                            noOffsetError: true
                        });
                        _dialogGenHelpText();
                    });

                    $dialogPayloadTimeFormatsel.on('change focus focusout', (_type, _value) => {
                        if (Number($dialogPayloadTimeFormatsel.val()) === 99) {
                            $dialogPayloadTimeFormatsel.css({ width: '100px' });
                            const width = (205 + 30);
                            $dialogPayloadTimeFormat.css({ width: 'calc(100% - ' + width + 'px)' });
                            $dialogPayloadTimeFormat.show();
                            if (!isNaN($dialogPayloadTimeFormat.val())) {
                                $dialogPayloadTimeFormat.val(node._('node-red-contrib-sun-position/position-config:common.timeFormat.default'));
                            }
                        } else {
                            $dialogPayloadTimeFormat.hide();
                            const width = (100 + 30);
                            $dialogPayloadTimeFormatsel.css({ width: 'calc(100% - ' + width + 'px)' });
                            $dialogPayloadTimeFormat.val($dialogPayloadTimeFormatsel.val());
                        }
                        _dialogGenHelpText();
                    });
                    // #endregion dialogChange
                    // #region dialogload & save
                    /** generates the help text of the dialog */
                    function _dialogGenHelpText() {
                        $('#dlg-txt-btctl-rule-descr').html('');
                        if (node.dialogAddData.timeout) { clearTimeout(node.dialogAddData.timeout); }
                        node.dialogAddData.timeout = setTimeout(() => {
                            delete node.dialogAddData.timeout;
                            try {
                                $('#dlg-txt-btctl-rule-descr').html(getRuleDescription(node, selFields, _dialogGetData(), node.dialogAddData));
                            } catch (err) {
                                console.warn('_dialogGenHelpText - maybe too fast:', err.message); // eslint-disable-line no-console
                            }
                        },1000);
                    }
                    /** load the data from the rule */
                    function _dialogLoadData(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            $dialogName.val(data.name);
                            $dialogExec.val(data.exec);

                            $dialogRuleEnableBtn.attr('is_enabled', data.enabled);
                            $dialogRuleEnableBtn.trigger('setRuleEnabledState');
                            dialogDataOnLoading = true;
                            $dialogConditionContainer.editableList('empty');
                            for (let i = 0; i < data.conditions.length; i++) {
                                $dialogConditionContainer.editableList('addItem', data.conditions[i]);
                            }
                            $dialogTimeStartRegMultiplier.val(60000);
                            $dialogTimeEndRegMultiplier.val(60000);
                            setTInputValue($dialogTimeStartRegInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeStartRegOffset, 1, types.Undefined.value);
                            setTInputValue($dialogTimeEndRegInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeEndRegOffset, 1, types.Undefined.value);
                            initCheckboxesBlock('#dlg-ip-btctl-rule-timeDays', '*');
                            initCheckboxesBlock('#dlg-ip-btctl-rule-timeMonths', '*');
                            $dialogTimeLimitOnlyEvenDays.prop('checked', false);
                            $dialogTimeLimitOnlyOddDays.prop('checked', false);
                            $dialogTimeLimitOnlyEvenWeeks.prop('checked', false);
                            $dialogTimeLimitOnlyOddWeeks.prop('checked', false);
                            $dialogTimeLimitDateStart.val('');
                            $dialogTimeLimitDateEnd.val('');

                            setTInputValue($dialogTimeEndMinInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeEndMinOffset, 1, types.Undefined.value);
                            $dialogTimeEndMinMultiplier.val(60000);
                            setTInputValue($dialogTimeEndMaxInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeEndMaxOffset, 1, types.Undefined.value);
                            $dialogTimeEndMaxMultiplier.val(60000);

                            setTInputValue($dialogTimeStartMinInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeStartMinOffset, 1, types.Undefined.value);
                            $dialogTimeStartMinMultiplier.val(60000);
                            setTInputValue($dialogTimeStartMaxInput, '', types.Undefined.value);
                            setTInputValue($dialogTimeStartMaxOffset, 1, types.Undefined.value);
                            $dialogTimeStartMaxMultiplier.val(60000);

                            if (data.time) {
                                if (data.time.start) {
                                    $dialogTimeStartRegMultiplier.val(data.time.start.multiplier);
                                    setTInputValue($dialogTimeStartRegInput, data.time.start.value, data.time.start.type);
                                    setTInputValue($dialogTimeStartRegOffset, data.time.start.offset, data.time.start.offsetType);

                                    if (data.time.start.min) {
                                        $dialogTimeStartMinMultiplier.val(data.time.start.min.multiplier || 60000);
                                        setTInputValue($dialogTimeStartMinInput, data.time.start.min.value, data.time.start.min.type);
                                        setTInputValue($dialogTimeStartMinOffset, data.time.start.min.offset, data.time.start.min.offsetType);
                                    }
                                    if (data.time.start.max) {
                                        $dialogTimeStartMaxMultiplier.val(data.time.start.max.multiplier || 60000);
                                        setTInputValue($dialogTimeStartMaxInput, data.time.start.max.value, data.time.start.max.type);
                                        setTInputValue($dialogTimeStartMaxOffset, data.time.start.max.offset, data.time.start.max.offsetType);
                                    }
                                }
                                if (data.time.end) {
                                    $dialogTimeEndRegMultiplier.val(data.time.end.multiplier);
                                    setTInputValue($dialogTimeEndRegInput, data.time.end.value, data.time.end.type);
                                    setTInputValue($dialogTimeEndRegOffset, data.time.end.offset, data.time.end.offsetType);

                                    if (data.time.end.min) {
                                        $dialogTimeEndMinMultiplier.val(data.time.end.min.multiplier || 60000);
                                        setTInputValue($dialogTimeEndMinInput, data.time.end.min.value, data.time.end.min.type);
                                        setTInputValue($dialogTimeEndMinOffset, data.time.end.min.offset, data.time.end.min.offsetType);
                                    }
                                    if (data.time.end.max) {
                                        $dialogTimeEndMaxMultiplier.val(data.time.end.max.multiplier || 60000);
                                        setTInputValue($dialogTimeEndMaxInput, data.time.end.max.value, data.time.end.max.type);
                                        setTInputValue($dialogTimeEndMaxOffset, data.time.end.max.offset, data.time.end.max.offsetType);
                                    }
                                }

                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeDays', data.time.days);
                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeMonths', data.time.months);
                                if (!!data.time.onlyEvenDays && !!data.time.onlyOddDays) {
                                    data.time.onlyEvenDays = false;
                                    data.time.onlyOddDays = false;
                                }
                                if (!!data.time.onlyEvenWeeks && !!data.time.onlyOddWeeks) {
                                    data.time.onlyEvenWeeks = false;
                                    data.time.onlyOddWeeks = false;
                                }
                                $dialogTimeLimitOnlyEvenDays.prop('checked', !!data.time.onlyEvenDays);
                                $dialogTimeLimitOnlyOddDays.prop('checked', !!data.time.onlyOddDays);
                                $dialogTimeLimitOnlyEvenWeeks.prop('checked', !!data.time.onlyEvenWeeks);
                                $dialogTimeLimitOnlyOddWeeks.prop('checked', !!data.time.onlyOddWeeks);
                                const year = (new Date()).getFullYear();
                                let dStart, dEnd;
                                if (data.time.dateStart) {
                                    dStart = new Date(data.time.dateStart);
                                    dStart.setHours(0, 0, 0, 1);
                                    dStart.setFullYear(year);
                                } else {
                                    dStart = new Date(year, 0, 1, 0, 0, 0, 1);
                                }

                                if (data.time.dateEnd) {
                                    dEnd = new Date(data.time.dateEnd);
                                    dEnd.setHours(23, 59, 59, 999);
                                    dEnd.setFullYear(year);
                                } else {
                                    dEnd = new Date(year, 11, 31, 23, 59, 59, 999);
                                }

                                if (dEnd.getTime() < dStart.getTime()) {
                                    dEnd.setFullYear(year + 1);
                                }
                                const pad = (n, z = 2) => ('00' + n).slice(-z);
                                if (data.time.dateStart) {
                                    $dialogTimeLimitDateStart.val(dStart.getFullYear() + '-' + pad(dStart.getMonth() + 1) + '-' + pad(dStart.getDate()));
                                }
                                if (data.time.dateEnd) {
                                    $dialogTimeLimitDateEnd.val(dEnd.getFullYear() + '-' + pad(dEnd.getMonth() + 1) + '-' + pad(dEnd.getDate()));
                                }
                                $dialogTimeLimitDateStart.change();
                                $dialogTimeLimitDateEnd.change();
                            }
                            if (data.payload) {
                                $dialogPayloadMultiplier.val(data.payload.multiplier || 60000);
                                setTInputValue($dialogPayload, data.payload.value, data.payload.type);
                                setTInputValue($dialogPayloadOffset, data.payload.offset, data.payload.offsetType);
                                const valueNum = Number(data.payload.format);
                                if (isNaN(valueNum)) {
                                    $dialogPayloadTimeFormatsel.val(99);
                                    $dialogPayloadTimeFormat.val(data.payload.format);
                                } else {
                                    $dialogPayloadTimeFormatsel.val(valueNum);
                                }
                            } else {
                                $dialogPayloadMultiplier.val(60000);
                            }
                            $dialogTopic.val(data.topic || '');
                            $dialogImportance.val(data.importance || 0);
                            $dialogResetOverwrite.prop('checked', (!!data.resetOverwrite));

                            _dialogGenHelpText();
                            dialogDataOnLoading = false;
                            $dialogTimeStartRegInput.change();
                            $dialogTimeEndRegInput.change();
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            $dialogName.val(err.message);
                        }
                        $dialog.dialog('open');
                    }

                    /**
                     * checks if all properties of an object are true
                     */
                    function checkObj(obj, path) {
                        for (const [key, value] of Object.entries(obj)) {
                            if (value === true || key === 'index') continue; // return path;
                            if (typeof value === 'object') {
                                const val = checkObj(value, path + key + '.');
                                if (val !== '') return val;
                                continue;
                            }
                            return path + key;
                        }
                        return '';
                    }

                    /**
                     * Get the data object for a rule
                     */
                    function _dialogGetData() {
                        const result = {
                            index: dialogDataIndex,
                            name:$dialogName.val(),
                            exec: $dialogExec.val(),
                            version: ruleVersion,
                            enabled: !($dialogRuleEnableBtn.attr('is_enabled') === false || $dialogRuleEnableBtn.attr('is_enabled') === 'false'),
                            isValid: false,
                            validationError: '',
                            validation:{
                                conditions : []
                            },
                            conditions: [],
                            payload: {
                                type        : $dialogPayload.typedInput('type'),
                                value       : $dialogPayload.typedInput('value'),
                                offsetType  : $dialogPayloadOffset.typedInput('type'),
                                offset      : $dialogPayloadOffset.typedInput('value'),
                                multiplier  : parseInt($dialogPayloadMultiplier.val()),
                                format      : $dialogPayloadTimeFormat.val()
                            },
                            topic           : $dialogTopic.val(),
                            resetOverwrite: $dialogResetOverwrite.is(':checked'),
                            importance      : parseInt($dialogImportance.val())
                        };
                        try {
                            const setval = (param, name, val) => { if (val) param[name] = val; };
                            if (result.payload.type === 'none') {
                                delete result.payload.offsetType;
                                delete result.payload.offset;
                                delete result.payload.multiplier;
                                delete result.payload.format;
                            }

                            $dialogConditionContainer.editableList('items').each(function(_i) {
                                const $cond = $(this);
                                const p = {
                                    condition       : Number($cond.find('.dlg-ip-btctl-rule-condLogOperator').val()),
                                    conditionText   : $cond.find('.dlg-ip-btctl-rule-condLogOperator option:selected').text(),
                                    valueType       : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('type'),
                                    value           : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('value'),
                                    operator        : $cond.find('.dlg-ip-btctl-rule-condOperator').val(),
                                    operatorText    : $cond.find('.dlg-ip-btctl-rule-condOperator option:selected').text(),
                                    thresholdType   : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('type'),
                                    threshold       : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('value')
                                };
                                if (p.thresholdType === 'num' && p.threshold === '') {
                                    p.threshold = 0;
                                }
                                if (_i === 0) {
                                    delete p.condition;
                                    delete p.conditionText;
                                }
                                result.conditions.push(p);
                                result.validation.conditions.push({
                                    index       : _i,
                                    value       : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('validate'),
                                    threshold   : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('validate')
                                });
                            });
                            const timeTypeStart = $dialogTimeStartRegInput.typedInput('type');
                            const timeTypeEnd = $dialogTimeEndRegInput.typedInput('type');

                            if (timeTypeStart !== 'none' || timeTypeEnd !== 'none') {
                                result.time = { };
                                result.validation.time = {
                                    start : {
                                        value : $dialogTimeStartRegInput.typedInput('validate')
                                    },
                                    end : {
                                        value : $dialogTimeEndRegInput.typedInput('validate')
                                    }
                                };

                                if (timeTypeStart !== 'none') {
                                    result.time.start = {
                                        type            : timeTypeStart,
                                        value           : $dialogTimeStartRegInput.typedInput('value'),
                                        offsetType      : $dialogTimeStartRegOffset.typedInput('type'),
                                        offset          : $dialogTimeStartRegOffset.typedInput('value'),
                                        multiplier      : parseInt($dialogTimeStartRegMultiplier.val())
                                    };
                                    result.validation.time.start.offset = $dialogTimeStartRegOffset.typedInput('validate');
                                    result.validation.time.start.multiplier = !isNaN(result.time.start.multiplier);
                                    const minType = $dialogTimeStartMinInput.typedInput('type');
                                    result.validation.time.start.min = $dialogTimeStartMinInput.typedInput('validate');
                                    if (minType !== 'none') {
                                        result.time.start.min = {
                                            type        : minType,
                                            value       : $dialogTimeStartMinInput.typedInput('value'),
                                            offsetType  : $dialogTimeStartMinOffset.typedInput('type'),
                                            offset      : $dialogTimeStartMinOffset.typedInput('value'),
                                            multiplier  : parseInt($dialogTimeStartMinMultiplier.val())
                                        };
                                        result.validation.time.start.minOffset = $dialogTimeStartMinOffset.typedInput('validate');
                                        result.validation.time.start.minMultiplier = !isNaN(result.time.start.min.multiplier);
                                    }
                                    const maxType = $dialogTimeStartMaxInput.typedInput('type');
                                    result.validation.time.start.max = $dialogTimeStartMaxInput.typedInput('validate');
                                    if (maxType !== 'none') {
                                        result.time.start.max = {
                                            type        : maxType,
                                            value       : $dialogTimeStartMaxInput.typedInput('value'),
                                            offsetType  : $dialogTimeStartMaxOffset.typedInput('type'),
                                            offset      : $dialogTimeStartMaxOffset.typedInput('value'),
                                            multiplier  :  parseInt($dialogTimeStartMaxMultiplier.val())
                                        };
                                        result.validation.time.start.maxOffset = $dialogTimeStartMaxOffset.typedInput('validate');
                                        result.validation.time.start.maxMultiplier = !isNaN(result.time.start.max.multiplier);
                                    }
                                }
                                if (timeTypeEnd !== 'none') {
                                    result.time.end = {
                                        type            : timeTypeEnd,
                                        value           : $dialogTimeEndRegInput.typedInput('value'),
                                        offsetType      : $dialogTimeEndRegOffset.typedInput('type'),
                                        offset          : $dialogTimeEndRegOffset.typedInput('value'),
                                        multiplier      : parseInt($dialogTimeEndRegMultiplier.val())
                                    };
                                    result.validation.time.end.offset = $dialogTimeEndRegOffset.typedInput('validate');
                                    result.validation.time.end.multiplier = !isNaN(result.time.end.multiplier);
                                    const minType = $dialogTimeEndMinInput.typedInput('type');
                                    result.validation.time.end.min = $dialogTimeEndMinInput.typedInput('validate');
                                    if (minType !== 'none') {
                                        result.time.end.min = {
                                            type        : minType,
                                            value       : $dialogTimeEndMinInput.typedInput('value'),
                                            offsetType  : $dialogTimeEndMinOffset.typedInput('type'),
                                            offset      : $dialogTimeEndMinOffset.typedInput('value'),
                                            multiplier  : parseInt($dialogTimeEndMinMultiplier.val())
                                        };
                                        result.validation.time.end.minOffset = $dialogTimeEndMinOffset.typedInput('validate');
                                        result.validation.time.end.minMultiplier = !isNaN(result.time.end.min.multiplier);
                                    }
                                    const maxType = $dialogTimeEndMaxInput.typedInput('type');
                                    result.validation.time.end.max = $dialogTimeEndMaxInput.typedInput('validate');
                                    if (maxType !== 'none') {
                                        result.time.end.max = {
                                            type        : maxType,
                                            value       : $dialogTimeEndMaxInput.typedInput('value'),
                                            offsetType  : $dialogTimeEndMaxOffset.typedInput('type'),
                                            offset      : $dialogTimeEndMaxOffset.typedInput('value'),
                                            multiplier  :  parseInt($dialogTimeEndMaxMultiplier.val())
                                        };
                                        result.validation.time.end.maxOffset = $dialogTimeEndMaxOffset.typedInput('validate');
                                        result.validation.time.end.maxMultiplier = !isNaN(result.time.end.max.multiplier);
                                    }
                                }

                                result.time.days = getCheckboxesStr($('#dlg-ip-btctl-rule-timeDays input[type=checkbox]:checked'),7);
                                result.time.months = getCheckboxesStr($('#dlg-ip-btctl-rule-timeMonths input[type=checkbox]:checked'), 12);
                                setval(result.time,'onlyEvenDays', $dialogTimeLimitOnlyEvenDays.is(':checked'));
                                setval(result.time,'onlyOddDays', $dialogTimeLimitOnlyOddDays.is(':checked'));
                                setval(result.time,'onlyEvenWeeks', $dialogTimeLimitOnlyEvenWeeks.is(':checked'));
                                setval(result.time,'onlyOddWeeks', $dialogTimeLimitOnlyOddWeeks.is(':checked'));
                                setval(result.time,'dateStart', $dialogTimeLimitDateStart.val());
                                setval(result.time,'dateEnd', $dialogTimeLimitDateEnd.val());

                                if (result.time.onlyEvenDays && result.time.onlyOddDays) {
                                    delete result.time.onlyEvenDays;
                                    delete result.time.onlyOddDays;
                                    result.validation.time.noEvenAndOddDaysAllowed = false;
                                }
                                if (result.time.onlyEvenWeeks && result.time.onlyOddWeeks) {
                                    delete result.time.onlyEvenWeeks;
                                    delete result.time.onlyOddWeeks;
                                    result.validation.time.noEvenAndOddWeeksAllowed = false;
                                }
                                if (!result.time.days || !result.time.months) {
                                    result.validation.time.noDaysAllowed = false;
                                }
                                if (!result.time.days || !result.time.months) {
                                    result.validation.time.noMonthAllowed = false;
                                }
                            }
                            result.validation.payload = $dialogPayload.typedInput('validate');
                            if (result.validation.payload && result.payload.type !== 'none') {
                                result.validation.payloadOffset = $dialogPayloadOffset.typedInput('validate');
                                result.validation.payloadMultiplier = !isNaN(result.payload.multiplier);
                            }
                            result.validationError = checkObj(result.validation, '');
                            result.isValid = (result.validationError === '');
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            result.isValid = false;
                            result.validationError = err.message;
                        }
                        if (!result.isValid) {
                            console.warn('Rule validation failed! Wrong element:', result.validationError, result.validation); // eslint-disable-line
                            console.log('Rule Data:', result); // eslint-disable-line
                        } else {
                            delete result.validation; // if valid, not needed
                        }
                        return result;
                    }
                    /**
                     * save the data of the rule back
                     */
                    function _dialogSaveData() {
                        const data = _dialogGetData();
                        data.description = getRuleDescription(node, selFields, data);
                        if (data.conditions) data.conditions.forEach(p => {
                            delete p.operatorText;
                            delete p.conditionText;
                        });

                        $dialogDataRow.data('ruleData', JSON.stringify(data));
                        $('#rule-name-'+dialogDataIndex).text((data.name || 'rule ' + (dialogDataIndex + 1)) + ((data.importance > 0) ? ' ['+data.importance+']' : ''));
                        $('#rule-description-'+dialogDataIndex).html(data.description);
                        $('#rule-btn-state-'+dialogDataIndex).trigger('setRuleEnabledState');
                        resizeRuleContainerCheck(node);
                    }

                    /**
                     * Duplicates an existing rule
                     */
                    function _dialogDuplicateRule(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            const nm = parseInt(data.name.match(/[0-9]+(?!.*[0-9])/), 10);
                            if (nm) {
                                data.name = data.name.replace(/[0-9]+(?!.*[0-9])/, nm + 1);
                            } else {
                                data.name += ' - copy 1';
                            }
                            data.description = getRuleDescription(node, selFields, data);
                            $('#node-input-rule-container').editableList('addItem', data);
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            // $dialogName.val(err.message);
                        }
                        resizeRuleContainerCheck(node);
                    }
                    // #endregion dialogload & save
                    // #endregion dialog
                    resizeRuleContainerCheck(node);
                }; // setup

                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus,  _bmvfj) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }

                        tabs.addTab({
                            id: 'clock-timer-tab-general',
                            label: this._('clock-timer.tabs-label.general'),
                            name: this._('clock-timer.tabs-label.general'),
                            iconClass: 'fa fa-tags'
                        });
                        $nodeConfig.change(() => {
                            if ($nodeConfig.val() === '_ADD_' || $nodeConfig.val() === '') {
                                if (tabs.count() > 1){
                                    tabs.removeTab('clock-timer-tab-default');
                                    tabs.removeTab('clock-timer-tab-time');
                                    tabs.removeTab('clock-timer-tab-output');
                                }
                            } else if (tabs.count() <= 1) {
                                tabs.addTab({
                                    id: 'clock-timer-tab-default',
                                    label: this._('clock-timer.tabs-label.default'),
                                    name: this._('clock-timer.tabs-label.default'),
                                    iconClass: 'fa fa-sliders'
                                });

                                tabs.addTab({
                                    id: 'clock-timer-tab-time',
                                    label: this._('clock-timer.tabs-label.time'),
                                    name: this._('clock-timer.tabs-label.time'),
                                    iconClass: 'fa fa-clock-o'
                                });

                                tabs.addTab({
                                    id: 'clock-timer-tab-output',
                                    label: this._('clock-timer.tabs-label.output'),
                                    name: this._('clock-timer.tabs-label.output'),
                                    iconClass: 'fa fa-sign-out'
                                });
                            }
                            setTimeout(() => { tabs.resize(); }, 0);
                        });
                        $nodeConfig.change();
                    })
                    .fail((jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                // @ts-check
                const node = this;
                node.rules = [];
                $('#node-input-rule-container').editableList('items').each(function (_i) {
                    const $rule = $(this);
                    const data = JSON.parse($rule.data('ruleData'));
                    data.index= _i;
                    node.rules.push(data);
                });

                const overwriteExpire = parseFloat($('#time-control-overwriteExpire').val());
                if (isNaN(overwriteExpire) || overwriteExpire === '' || overwriteExpire === 0) {
                    $('#node-input-overwriteExpire').val('');
                } else {
                    let val = overwriteExpire * parseFloat($('#time-control-overwriteExpire-multiplier').val());
                    if (val < 1000) {
                        val = 1000;
                    }
                    $('#node-input-overwriteExpire').val(val);
                }

                const autoTriggerTime = parseFloat($('#time-control-autoTriggerTime').val());
                if (isNaN(autoTriggerTime) || autoTriggerTime === '' || autoTriggerTime <= 0) {
                    $('#node-input-autoTriggerTime').val(20*60000);
                } else {
                    let val = autoTriggerTime * parseFloat($('#time-control-autoTriggerTime-multiplier').val());
                    if (val < 60000) {
                        val = 60000;
                    }
                    $('#node-input-autoTriggerTime').val(val);
                }

                const startDelayTime = parseFloat($('#time-control-startDelayTime').val());
                if (isNaN(startDelayTime) || startDelayTime === '' || startDelayTime <= 0) {
                    $('#node-input-startDelayTime').val(0);
                    $('#time-control-startDelayTime-multiplier').val(60000);
                } else {
                    let val = startDelayTime * parseFloat($('#time-control-startDelayTime-multiplier').val());
                    if (val < 0) {
                        val = 0;
                    }
                    $('#node-input-startDelayTime').val(val);
                }

                $('#dialog-edit-rule').dialog('destroy').remove();

                const results = $('#node-input-result-container').editableList('items');
                node.results = [];
                results.each(function (_i) {
                    const prop = $(this);
                    const p = {
                        p: prop.find('.node-input-prop-result-name').typedInput('value'),
                        pt: prop.find('.node-input-prop-result-name').typedInput('type'),
                        v: prop.find('.node-input-prop-result-value').typedInput('value'),
                        vt: prop.find('.node-input-prop-result-value').typedInput('type')
                    };
                    p.f = (p.fS !== 99 ? p.fS : p.fI);
                    if (p.p === 'payload' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgPayload';
                    } else if (p.p === 'topic' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgTopic';
                    } else if (p.p === 'value' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgValue';
                    }
                    node.results.push(p);
                });
            },
            oneditcancel() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditdelete() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditresize() {
                const height =  $('#node-config-clock-timer-tabs-content').parent().innerHeight();
                $('#node-config-clock-timer-tabs-content').height(height - 25);
            }
        });
    })();</script>

<script type="text/html" data-template-name="clock-timer">
    <div class="form-row">
        <ul style="min-width: 400px; margin-bottom: 20px;" id="node-config-clock-timer-tabs"></ul>
    </div>
    <div id="node-config-clock-timer-tabs-content" style="min-height:150px;overflow-y: auto;overflow-x: hidden;">
        <div id="clock-timer-tab-general" style="display:none">
            <div class="form-row block-noindent is-to-show-initially">
                <span><i class="fa fa-info-circle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.infoText" class="row-full-width"></span></span>
            </div>
            <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
                <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
                <input type="text" class="row-full-width" id="node-input-positionConfig">
            </div>
            <hr>
            <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
                <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
                <input type="text" id="node-input-name" class="row-full-width" data-i18n="[placeholder]node-red:common.label.name"/>
            </div>
            <div class="form-row block-noindent" data-i18n="[title]clock-timer.label.addId">
                <label for="node-input-addId"><i class="icon-tag"></i> <span data-i18n="clock-timer.label.addId"></span></label>
                <input type="text" id="node-input-addId" class="row-full-width" data-i18n="[placeholder]clock-timer.placeholder.addId"/>
                <input type="hidden" id="node-input-addIdType"/>
            </div>
            <div class="form-tips is-to-show-initially">
                <span data-i18n="[html]clock-timer.tips.documentation" style="word-wrap:break-word;"></span>
            </div>
        </div>
        <div id="clock-timer-tab-default" style="display:none">
            <!-- default ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.payloadDefault" class="row-full-width"></span>
            </div>
            <div class="form-row block-noindent is-to-show-initially" id="node-input-payloadDefault-div" data-i18n="[titleOrg]clock-timer.placeholder.payloadDefault">
                <label for="node-input-payloadDefault"><i class="fa fa-envelope"></i> <span data-i18n="clock-timer.label.payloadDefault"></span></label>
                <input type="text" id="node-input-payloadDefault" data-i18n="[placeholder]clock-timer.placeholder.payloadDefault">
                <input type="hidden" id="node-input-payloadDefaultType">
            </div>
            <div class="form-row block-indent1 is-initial-hidden rdgtimer-rule-row-payloadDefaultOffset" data-i18n="[title]clock-timer.placeholder.payloadDefaultOffset">
                <label for="node-input-payloadDefaultOffset"><i class="fa fa-calculator"></i> <span data-i18n="clock-timer.label.payloadDefaultOffset"></span></label>
                <input id="node-input-payloadDefaultOffset" data-i18n="[placeholder]clock-timer.placeholder.payloadDefaultOffset">
                <input type="hidden" id="node-input-payloadDefaultOffsetType">
                <select id="node-input-payloadDefaultOffsetMultiplier" class="node-input-multiplier"></select>
            </div>
            <div class="form-row block-indent1 is-initial-hidden rdgtimer-rule-row-payloadDefaultTimeFormat" data-i18n="[title]clock-timer.placeholder.payloadDefaultFormat">
                <label for="node-input-payloadDefaultTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="clock-timer.label.payloadDefaultFormat"></span></label>
                <select id="node-input-payloadDefaultTimeFormatsel">
                </select>
                <input type="text" id="node-input-payloadDefaultTimeFormat">
            </div>
            <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
                <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
                <input type="text" id="node-input-topic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
            </div>
            <hr>
            <!-- overwrite ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.overwriteTimer" class="row-full-width"></span></span>
            </div>
            <div class="form-row row-overwriteValue block-indent1" data-i18n="[titel]clock-timer.placeholder.overwriteExpire">
                <label for="time-control-overwriteExpire"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.overwriteExpire"></span></label>
                <input type="text" class="spinner-time" id="time-control-overwriteExpire" data-i18n="[placeholder]clock-timer.placeholder.overwriteExpire" value=""/>
                <select id="time-control-overwriteExpire-multiplier" class="node-input-multiplier">
                    <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                    <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                    <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                    <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
                </select>
                <input type="hidden" id="node-input-overwriteExpire"/>
            </div>
        </div>
        <div id="clock-timer-tab-time" style="display:none">
            <!-- time ######################################################################## -->
            <div class="is-to-show-initially">
                <span><i class="fa fa-list"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.time"></span></span>
                <div class="form-row node-input-rule-container-row row-full-width">
                    <ol id="node-input-rule-container"></ol>
                    <button type="button" id="node-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnAdd"></span></button> &nbsp;
                    <button type="button" id="node-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnClear"></span></button> &nbsp;
                    <button type="button" id="node-button-sort" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnSort" style="margin-top: 4px;"><i class="fa fa-sort-amount-asc"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnSort"></span></button>
                    <button type="button" id="node-button-export" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnExport" style="margin-top: 4px;"><i class="fa fa-files-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnExport"></span></button>
                    <button type="button" id="node-button-import" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnImport" style="margin-top: 4px;"><i class="fa fa-clipboard"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnImport"></span></button>
                </div>
            </div>
        </div>
        <div id="clock-timer-tab-output" style="display:none">
            <!-- Output ######################################################################## -->
            <div>
                <label for="node-input-result-container-row"><i class="fa fa-list"></i> <span data-i18n="clock-timer.label.resultContainer"></span></label>
                <div class="form-row node-input-result-container-row">
                    <ol id="node-input-result-container"></ol>
                </div>
            </div>
            <hr>
            <!-- Enhanced ######################################################################## -->
            <div class="form-row block-noindent">
                <span><i class="fa fa-cogs"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.enhanced"></span></span>
            </div>
            <div class="form-row block-noindent spinner-Small" data-i18n="[title]clock-timer.placeholder.autoTrigger">
                <label for="node-input-autoTrigger"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.autoTrigger"></span></label>
                <input type="checkbox" id="node-input-autoTrigger" style="width: auto;">
                <span id="time-control-autoTriggerTime-edit" class="is-initial-hidden">
                    <span data-i18n="clock-timer.label.autoTrigger2"></span>
                    <input type="text" class="spinner-time" id="time-control-autoTriggerTime" data-i18n="[placeholder]clock-timer.placeholder.autoTriggerTime" value=""/>
                    <select id="time-control-autoTriggerTime-multiplier" class="node-input-multiplier">
                        <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                        <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                        <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
                    </select>
                    <input type="hidden" id="node-input-autoTriggerTime"/>
                </span>
            </div>
            <div class="form-row block-noindent spinner-Small" data-i18n="[title]clock-timer.placeholder.startDelay2">
                <label for="node-input-startDelay"><i class="fa fa-hourglass-start"></i> <span data-i18n="clock-timer.label.startDelay"></span></label>
                <span id="time-control-startDelayTime-edit">
                    <input type="text" class="spinner-time" id="time-control-startDelayTime" data-i18n="[placeholder]clock-timer.placeholder.startDelay" value=""/>
                    <select id="time-control-startDelayTime-multiplier" class="node-input-multiplier">
                        <option value="1" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.0"></option>
                        <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                        <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                    </select>
                    <input type="hidden" id="node-input-startDelayTime"/>
                </span>
            </div>
            <div class="form-row">
                <label for="node-input-contextStore"><i class="icon-tag"></i> Context Store</label>
                <select id="node-input-contextStore">
                    <option value="">none</option>
                </select>
            </div>
            <div class="form-row block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.startDelayTime"></span></span>
            </div>
        </div>
    </div>
    <!-- End ######################################################################## -->

    <!-- DIALOG ######################################################################## -->
    <div id="dialog-select-context" class="red-ui-editor" title="Select Channel and Datapoint">
        <div id="config-lookup-tree"></div>
    </div>

    <div id="dialog-edit-rule" class="red-ui-editor" title="Edit Rule">
        <div class="dialog-row">
            <label for="dlg-ip-btctl-rule-name"><i class="fa fa-tag"></i> <span data-i18n="clock-timer.label.name"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-name" class="ipalone" data-i18n="[placeholder]clock-timer.placeholder.name">
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0 node-dialog-condition-container-row">
            <span><i class="fa fa-puzzle-piece"></i> <span id="dlg-ip-btctl-rule-condition-text"></span></span>
            <div class="dlg-ip-btctl-rule-condcontainer">
                <ol id="dlg-ip-btctl-rule-condition-container"></ol>
            </div>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-timeStartReg">
            <label for="dlg-ip-btctl-rule-timeStartReg"><i class="fa fa-clock-o"></i><i class="fa fa-hourglass-start"></i><span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeStart"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeStartReg" class="ipMain dlg-ip-btctl-rule-timeStartReg" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeStartReg">
            <label for="dlg-ip-btctl-rule-offset-timeStartReg"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeOffset"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeStartReg" class="ipMain dlg-ip-btctl-rule-offset-timeStartReg" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeStartReg" class="ipadd dlg-ip-btctl-rule-multiplier-timeStartReg" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeStartMin">
            <label for="dlg-ip-btctl-rule-timeStartMin"><i class="fa fa-step-backward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMin_start"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeStartMin" class="ipMain dlg-ip-btctl-rule-timeStartMin" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeStartMin">
            <label for="dlg-ip-btctl-rule-offset-timeStartMin"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMinOffset_start"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeStartMin" class="ipMain dlg-ip-btctl-rule-offset-timeStartMin" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeStartMin" class="ipadd dlg-ip-btctl-rule-multiplier-timeStartMin">
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeStartMax">
            <label for="dlg-ip-btctl-rule-timeStartMax"><i class="fa fa-step-forward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMax_start"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeStartMax" class="ipMain dlg-ip-btctl-rule-timeStartMax" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeStartMax">
            <label for="dlg-ip-btctl-rule-offset-timeStartMax"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMaxOffset_start"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeStartMax" class="ipMain dlg-ip-btctl-rule-offset-timeStartMax" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeStartMax" class="ipadd dlg-ip-btctl-rule-multiplier-timeStartMax">
            </select>
        </div>
        <div class="dialog-row pt-2" id="dialog-row-timeEndReg">
            <label for="dlg-ip-btctl-rule-timeEndReg"><i class="fa fa-clock-o"></i><i class="fa fa-hourglass-end"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeEnd"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeEndReg" class="ipMain dlg-ip-btctl-rule-timeEndReg" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-timeEndReg-offset">
            <label for="dlg-ip-btctl-rule-offset-timeEndReg"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeOffset"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeEndReg" class="ipMain dlg-ip-btctl-rule-offset-timeEndReg" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeEndReg" class="ipadd dlg-ip-btctl-rule-multiplier-timeEndReg" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeEndMin">
            <label for="dlg-ip-btctl-rule-timeEndMin"><i class="fa fa-step-backward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMin_end"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeEndMin" class="ipMain dlg-ip-btctl-rule-timeEndMin" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-timeEndMin-offset">
            <label for="dlg-ip-btctl-rule-offset-timeEndMin"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMinOffset_end"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeEndMin" class="ipMain dlg-ip-btctl-rule-offset-timeEndMin" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeEndMin" class="ipadd dlg-ip-btctl-rule-multiplier-timeEndMin">
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeEndMax">
            <label for="dlg-ip-btctl-rule-timeEndMax"><i class="fa fa-step-forward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMax_end"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeEndMax" class="ipMain dlg-ip-btctl-rule-timeEndMax" value="" data-i18n="[placeholder]clock-timer.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-timeEndMax-offset">
            <label for="dlg-ip-btctl-rule-offset-timeEndMax"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMaxOffset_end"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeEndMax" class="ipMain dlg-ip-btctl-rule-offset-timeEndMax" value="" data-i18n="[placeholder]clock-timer.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeEndMax" class="ipadd dlg-ip-btctl-rule-multiplier-timeEndMax">
            </select>
        </div>
        <div class="dialog-row dialog-row-timeLimits-ph is-to-show-initially pt-2" id="dialog-row-timeConstraintsPlaceholder">
            <div class="dlg-ip-btctl-rule-timecontraintctrl" id="dialog-row-timeConstraints-show">
                <button class="dialog-element-clickable" data-i18n="clock-timer.label.timeconstraintshow"></button>
            </div>
        </div>
        <div class="dialog-row dialog-row-timeLimits is-initial-hidden pt-2" id="dialog-row-timeConstraints">
            <div class="dlg-ip-btctl-rule-timecontraintctrl" id="dialog-row-timeConstraints-hide">
                <button class="dialog-element-clickable" data-i18n="clock-timer.label.timeconstrainthide"></button>
            </div>
            <div id="dlg-ip-btctl-rule-timeDays" class="dlg-ip-btctl-rule-days"  data-i18n="[title]clock-timer.placeholder.ruleTimeDays">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDays"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                    </div>
                </div>
            </div>
            <div class="dlg-ip-btctl-rule-limits" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.specialLimits"></div>
                <div style="display:inline-block;">
                    <div>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyEvenDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenDays"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyOddDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddDays"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyEvenWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyOddWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks"></span></label>
                    </div>
                </div>
            </div>
            <div id="dlg-ip-btctl-rule-timeMonths" class="dlg-ip-btctl-rule-months" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForMonths"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                    </div>
                </div>
            </div>

            <div id="dlg-ip-btctl-rule-timeDateLimit" class="dlg-ip-btctl-rule-datelimit" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;"><i class="fa fa-calendar-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDates"></span></div>
                <div style="display:inline-block;">
                    <input type="date" id="dlg-ip-btctl-rule-timedatelimit-start" class="ipMain dlg-ip-btctl-rule-timedatelimit" value="" data-i18n="[placeholder]clock-timer.placeholder.start" min="2000-01-01" max="2000-12-31"/>
                    <input type="date" id="dlg-ip-btctl-rule-timedatelimit-end" class="ipMain dlg-ip-btctl-rule-timedatelimit" value="" data-i18n="[placeholder]clock-timer.placeholder.end" min="2000-01-01" max="2000-12-31"/>
                </div>
            </div>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-payload" data-i18n="[titleOrg]clock-timer.placeholder.payloadDefault">
            <label for="dlg-ip-btctl-rule-payload"><i class="fa fa-envelope"></i> <span data-i18n="clock-timer.label.payloadDefault"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-payload" class="ipMain" data-i18n="[placeholder]clock-timer.placeholder.payloadDefault">
            <input type="hidden" id="dlg-ip-btctl-rule-payloadType">
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-payloadOffset" data-i18n="[title]clock-timer.placeholder.payloadDefaultOffset">
            <label for="dlg-ip-btctl-rule-payloadOffset"><i class="fa fa-calculator"></i> <span data-i18n="clock-timer.label.payloadDefaultOffset"></span></label>
            <input id="dlg-ip-btctl-rule-payloadOffset" data-i18n="[placeholder]clock-timer.placeholder.payloadDefaultOffset"/>
            <input type="hidden" id="dlg-ip-btctl-rule-payloadOffsetType">
            <select id="dlg-ip-btctl-rule-payloadOffsetMultiplier" class="node-input-multiplier ipadd"></select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-payloadTimeFormat" data-i18n="[title]clock-timer.placeholder.payloadDefaultFormat">
            <label for="dlg-ip-btctl-rule-payloadTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="clock-timer.label.payloadDefaultFormat"></span></label>
            <select id="dlg-ip-btctl-rule-payloadTimeFormatsel" class="ipMain">
            </select>
            <input type="text" id="dlg-ip-btctl-rule-payloadTimeFormat" class="ipadd" />
        </div>
        <div class="dialog-row pt-0" id="dialog-row-topic" data-i18n="[title]clock-timer.placeholder.ruleTopic">
            <label for="dlg-ip-btctl-rule-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-topic" class="ipalone" data-i18n="[placeholder]node-red:common.label.topic"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0" id="dialog-hr-overwrite">
        <div class="dialog-row pt-0" id="dialog-row-exec" data-i18n="[title]clock-timer.placeholder.exec">
            <label for="dlg-ip-btctl-rule-exec"><i class="fa fa-sort"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleExec"></span></label>
            <select  id="dlg-ip-btctl-rule-exec" class="ipalone dlg-ip-btctl-rule-exec" >
            </select>
        </div>
        <div class="dialog-row pt-0" id="dialog-row-resetOverwrite" data-i18n="[title]clock-timer.placeholder.ruleResetOverwrite">
            <label for="dlg-ip-btctl-rule-resetOverwrite"><i class="fa fa-thumbs-o-down"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleOverwrite"></span></label>
            <input type="checkbox" id="dlg-ip-btctl-rule-resetOverwrite" style="width: auto;"/>
            <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleResetOverwrite"></span>
        </div>
        <div class="dialog-row pt-0 is-initial-hidden" id="dialog-row-importance" data-i18n="[title]clock-timer.placeholder.ruleImportance">
            <label for="dlg-ip-btctl-rule-importance"><i class="fa fa-hand-spock-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-importance" class="ipMain" data-i18n="[placeholder]clock-timer.placeholder.ruleImportance"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-descr">
            <label for="dlg-txt-btctl-rule-descr" class="pb-1"><i class="fa fa-commenting-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleDescription" ></span></label>
            <div id="dlg-txt-btctl-rule-descr" class="pl-3" style="word-wrap:break-word;"></div>
        </div>
    </div>
</script>
<style>
    hr { width: 100% }
    .mt-0 { margin-top:0 !important; }
    .mb-0 { margin-bottom:0 !important; }
    .mt-1 { margin-top:0.5rem !important; }
    .mb-1 { margin-bottom:0.5rem !important; }
    .pt-0 { padding-top:0 !important; }
    .pb-0 { padding-bottom:0 !important; }
    .pl-0 { padding-left:0 !important; }
    .pr-0 { padding-right:0 !important; }
    .pt-1 { padding-top:0.5rem !important; }
    .pb-1 { padding-bottom:0.5rem !important; }
    .pl-1 { padding-left:0.5rem !important; }
    .pr-1 { padding-right:0.5rem !important; }
    .pt-2 { padding-top:1.0rem !important; }
    .pb-2 { padding-bottom:1.0rem !important; }
    .pl-2 { padding-left:1.0rem !important; }
    .pr-2 { padding-right:1.0rem !important; }
    .pt-3 { padding-top:1.25rem !important; }
    .pb-3 { padding-bottom:1.25rem !important; }
    .pl-3 { padding-left:1.25rem !important; }
    .pr-3 { padding-right:1.25rem !important; }
    .is-to-show-initially { display:none }
    .is-initial-hidden { display:none }
    .form-tips { width: 90% }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .block-indent1-noadd {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .input-error {
        border-color: #d6615f !important;
        background-color: #ffcccc !important;
        color: #555 !important;
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-indent2-noadd {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .spinner-Small .ui-spinner {
        width : 100px !important;
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .block-noindent-noadd .ui-spinner {
        width : calc(100% - 110px);
    }
    .block-indent1-noadd .ui-spinner {
        width : calc(100% - 120px);
    }
    .block-indent2-noadd .ui-spinner {
        width : calc(100% - 130px);
    }
    .indent-time-text {
        /* text-indent:10px; */
        padding-left: 20px;
    }
    .indent-enh-text {
        padding-left: 10px;
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .ui-spinner input {
        border: none !important;
        width: 95% !important;
    }

    .dialog-row {
        clear: both;
        color: #555;
        margin-bottom: 5px;
    }
    .ui-dialog-rdg .ui-dialog-content-rdg {
        padding: 10px 20px 10px 20px !important;
        width: 94% !important;
    }
    .dialog-row label {
        display: inline-block;
        /* width: 9rem; */
        width: 25%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 label {
        /* width: 11rem; */
        width: 23%;
    }
    .dialog-row.block-indent2 label {
        /* width: 13rem; */
        width: 22%;
    }

    .dialog-row .ipalone {
        /* width: calc(90% - 9rem); */
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipMain {
        /* width: calc(60% - 9rem); */
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipadd {
        /* width: calc(20% - 9rem);*/
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ui-spinner {
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-element-clickable {
        user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        cursor: pointer;
        touch-action: manipulation;
        display: inline-block;
        /* background: transparent; */
        /* border: 0; */
        vertical-align:top;
        margin-right:5px;
    }
    .dlg-ip-btctl-rule-condcontainer {
        margin-left: 25%;
    }
    .dlg-ip-btctl-rule-timecontraintctrl,
    .dlg-ip-btctl-rule-days,
    .dlg-ip-btctl-rule-limits,
    .dlg-ip-btctl-rule-months,
    .dlg-ip-btctl-rule-datelimit {
        margin-top: 5px;
        margin-left: 30%;
    }
    .dlg-ip-btctl-rule-days label,
    .dlg-ip-btctl-rule-months label {
        max-width: 55px;
    }
    .dlg-ip-btctl-rule-days label,
    .dlg-ip-btctl-rule-limits label,
    .dlg-ip-btctl-rule-months label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 110px !important;
    }
    .dlg-ip-btctl-rule-days input,
    .dlg-ip-btctl-rule-limits input,
    .dlg-ip-btctl-rule-months input,
    .dlg-ip-btctl-rule-datelimit input {
        width: auto;
        vertical-align: baseline;
    }
    .dlg-ip-btctl-rule-timedatelimit {
        min-width: 140px;
    }
    .rdgtimer-rule-mainblock {
        margin-right: 16px; /*28px;*/
    }
    .rdgtimer-rule-name-span {
        width: 25%; /* width: 120px; */
        float: left;
    }
    .rdgtimer-rule-exec-span {
        margin-right: 5px;
        float: left;
        box-shadow: 1px 1px 1px 1px rgb(0 0 0 / 20%);
    }
    .rdgtimer-rule-description-span {
        font-size: 10px;
        margin-left: 30%;
        margin-right: 5px;
    }
    .rdgtimer-rule-finalspan {
        top: 50%;
        position: absolute;
        right: 28px;
        margin-top: -9px;
    }
    .rdgtimer-rule-ctrl-div {
        display: none;
        /* top: 50%; */
        /* position: absolute; */
        /* right: 66px; */
        /* margin-top: -9px; */
        /* float: left; */
    }
    .rdgtimer-rule-row:hover .rdgtimer-rule-ctrl-div {
        display: block;
    }
    .rule-disabled {
        color: lightgrey;
    }
    .rdgtimer-rule-editBtn,
    .rdgtimer-rule-duplicateBtn,
    .rdgtimer-rule-stateBtn {
        position: absolute;
        margin-top: -9px !important;
        top: 50%;
    }
    .rdgtimer-rule-editBtn {
        right: 88px;
    }
    .rdgtimer-rule-duplicateBtn {
        right: 28px;
    }
    .rdgtimer-rule-stateBtn {
        right: 58px;
    }
</style>