<!DOCTYPE HTML>
<!--
This code is licensed under the Apache License Version 2.0.

Copyright (c) 2022 Robert Gester

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

-->

<script type="text/javascript">
    (function() {
        // category: 'time and astro',
        RED.nodes.registerType('within-time-switch', {
            category: 'common',
            color: '#f37a33',
            icon: 'time-switch-white.svg',
            inputs: 1,
            outputs: 2,
            defaults: {
                name: {
                    value: '',
                    required: false
                },
                nameInt: {
                    value: '',
                    required: false
                },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                startTime: {
                    value: '',
                    required: true,
                    validate: RED.validators.typedInput('startTimeType')
                },
                startTimeType: {
                    value: 'entered'
                },
                startOffset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.startOffsetType === 'undefined') ||
                            RED.validators.typedInput('startOffsetType')(v)
                        );
                    }
                },
                startOffsetType: {
                    value: 'none'
                },
                startOffsetMultiplier: {
                    value: 60000,
                    required: true,
                    validate: RED.validators.number()
                },
                endTime: {
                    value: '',
                    required: true,
                    validate: RED.validators.typedInput('endTimeType')
                },
                endTimeType: {
                    value: 'entered'
                },
                endOffset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.endOffsetType === 'undefined') ||
                            RED.validators.typedInput('endOffsetType')(v)
                        );
                    }
                },
                endOffsetType: {
                    value: 'none'
                },
                endOffsetMultiplier: {
                    value: 60000,
                    required: true,
                    validate: RED.validators.number()
                },
                timeRestrictions: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.timeRestrictionsType === 'undefined') ||
                            RED.validators.typedInput('timeRestrictionsType')(v)
                        );
                    }
                },
                timeRestrictionsType: {
                    value: 'none'
                },
                timeDays: {
                    value: '*',
                    required: true
                },
                timeOnlyOddDays: {
                    value: false,
                    required: true
                },
                timeOnlyEvenDays: {
                    value: false,
                    required: true
                },
                timeOnlyOddWeeks: {
                    value: false,
                    required: true
                },
                timeOnlyEvenWeeks: {
                    value: false,
                    required: true
                },
                timeMonths: {
                    value: '*',
                    required: true
                },
                timedatestart: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.regex(/^$|^\d{4}-\d{1,2}-\d{1,2}$|^\d{2}-\d{1,2}-\d{1,2}$/)(v)
                        );
                    }
                },
                timedateend: {
                    value: '',
                    required: false,
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.regex(/^$|^\d{4}-\d{1,2}-\d{1,2}$|^\d{2}-\d{1,2}-\d{1,2}$/)(v)
                        );
                    }
                },
                propertyStart: {
                    value: '',
                    required: false,
                    validate: RED.validators.typedInput('propertyStartType')
                },
                propertyStartType: {
                    value: 'none'
                },
                propertyStartCompare: {
                    value: 'true'
                },
                propertyStartThreshold: {
                    value: '',
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.typedInput('propertyStartThresholdType')(v) ||
                            ($('#node-input-startTimeAltType').length ?
                                $('#node-input-startTimeAlt').typedInput('type') === 'none' :
                                this.startTimeAlt === 'none') ||
                            typeof this.propertyStartType === 'undefined' ||
                            ($('#node-input-propertyStartType').length ?
                                $('#node-input-propertyStart').typedInput('type') === 'none' :
                                this.propertyStartType === 'none')
                        );
                    }
                },
                propertyStartThresholdType: {
                    value: 'num'
                },
                startTimeAlt: {
                    value: '',
                    required: false,
                    validate(v) {
                        return RED.validators.typedInput('startTimeAltType')(v) || ($(
                            '#node-input-propertyStart').typedInput(
                            'type') === 'none');
                    }
                },
                startTimeAltType: {
                    value: 'entered'
                },
                startOffsetAlt: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.startOffsetAltType === 'undefined') ||
                            RED.validators.typedInput('startOffsetAltType')(v) ||
                            ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                            ($('#node-input-startTimeAlt').typedInput('type') === 'none')
                        );
                    }
                },
                startOffsetAltType: {
                    value: 'none'
                },
                startOffsetAltMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v) {
                        return RED.validators.number()(v) ||
                        ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                        ($('#node-input-startTimeAlt').typedInput('type') === 'none');
                    }
                },
                propertyEnd: {
                    value: '',
                    required: false,
                    validate: RED.validators.typedInput('propertyEndType')
                },
                propertyEndType: {
                    value: 'none'
                },
                propertyEndCompare: {
                    value: 'true'
                },
                propertyEndThreshold: {
                    value: '',
                    validate(v) {
                        return (
                            typeof v === 'undefined' ||
                            RED.validators.typedInput('propertyEndThresholdType')(v) ||
                            ($('#node-input-startTimeAltType').length ?
                                $('#node-input-startTimeAlt').typedInput('type') === 'none' :
                                this.startTimeAlt === 'none') ||
                            typeof this.propertyEndType === 'undefined' ||
                            ($('#node-input-propertyEndType').length ?
                                $('#node-input-propertyEnd').typedInput('type') === 'none' :
                                this.propertyEndType === 'none')
                        );
                    }
                },
                propertyEndThresholdType: {
                    value: 'num'
                },
                endTimeAlt: {
                    value: '',
                    required: false,
                    validate(v) {
                        return RED.validators.typedInput('endTimeAltType')(v) || ($('#node-input-propertyEnd').typedInput(
                            'type') === 'none');
                    }
                },
                endTimeAltType: {
                    value: 'entered'
                },
                endOffsetAlt: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.startOffsetAltType === 'undefined') ||
                            RED.validators.typedInput('startOffsetAltType')(v) ||
                            ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                            ($('#node-input-endTimeAlt').typedInput('type') === 'none')
                        );
                    }
                },
                endOffsetAltType: {
                    value: 'none'
                },
                endOffsetAltMultiplier: {
                    value: 60000,
                    required: true,
                    validate(v) {
                        return RED.validators.number()(v) ||
                        ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                        ($('#node-input-endTimeAlt').typedInput('type') === 'none');
                    }
                },
                withinTimeValue: {
                    value: 'true',
                    required: false,
                    validate: RED.validators.typedInput('withinTimeValueType')
                },
                withinTimeValueType: {
                    value: 'msgInput',
                    required: true
                },
                outOfTimeValue: {
                    value: 'false',
                    required: false,
                    validate: RED.validators.typedInput('outOfTimeValueType')
                },
                outOfTimeValueType: {
                    value: 'msgInput',
                    required: true
                },
                tsCompare: {
                    value: '0'
                }
            },
            outputLabels: ['within time', 'out of time'],
            label() {
                const getConcatId = (type1, value1, offset1Type, offset1, multipier1, property, type2, value2, offset2Type, offset2, multipier2) => {
                    if (property !== 'none' && property !== '' && value2) {
                        return  RED.nodes.getType('position-config').getRDGNodeValLbl(this, type1, value1, offset1Type, offset1, multipier1, 12) + '/' +
                                RED.nodes.getType('position-config').getRDGNodeValLbl(this, type2, value2, offset2Type, offset2, multipier2, 12);
                    }
                    return RED.nodes.getType('position-config').getRDGNodeValLbl(this, type1, value1, offset1Type, offset1, multipier1, 12);
                };

                if (this.name) {
                    return this.name;
                }

                if (this.startTime && this.endTime) {
                    return getConcatId(this.startTimeType, this.startTime, this.startOffsetType, this.startOffset, this.startOffsetMultiplier,
                        this.propertyStartType,
                        this.startTimeAltType, this.startTimeAlt, this.startOffsetAltType, this.startOffsetAlt, this.startOffsetAltMultiplier) +
                            ' - ' +
                            getConcatId(this.endTimeType, this.endTime, this.endOffsetType, this.endOffset, this.endOffsetMultiplier,
                                this.propertyEndType,
                                this.endTimeAltType, this.endTimeAlt, this.endOffsetAltType, this.endOffsetAlt, this.endOffsetAltMultiplier);
                }

                return 'within-time';
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            inputLabels() {
                return this._('node-red-contrib-sun-position/position-config:common.label.inputPort');
            },
            paletteLabel: 'within-time',
            align: 'left',
            oneditprepare() {
                setTimeout(() => {
                    $('.is-to-show-initially').show();
                    $('.is-to-hide-initially').hide();
                }, 300);

                $('.enhanced-row-toggle').on('click', () => {
                    $('.enhanced-row').toggle(); // .hide();
                });

                const node = this;
                const $nodeConfig = $('#node-input-positionConfig');
                const setup = function(node) {
                    /* global getTypes getSelectFields appendOptions setupTInput initializeValue initCheckboxesBlock getCheckboxesStr getBackendData bdDateToTime */

                    const types = getTypes(node, () => $nodeConfig.val());
                    const selFields = getSelectFields();
                    let onInit = true;
                    // #region initialize
                    /**
                    * update multiplier settings from a previous version
                    * @param {number} mp - the multiplier value
                    * @param {string} name - the name of the element
                    * @param {function} onchange - the function to be called on field change
                    * @returns {number} the updated multiplier value
                    */
                    function multiplierUpdate(mp, name, onchange) {
                        const $field = $('#node-input-' + name);
                        appendOptions(node, $field, 'multiplier', data => (data.id > 0));
                        if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                            mp = 60000;
                        } else {
                            mp = parseFloat(mp);
                            if (mp === 1) {
                                mp = 1000;
                            } else if (mp === 60) {
                                mp = 60000;
                            } else if (mp === 3600) {
                                mp = 3600000;
                            }
                        }
                        $field.val(mp);
                        $field.on('change', onchange);
                        return mp;
                    }
                    // #endregion initialize
                    // #region timeStart
                    if ($('#node-input-timeOnlyOddDays').prop('checked') && $('#node-input-timeOnlyEvenDays').prop('checked') ) {
                        $('#node-input-timeOnlyOddDays').prop('checked',false);
                        $('#node-input-timeOnlyEvenDays').prop('checked',false);
                    }
                    if ($('#node-input-timeOnlyOddWeeks').prop('checked') && $('#node-input-timeOnlyEvenWeeks').prop('checked') ) {
                        $('#node-input-timeOnlyOddWeeks').prop('checked',false);
                        $('#node-input-timeOnlyEvenWeeks').prop('checked',false);
                    }
                    initializeValue(node, 'timeDays', '*');
                    initializeValue(node, 'timeMonths', '*');
                    initCheckboxesBlock('#within-time-switch-timeDays', node.timeDays);
                    initCheckboxesBlock('#within-time-switch-timeMonths', node.timeMonths);
                    setupTInput(node, {
                        typeProp: 'startTimeType',
                        valueProp: 'startTime',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onFocus(_type, _value) {
                            const plVType = $('#node-input-startTime').typedInput('type');
                            const plVTypeAlt = $('#node-input-startTimeAlt').typedInput('type');
                            if (plVType ===  'msg' ||
                                plVType === 'flow' ||
                                plVType === 'global' ||
                                plVTypeAlt === 'msg' ||
                                plVTypeAlt === 'flow' ||
                                plVTypeAlt === 'global') {
                                $('.msg-start-out-row').hide();
                            } else {
                                $('.msg-start-out-row').show();
                            }
                        },
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            getBackendData(d => {
                                const $div = $('#node-input-startTime-div');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           $('#node-input-startTime').typedInput('type'),
                                value:          $('#node-input-startTime').typedInput('value'),
                                offsetType:     $('#node-input-startOffset').typedInput('type'),
                                offset:         $('#node-input-startOffset').typedInput('value'),
                                multiplier:     $('#node-input-startOffsetMultiplier').val(),
                                noOffsetError:  true
                            });
                        }
                    });

                    node.startOffsetMultiplier = multiplierUpdate(node.startOffsetMultiplier, 'startOffsetMultiplier', () => $('#node-input-startTime').change());
                    setupTInput(node, {
                        typeProp: 'startOffsetType',
                        valueProp: 'startOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.startOffset === 0 || node.startOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            const type = $('#node-input-startOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-startOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-startOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-startTime').change();
                        }
                    });

                    const $timeRestrictions = setupTInput(node, {
                        typeProp: 'timeRestrictionsType',
                        valueProp: 'timeRestrictions',
                        width: 'calc(100% - 255px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [
                            {
                                value: types.Undefined.value,
                                label: node._('within-time-switch.label.internally'),
                                hasValue: false
                            }, 'msg', 'flow', 'global', 'env', 'json', 'jsonata'],
                        onChange(_type, _value) {
                            const type = $timeRestrictions.typedInput('type');
                            if (type === types.Undefined.value) {
                                $('.node-input-row-timeLimits').show();
                            } else {
                                $('.node-input-row-timeLimits').hide();
                            }
                        }
                    });

                    const getDateShort = value => {
                        if (value) {
                            const val = value.split('-');
                            if (val.length > 2) {
                                return val[1] + '-' + val[2];
                            } else if (val.length === 2) {
                                return val[0] + '-' + val[1];
                            }
                        }
                        return '';
                    };
                    const $timeLimitDateStart = $('#node-input-timedatestart');
                    const $timeLimitDateEnd = $('#node-input-timedateend');
                    $timeLimitDateStart.change(() => {
                        const year = (new Date()).getFullYear();
                        $timeLimitDateEnd.attr('min', year + '-' + (getDateShort($timeLimitDateStart.val() || '01-01')));
                        $timeLimitDateEnd.attr('max', (year + 1) + '-' + (getDateShort($timeLimitDateStart.val()) || '12-31'));
                    });
                    $timeLimitDateEnd.change(() => {
                        const year = (new Date()).getFullYear();
                        $timeLimitDateStart.attr('min', year + '-01-01');
                        $timeLimitDateStart.attr('max', $timeLimitDateEnd.val() || (year + '-12-31'));
                    });

                    const year = (new Date()).getFullYear();
                    if (node.timedatestart) {
                        $timeLimitDateStart.val(year + '-' +(getDateShort(node.timedatestart) || '01-01'));
                    }
                    if (node.timedatestart && node.timedateend) {
                        const year = (new Date()).getFullYear();
                        const d1 = new Date(node.timedatestart);
                        const d2 = new Date(node.timedateend);
                        d1.setFullYear(year);
                        d2.setFullYear(year);
                        if (d2.getTime() < d1.getTime()) {
                            d2.setFullYear(year + 1);
                        }
                        const pad = (n, z = 2) => ('00' + n).slice(-z);
                        $timeLimitDateEnd.val(year + '-' + pad(d2.getMonth() + 1) + '-' + pad(d2.getDate()));
                    } else if (node.timedateend) {
                        $timeLimitDateEnd.val(year + '-' + (getDateShort(node.timedateend) || '12-31'));
                    }
                    $timeLimitDateStart.change();
                    $timeLimitDateEnd.change();
                    $timeRestrictions.change();
                    // #endregion timeStart
                    // #region timeEnd
                    setupTInput(node, {
                        typeProp: 'endTimeType',
                        valueProp: 'endTime',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onFocus(_type, _value) {
                            const plVType = $('#node-input-endTime').typedInput('type');
                            const plVTypeAlt = $('#node-input-endTimeAlt').typedInput('type');
                            if (plVType ===  'msg' ||
                                plVType === 'flow' ||
                                plVType === 'global' ||
                                plVTypeAlt === 'msg' ||
                                plVTypeAlt === 'flow' ||
                                plVTypeAlt === 'global') {
                                $('.msg-end-out-row').hide();
                            } else {
                                $('.msg-end-out-row').show();
                            }
                        },
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            getBackendData(d => {
                                const $div = $('#node-input-endTime-div');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           $('#node-input-endTime').typedInput('type'),
                                value:          $('#node-input-endTime').typedInput('value'),
                                offsetType:     $('#node-input-endOffset').typedInput('type'),
                                offset:         $('#node-input-endOffset').typedInput('value'),
                                multiplier:     $('#node-input-endOffsetMultiplier').val(),
                                noOffsetError:  true
                            });
                        }
                    });

                    node.endOffsetMultiplier = multiplierUpdate(node.endOffsetMultiplier, 'endOffsetMultiplier', () => $('#node-input-endTime').change());
                    setupTInput(node, {
                        typeProp: 'endOffsetType',
                        valueProp: 'endOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.endOffset === 0 || node.endOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            const type = $('#node-input-endOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-endOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-endOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-endTime').change();
                        }
                    });
                    // #endregion timeEnd
                    // #region propertyStart
                    const $propertyStart = setupTInput(node, {
                        typeProp: 'propertyStartType',
                        valueProp: 'propertyStart',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '' ,
                        types: [types.Undefined,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.MsgPayloadByTopic,
                            types.PhaseMoon,
                            types.SunInSky,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ],
                        onChange(_type, _value) {
                            if (onInit) { return; }
                            const propCompare = $('#node-input-propertyStartCompare');
                            const propType = $('#node-input-propertyStart').typedInput('type');
                            if (propType === 'none') {
                                $('.alternate-time-start').hide();
                                $('.alternate-time-start-offset').hide();
                                propCompare.hide();
                                $('.row-propertyStartThreshold').hide();
                                $('#node-input-propertyStart').typedInput('width', 'calc(100% - 110px)');
                            } else if (propType === 'jsonata' ||
                                       propType === types.PhaseMoon.value ||
                                       propType === types.MsgPayloadByTopic.value) {
                                $('.alternate-time-start').show();
                                propCompare.show();
                                propCompare.attr('disabled', true);
                                propCompare.val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-propertyStartThreshold').hide();
                                $('#node-input-propertyStart').typedInput('width', 'calc(100% - 220px)');
                            } else {
                                $('.alternate-time-start').show();
                                propCompare.show();
                                propCompare.attr('disabled', false);
                                $('#node-input-propertyStart').typedInput('width', 'calc(100% - 220px)');
                                const condOp = propCompare.val();
                                let operandCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operandCount = el.operandCount;
                                        break;
                                    }
                                }
                                if (operandCount > 1) {
                                    $('.row-propertyStartThreshold').show(); // condOpB
                                } else {
                                    $('.row-propertyStartThreshold').hide(); // condOpB
                                }
                            }
                            $('#node-input-startTimeAlt').change();
                            $('#node-input-propertyStartThreshold').change();
                        }
                    });
                    const $propertyStartCompare = $('#node-input-propertyStartCompare');
                    appendOptions(node, $propertyStartCompare, 'comparator');
                    $propertyStartCompare.val(node.propertyStartCompare || 'true');
                    $propertyStartCompare.change(() => { $('#node-input-propertyStart').change(); });
                    setupTInput(node, {
                        typeProp: 'propertyStartThresholdType',
                        valueProp: 'propertyStartThreshold',
                        width: 'calc(100% - 130px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['msg', 'flow', 'global', 'str', 'num', 'env']
                    });
                    // #endregion propertyStart
                    // #region timeAltStart
                    setupTInput(node, {
                        typeProp: 'startTimeAltType',
                        valueProp: 'startTimeAlt',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onFocus(_type, _value) {
                            if (($('#node-input-startTimeAlt').typedInput('type') === 'none') ||
                                ($('#node-input-propertyStart').typedInput('type') === 'none')) {
                                $('.alternate-time-start-offset').hide();
                            } else {
                                $('.alternate-time-start-offset').show();
                            }
                        },
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            getBackendData(d => {
                                const $div = $('#node-input-startTimeAlt-div');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           $('#node-input-startTimeAlt').typedInput('type'),
                                value:          $('#node-input-startTimeAlt').typedInput('value'),
                                offsetType:     $('#node-input-startOffsetAlt').typedInput('type'),
                                offset:         $('#node-input-startOffsetAlt').typedInput('value'),
                                multiplier:     $('#node-input-startOffsetAltMultiplier').val(),
                                noOffsetError:  true
                            });
                        }
                    });

                    node.startOffsetAltMultiplier = multiplierUpdate(node.startOffsetAltMultiplier, 'startOffsetAltMultiplier', () => $('#node-input-startTimeAlt').change());
                    setupTInput(node, {
                        typeProp: 'startOffsetAltType',
                        valueProp: 'startOffsetAlt',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.startOffsetAlt === 0 || node.startOffsetAlt === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            const type = $('#node-input-startOffsetAlt').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-startOffsetAltMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-startOffsetAltMultiplier').prop('disabled', false);
                            }
                            $('#node-input-startTimeAlt').change();
                        }
                    });
                    // #endregion timeAltStart
                    // #region propertyEnd
                    const $propertyEnd = setupTInput(node, {
                        typeProp: 'propertyEndType',
                        valueProp: 'propertyEnd',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '' ,
                        types: [types.Undefined,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.MsgPayloadByTopic,
                            types.PhaseMoon,
                            types.SunInSky,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ],
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            const propCompare = $('#node-input-propertyEndCompare');
                            const propType = $('#node-input-propertyEnd').typedInput('type');

                            if (propType === 'none') {
                                $('.alternate-time-end').hide();
                                $('.alternate-time-end-offset').hide();
                                propCompare.hide();
                                $('.row-propertyEndThreshold').hide();
                                $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 110px)');
                            } else if (propType === 'jsonata' ||
                                       propType === types.PhaseMoon.value ||
                                       propType === types.MsgPayloadByTopic.value) {
                                $('.alternate-time-end').show();
                                propCompare.show();
                                propCompare.attr('disabled', true);
                                propCompare.val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('.row-propertyEndThreshold').hide();
                                $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 220px)');
                            } else {
                                $('.alternate-time-end').show();
                                propCompare.show();
                                propCompare.attr('disabled', false);
                                $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 220px)');
                                const condOp = propCompare.val();
                                let operandCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operandCount = el.operandCount;
                                        break;
                                    }
                                }
                                if (operandCount > 1) {
                                    $('.row-propertyEndThreshold').show(); // condOpB
                                } else {
                                    $('.row-propertyEndThreshold').hide(); // condOpB
                                }
                            }
                            $('#node-input-endTimeAlt').change();
                            $('#node-input-propertyEndThreshold').change();
                        }
                    });
                    const $propertyEndCompare = $('#node-input-propertyEndCompare');
                    appendOptions(node, $propertyEndCompare, 'comparator');
                    $propertyEndCompare.val(node.propertyEndCompare || 'true');
                    $propertyEndCompare.change(() => { $('#node-input-propertyEnd').change(); });
                    setupTInput(node, {
                        typeProp: 'propertyEndThresholdType',
                        valueProp: 'propertyEndThreshold',
                        width: 'calc(100% - 130px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['msg', 'flow', 'global', 'str', 'num', 'env']
                    });
                    // #endregion propertyEnd
                    // #region timeAltEnd
                    setupTInput(node, {
                        typeProp: 'endTimeAltType',
                        valueProp: 'endTimeAlt',
                        width: 'calc(100% - 110px)',
                        defaultType: types.TimeEntered.value,
                        defaultValue: '',
                        types: [
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeSunCustom,
                            types.TimeSunNow,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet
                        ],
                        onFocus(_type, _value) {
                            if (($('#node-input-endTimeAlt').typedInput('type') === 'none') ||
                                ($('#node-input-propertyEnd').typedInput('type') === 'none')) {
                                $('.alternate-time-end-offset').hide();
                            } else {
                                $('.alternate-time-end-offset').show();
                            }
                        },
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            getBackendData(d => {
                                const $div = $('#node-input-endTimeAlt-div');
                                const titleOrg = $div.attr('titleOrg');
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           $('#node-input-endTimeAlt').typedInput('type'),
                                value:          $('#node-input-endTimeAlt').typedInput('value'),
                                offsetType:     $('#node-input-endOffsetAlt').typedInput('type'),
                                offset:         $('#node-input-endOffsetAlt').typedInput('value'),
                                multiplier:     $('#node-input-endOffsetAltMultiplier').val(),
                                noOffsetError:  true
                            });
                        }
                    });

                    node.endOffsetAltMultiplier = multiplierUpdate(node.endOffsetAltMultiplier, 'endOffsetAltMultiplier', () => $('#node-input-endTimeAlt').change());
                    setupTInput(node, {
                        typeProp: 'endOffsetAltType',
                        valueProp: 'endOffsetAlt',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.endOffsetAlt === 0 || node.endOffsetAlt === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env', types.randomNumber, types.randmNumCachedDay, types.randmNumCachedWeek],
                        onChange(_type, _value) {
                            if ( onInit) { return; }
                            const type = $('#node-input-endOffsetAlt').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-endOffsetAltMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-endOffsetAltMultiplier').prop('disabled', false);
                            }
                            $('#node-input-endTimeAlt').change();
                        }
                    });
                    // #endregion timeAltEnd
                    // #region Output Values
                    if (node.withinTimeValueType === 'input') {
                        node.withinTimeValueType = types.MsgInput.value;
                    }
                    setupTInput(node, {
                        typeProp: 'withinTimeValueType',
                        valueProp: 'withinTimeValue',
                        width: 'calc(100% - 110px)',
                        defaultType: types.MsgInput.value,
                        defaultValue: node.withinTimeValue,
                        types: [
                            types.MsgInput,
                            'str',
                            'num',
                            'bool',
                            'date',
                            'json',
                            'bin',
                            'env',
                            'msg',
                            'flow',
                            'global',
                            'jsonata',
                            types.numPercent,
                            types.randomNumber,
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek,
                            types.strPlaceholder,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationObj,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven,
                            types.nodeId,
                            types.nodeName,
                            types.nodePath
                        ]
                    });
                    if (node.outOfTimeValueType === 'input') {
                        node.outOfTimeValueType = types.MsgInput.value;
                    }
                    setupTInput(node, {
                        typeProp: 'outOfTimeValueType',
                        valueProp: 'outOfTimeValue',
                        width: 'calc(100% - 110px)',
                        defaultType: types.MsgInput.value,
                        defaultValue: node.outOfTimeValue,
                        types: [
                            types.MsgInput,
                            'str',
                            'num',
                            'bool',
                            'date',
                            'json',
                            'bin',
                            'env',
                            'msg',
                            'flow',
                            'global',
                            'jsonata',
                            types.numPercent,
                            types.randomNumber,
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek,
                            types.strPlaceholder,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevationObj,
                            types.SunTimeByElevationNext,
                            types.SunTimeByElevationRise,
                            types.SunTimeByElevationSet,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven,
                            types.nodeId,
                            types.nodeName,
                            types.nodePath
                        ]
                    });
                    // #endregion Output Values
                    // #region Enhanced settings
                    initializeValue(node, 'tsCompare', 0);
                    const chkVal = (name, val) => {
                        return (node[name] === null) ||
                                (typeof node[name] === 'undefined') ||
                                ($('#node-input-' + name).val() === val) ||
                                ($('#node-input-' + name).is(':checked') === val) ||
                                (parseFloat($('#node-input-' + name).val()) === val);
                    };

                    if (chkVal('tsCompare', 0)) {
                        $('.enhanced-row').hide();
                    } else {
                        $('.enhanced-row').show();
                    }
                    // #endregion Enhanced settings
                    onInit = false;
                    $('#node-input-startOffset').change();
                    $('#node-input-endOffset').change();
                    $('#node-input-startOffsetAlt').change();
                    $('#node-input-endOffsetAlt').change();
                    $propertyStart.change();
                    $propertyEnd.change();
                }; // setup

                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus, _jqxhr) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }
                    })
                    .fail((_jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                this.propertyStartType = $('#node-input-propertyStart').typedInput('type');
                this.propertyEndType = $('#node-input-propertyEnd').typedInput('type');
                this.propertyStartThresholdType = $('#node-input-propertyStartThreshold').typedInput('type');
                this.propertyEndThresholdType = $('#node-input-propertyEndThreshold').typedInput('type');

                this.startTimeType = $('#node-input-startTime').typedInput('type');
                this.endTimeType = $('#node-input-endTime').typedInput('type');
                this.startTimeAltType = $('#node-input-startTimeAlt').typedInput('type');
                this.endTimeAltType = $('#node-input-endTimeAlt').typedInput('type');

                this.startOffsetType = $('#node-input-startOffset').typedInput('type');
                this.endOffsetType = $('#node-input-endOffset').typedInput('type');
                this.startOffsetAltType = $('#node-input-startOffsetAlt').typedInput('type');
                this.endOffsetAltType = $('#node-input-endOffsetAlt').typedInput('type');

                this.timeRestrictionsType = $('#node-input-timeRestrictions').typedInput('type');

                this.timeDays = getCheckboxesStr($('#within-time-switch-timeDays input[type=checkbox]:checked'), 7);
                this.timeMonths = getCheckboxesStr($('#within-time-switch-timeMonths input[type=checkbox]:checked'), 12);

                this.withinTimeValueType = $('#node-input-withinTimeValue').typedInput('type');
                this.outOfTimeValueType = $('#node-input-outOfTimeValue').typedInput('type');
            }
        });
    })();</script>

<script type="text/html" data-template-name="within-time-switch">
    <div class="form-row block-noindent is-to-show-initially">
        <span><i class="fa fa-info-circle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.infoText" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row block-noindent is-to-show-initially" id="node-input-startTime-div" data-i18n="[titleOrg]within-time-switch.placeholder.startTime">
        <label for="node-input-startTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTime"></span></label>
        <input type="text" id="node-input-startTime" />
        <input type="hidden" id="node-input-startTimeType">
    </div>
    <div class="form-row block-indent1 is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.startOffset">
        <label for="node-input-startOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startOffset"></span></label>
        <input id="node-input-startOffset" data-i18n="[placeholder]within-time-switch.placeholder.startOffset"/>
        <input type="hidden" id="node-input-startOffsetType">
        <select id="node-input-startOffsetMultiplier" class="node-input-multiplier"></select>
    </div>

    <div class="form-row block-noindent is-to-show-initially" id="node-input-endTime-div" data-i18n="[titleOrg]within-time-switch.placeholder.endTime">
        <label for="node-input-endTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTime"></span></label>
        <input type="text" id="node-input-endTime" data-i18n="[placeholder]within-time-switch.placeholder.endTime"/>
        <input type="hidden" id="node-input-endTimeType">
    </div>
    <div class="form-row block-indent1 is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.endOffset">
        <label for="node-input-endOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endOffset"></span></label>
        <input id="node-input-endOffset" data-i18n="[placeholder]within-time-switch.placeholder.endOffset"/>
        <input type="hidden" id="node-input-endOffsetType">
        <select id="node-input-endOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row block-noindent is-to-show-initially">
        <label for="node-input-timeRestrictions"><i class="fa fa-calendar-o"></i> <span data-i18n="within-time-switch.label.timeRestrictions"></span></label>
        <input type="text" id="node-input-timeRestrictions"/>
        <input type="hidden" id="node-input-timeRestrictionsType">
    </div>
    <div class="form-row node-input-row-timeLimits  is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.timeLimits">
        <div id="within-time-switch-timeDays" class="within-time-switch-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDays"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                </div>
            </div>
        </div>
        <div class="within-time-switch-limits" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.specialLimits"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' id="node-input-timeOnlyEvenDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeOnlyOddDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddDays"></span></label>
                    <label><input type='checkbox' id="node-input-timeOnlyEvenWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks"></span></label>
                    <label><input type='checkbox' id="node-input-timeOnlyOddWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks"></span></label>
                </div>
            </div>
        </div>
        <div id="within-time-switch-timeMonths" class="within-time-switch-months" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForMonths"></div>
            <div style="display:inline-block;">
                <div>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                    <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                </div>
            </div>
        </div>
        <div id="within-time-switch-timeDateLimit" class="within-time-switch-datelimit" style="margin-top:5px;border-top: 1px solid #000;">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;"><i class="fa fa-calendar-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDates"></span></div>
            <div style="display:inline-block;">
                <input type="date" id="node-input-timedatestart" class="ipMain within-time-switch-timedatelimit" value="" data-i18n="[placeholder]blind-control.placeholder.start" min="2000-01-01" max="2000-12-31">
                <input type="date" id="node-input-timedateend" class="ipMain within-time-switch-timedatelimit" value="" data-i18n="[placeholder]blind-control.placeholder.end" min="2000-01-01" max="2000-12-31">
            </div>
        </div>
    </div>
    <hr>
    <div class="form-row form-tips is-to-show-initially" data-i18n="[html]within-time-switch.tips.addTimes"></div>
    <div class="form-row alternate-property-start is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.propertyStart">
        <label for="node-input-propertyStart"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyStart"></span></label>
        <input type="text" id="node-input-propertyStart" data-i18n="[placeholder]within-time-switch.placeholder.propertyStart"/>
        <input type="hidden" id="node-input-propertyStartType">
        <select id="node-input-propertyStartCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row block-indent2 row-propertyStartThreshold is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.propertyStartThreshold">
        <label for="node-input-propertyStartThreshold"><i class="fa fa-compress"></i> <span data-i18n="within-time-switch.label.propertyStartThreshold"></span></label>
        <input type="text" id="node-input-propertyStartThreshold" data-i18n="[placeholder]within-time-switch.placeholder.propertyStartThreshold">
        <input type="hidden" id="node-input-propertyStartThresholdType">
    </div>
    <div class="form-row block-indent1 alternate-time-start is-initial-hidden" id="node-input-startTimeAlt-div" data-i18n="[titleOrg]within-time-switch.placeholder.startTimeAlt">
        <label for="node-input-startTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTimeAlt"></span></label>
        <input type="text" id="node-input-startTimeAlt" data-i18n="[placeholder]within-time-switch.placeholder.startTimeAlt"/>
        <input type="hidden" id="node-input-startTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-start-offset is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.startOffsetAlt">
        <label for="node-input-startOffsetAlt"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startOffsetAlt"></span></label>
        <input id="node-input-startOffsetAlt" data-i18n="[placeholder]within-time-switch.placeholder.startOffsetAlt"/>
        <input type="hidden" id="node-input-startOffsetAltType">
        <select id="node-input-startOffsetAltMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row alternate-property-end is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.propertyEnd">
        <label for="node-input-propertyEnd"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyEnd"></span></label>
        <input type="text" id="node-input-propertyEnd" data-i18n="[placeholder]within-time-switch.placeholder.propertyEnd"/>
        <input type="hidden" id="node-input-propertyEndType">
        <select id="node-input-propertyEndCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row block-indent2 row-propertyEndThreshold is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.propertyEndThreshold">
        <label for="node-input-propertyEndThreshold"><i class="fa fa-compress"></i> <span data-i18n="within-time-switch.label.propertyEndThreshold"></span></label>
        <input type="text" id="node-input-propertyEndThreshold" data-i18n="[placeholder]within-time-switch.placeholder.propertyEndThreshold">
        <input type="hidden" id="node-input-propertyEndThresholdType">
    </div>
    <div class="form-row block-indent1 alternate-time-end is-initial-hidden" id="node-input-endTimeAlt-div" data-i18n="[titleOrg]within-time-switch.placeholder.endTimeAlt">
        <label for="node-input-endTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTimeAlt"></span></label>
        <input type="text" id="node-input-endTimeAlt" data-i18n="[placeholder]within-time-switch.placeholder.endTimeAlt"/>
        <input type="hidden" id="node-input-endTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-end-offset is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.endOffsetAlt">
        <label for="node-input-endOffsetAlt"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endOffsetAlt"></span></label>
        <input id="node-input-endOffsetAlt" data-i18n="[placeholder]within-time-switch.placeholder.endOffsetAlt"/>
        <input type="hidden" id="node-input-endOffsetAltType">
        <select id="node-input-endOffsetAltMultiplier" class="node-input-multiplier"></select>
    </div>
    <hr>
    <div class="form-row form-tips is-to-show-initially" data-i18n="[html]within-time-switch.tips.outputValue"></div>
    <div class="form-row row-withinTimeValue">
        <label for="node-input-withinTimeValue"><i class="fa fa-hourglass-half"></i> <span data-i18n="within-time-switch.label.withinTimeValue"></span></label>
        <input type="text" id="node-input-withinTimeValue">
        <input type="hidden" id="node-input-withinTimeValueType">
    </div>
    <div class="form-row row-outOfTimeValue">
        <label for="node-input-outOfTimeValue"><i class="fa fa-hourglass-end"></i> <span data-i18n="within-time-switch.label.outOfTimeValue"></span></label>
        <input type="text" id="node-input-outOfTimeValue">
        <input type="hidden" id="node-input-outOfTimeValueType">
    </div>
    <hr>
    <div class="form-row is-to-show-initially">
        <a href="#" class="enhanced-row-toggle"><span data-i18n="within-time-switch.label.showEnhSettings"></span></a>
    </div>
    <div class="form-row enhanced-row" style="display:none">
        <div class="form-row compare-row" data-i18n="[title]within-time-switch.placeholder.compareTime">
            <label for="node-input-tsCompare"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.compareTime"></span></label>
            <select id="node-input-tsCompare" style="width:70%;" >
                <option value="0" data-i18n="within-time-switch.label.now"></option>
                <option value="1" data-i18n="within-time-switch.label.msgts"></option>
                <option value="2" data-i18n="within-time-switch.label.msglc"></option>
                <option value="3" data-i18n="within-time-switch.label.msgtime"></option>
                <option value="4" data-i18n="within-time-switch.label.msgvalue"></option>
            </select>
        </div>
    </div>
    <hr>
    <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-tips is-to-show-initially">
        <span data-i18n="[html]within-time-switch.tips.documentation" style="word-wrap:break-word;"></span>
    </div>
</script>

<style>
    hr {
        width: 100%
    }
    .is-to-show-initially {
        display:none
    }
    .is-initial-hidden {
        display:none
    }
    .form-tips {
        width: 90%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: calc(100% - 15px);
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: calc(100% - 25px);
    }
    .block-noindent .row-full-width {
        width : calc(100% - 115px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 125px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 135px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 250px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 260px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 270px);
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .node-input-row-timeLimits {
        padding-left: 110px;
    }
    .node-input-row-timeLimits select {
        margin: 3px 0;
    }
    .node-input-row-timeLimits input {
        width: auto !important;
    }
    .within-time-switch-days label,
    .within-time-switch-months label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        max-width: 55px;
        width: 100px;
    }
</style>