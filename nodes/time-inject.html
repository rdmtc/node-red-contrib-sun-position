<script type="text/x-red" data-template-name="time-inject">
  <div class="form-row">
    <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-inject.label.position"></span></label>
    <input type="text" id="node-input-positionConfig">
  </div>
  <hr>
  <div class="form-row time-payload">
      <label for="node-input-payload"><i class="fa fa-envelope"></i> <span data-i18n="time-inject.label.payload"></span></label>
      <input type="text" id="node-input-payload" style="width:70%">
      <input type="hidden" id="node-input-payloadType">
  </div>
  <div class="form-row time-inject-row-payloadOffset hidden">
        <label for="node-input-payloadOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.payloadOffset"></span></label>
        <input id="node-input-payloadOffset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.payloadOffset">
        <select style="width:100px" id="node-input-payloadOffsetMultiplier">
        </select>
  </div>
  <div class="form-row time-inject-row-payloadTimeFormat hidden">
        <label for="node-input-payloadTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.payloadTimeFormat"></span></label>
        <select style="width: 70%;" id="node-input-payloadTimeFormatsel">
        </select>
        <input type="text" id="node-input-payloadTimeFormat" style="width:50%;">
  </div>
  <div class="form-row time-topic">
      <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="time-inject.label.topic"></span></label>
      <input type="text" id="node-input-topic">
  </div>
  <hr>
  <div class="form-row">
      <label for="node-input-time"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.time"></span></label>
      <input type="text" id="node-input-time" style="width: 70%"/>
      <input type="hidden" id="node-input-timeType">
  </div>
  <div class="form-row time-inject-row-offset hidden">
      <label for="node-input-offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
      <input id="node-input-offset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
      <select style="width:100px" id="node-input-offsetMultiplier">
      </select>
  </div>
  <div class="form-row time-inject-row-timeDays hidden">
      <div id="time-inject-timeDays" class="time-inject-days" style="margin-top:5px">
          <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
          <div style="display:inline-block;">
              <div>
                  <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.1"></span></label>
                  <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.2"></span></label>
                  <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.3"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.4"></span></label>
                  <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.5"></span></label>
                  <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.6"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.0"></span></label>
              </div>
          </div>
      </div>
  </div>
  <div class="form-tips" data-i18n="[html]time-inject.tips.config"></div>
  <hr class="time-inject-row-alt hidden">
  <div class="form-row time-inject-row-alt hidden">
      <label for="node-input-property"><i class="fa fa-sun-o"></i> <span data-i18n="time-inject.label.property"></span></label>
      <input type="text" id="node-input-property" style="width: 70%"/>
  </div>
  <div class="form-row time-inject-row-timeAlt hidden">
      <label for="node-input-timeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.timeAlt"></span></label>
      <input type="text" id="node-input-timeAlt" style="width: 70%"/>
  </div>
  <div class="form-row time-inject-row-timeAltOffset hidden">
      <label for="node-input-timeAltOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.timeAltOffset"></span></label>
      <input id="node-input-timeAltOffset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.timeAltOffset">
      <select style="width:100px" id="node-input-timeAltOffsetMultiplier">
      </select>
  </div>
  <div class="form-row time-inject-row-timeAltDays hidden">
      <div id="time-inject-timeAltDays" class="time-inject-days" style="margin-top:5px">
          <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
          <div style="display:inline-block;">
              <div>
                  <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.1"></span></label>
                  <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.2"></span></label>
                  <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.3"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.4"></span></label>
                  <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.5"></span></label>
                  <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.6"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.0"></span></label>
              </div>
          </div>
      </div>
  </div>
  <div class="form-tips time-inject-row-alt hidden">
      <span data-i18n="[html]time-inject.tips.addTimes"></span>&nbsp;
  </div>
  <hr>
  <div class="form-row" id="node-once">
      <label for="node-input-once"><i class="fa fa-play-circle"></i> <span data-i18n="time-inject.label.once"></span></label>
      <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
      <span data-i18n="time-inject.label.onstart"></span>&nbsp;
      <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:65px; height:28px;">&nbsp;
      <span data-i18n="time-inject.label.onceDelay"></span>
  </div>
  <hr class="time-inject-recalc hidden">
  <div class="form-row time-inject-recalc hidden">
      <label for="node-input-recalcTime"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.recalcTime"></span></label>
      <input type="text" id="node-input-recalcTime" placeholder="2" style="width:65px; height:28px;">&nbsp;
      <span data-i18n="time-inject.label.hours"></span>
  </div>
  <div class="form-tips time-inject-recalc hidden" data-i18n="[html]time-inject.tips.recalc"></div>
  <hr class="time-inject-addPayload">
  <div class="form-row time-addPayload1">
      <label for="node-input-addPayload1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload1"></span></label>
      <input type="text" id="node-input-addPayload1" style="width:70%">
      <input type="hidden" id="node-input-addPayload1Type">
  </div>
  <div class="form-row time-addPayload1Value hidden">
      <label for="node-input-addPayload1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload1Value"></span></label>
      <input type="text" id="node-input-addPayload1Value" style="width:70%">
      <input type="hidden" id="node-input-addPayload1ValueType">
  </div>
  <div class="form-row time-inject-row-addPayload1Format hidden">
      <label for="node-input-addPayload1Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload1Format"></span></label>
      <select style="width: 70%;" id="node-input-addPayload1Formatsel">
      </select>
      <input type="text" id="node-input-addPayload1Format" style="width:50%;">
  </div>
  <div class="form-row time-inject-row-addPayload1Offset hidden">
      <label for="node-input-addPayload1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
      <input id="node-input-addPayload1Offset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
      <select style="width:100px" id="node-input-addPayload1OffsetMultiplier">
      </select>
  </div>
  <div class="form-row time-inject-row-addPayload1days hidden">
      <div id="time-inject-addPayload1Days" class="time-inject-days" style="margin-top:5px">
          <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
          <div style="display:inline-block;">
              <div>
                  <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.1"></span></label>
                  <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.2"></span></label>
                  <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.3"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.4"></span></label>
                  <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.5"></span></label>
                  <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.6"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.0"></span></label>
              </div>
          </div>
      </div>
  </div>
  <hr class="time-addPayload2 hidden">
  <div class="form-row time-addPayload2 hidden">
      <label for="node-input-addPayload2"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload2"></span></label>
      <input type="text" id="node-input-addPayload2" style="width:70%">
      <input type="hidden" id="node-input-addPayload2Type">
  </div>
  <div class="form-row time-addPayload2Value hidden">
      <label for="node-input-addPayload2Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload2Value"></span></label>
      <input type="text" id="node-input-addPayload2Value" style="width:70%">
      <input type="hidden" id="node-input-addPayload2ValueType">
  </div>
  <div class="form-row time-inject-row-addPayload2Format hidden">
      <label for="node-input-addPayload2Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload2Format"></span></label>
      <select style="width:70%" id="node-input-addPayload2Formatsel">
    </select>
    <input type="text" id="node-input-addPayload2Format" style="width:50%;">
  </div>
  <div class="form-row time-inject-row-addPayload2Offset hidden">
      <label for="node-input-addPayload2Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
      <input id="node-input-addPayload2Offset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
      <select style="width:100px" id="node-input-addPayload2OffsetMultiplier">
      </select>
  </div>
  <div class="form-row time-inject-row-addPayload2days hidden">
      <div id="time-inject-addPayload2Days" class="time-inject-days" style="margin-top:5px">
          <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
          <div style="display:inline-block;">
              <div>
                  <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.1"></span></label>
                  <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.2"></span></label>
                  <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.3"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.4"></span></label>
                  <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.5"></span></label>
                  <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.6"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.0"></span></label>
              </div>
          </div>
      </div>
  </div>
  <hr class="time-addPayload3 hidden">
  <div class="form-row time-addPayload3 hidden">
      <label for="node-input-addPayload3"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload3"></span></label>
      <input type="text" id="node-input-addPayload3" style="width:70%">
      <input type="hidden" id="node-input-addPayload3Type">
  </div>
  <div class="form-row time-addPayload3Value hidden">
      <label for="node-input-addPayload3Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload3Value"></span></label>
      <input type="text" id="node-input-addPayload3Value" style="width:70%">
      <input type="hidden" id="node-input-addPayload3ValueType">
  </div>
  <div class="form-row time-inject-row-addPayload3Format hidden">
      <label for="node-input-addPayload3Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload3Format"></span></label>
      <select style="width:70%" id="node-input-addPayload3Formatsel">
      </select>
      <input type="text" id="node-input-addPayload3Format" style="width:50%;">
  </div>
  <div class="form-row time-inject-row-addPayload3Offset hidden">
      <label for="node-input-addPayload3Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
      <input id="node-input-addPayload3Offset" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
      <select style="width:100px" id="node-input-addPayload3OffsetMultiplier">
      </select>
  </div>
  <div class="form-row time-inject-row-addPayload3days hidden">
      <div id="time-inject-addPayload3Days" class="time-inject-days" style="margin-top:5px">
          <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
          <div style="display:inline-block;">
              <div>
                  <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.1"></span></label>
                  <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.2"></span></label>
                  <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.3"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.4"></span></label>
                  <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.5"></span></label>
                  <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.6"></span></label>
              </div>
              <div>
                  <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.0"></span></label>
              </div>
          </div>
      </div>
  </div>
  <div class="form-tips time-inject-addPayload" data-i18n="[html]time-inject.tips.addPayload"></div>
  <hr>
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-inject.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]time-inject.placeholder.name">
  </div>
</script>
<style>
  .time-inject-row-timeDays,
  .time-inject-row-timeAltDays,
  .time-inject-row-addPayload1days,
  .time-inject-row-addPayload2days,
  .time-inject-row-addPayload3days {
    padding-left: 110px;
  }
  .time-inject-row-timeDays select,
  .time-inject-row-timeAltDays select,
  .time-inject-row-addPayload1days select,
  .time-inject-row-addPayload2days select,
  .time-inject-row-addPayload2days select {
    margin: 3px 0;
  }
  .time-inject-days label {
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    vertical-align: baseline;
    width: 100px;
  }
  .time-inject-days input {
    width: auto;
    vertical-align: baseline;
  }
  .time-inject-times {
    width: 90px;
  }
  #time-inject-time {
    width: 75px;
    margin-left: 8px;
    margin-bottom: 8px;
  }
  .time-inject-count {
    width: 40px !important;
  }
</style>

<script type="text/x-red" data-help-name="time-inject">
  <p>Injects a message into a flow either manually or at timestamps which can also depending on the sunset, sunrise, or moon set and rise. The message
  payload can be a variety of types, including strings, JavaScript objects, the current time or the cuttent sun or moon position.</p>
  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>payload<span class="property-type">various</span></dt>
      <dd>The configured payload of the message.</dd>
      <dt class="optional">topic <span class="property-type">string</span></dt>
      <dd>An optional property that can be configured in the node.</dd>
      <dt class="optional">time <span class="property-type">time</span></dt>
      <dd>An optional property that can be configured when the inject node should emit a message on that timestamp.</dd>
      <dt class="optional">offset <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. The offset can be a positive or negative and defines a time offset to the choosen time.</dd>
      <dt class="optional">day select <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. There can be defined on which days a msg should be emited.</dd>
  </dl>
  <h3>Details</h3>
  <p>The Time-Inject node can initiate a flow with a specific payload value.
  The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
  <p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
  <p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
  inject at specified time stamp in a daily interval which can be set directly or by using the suncalc module to generate an output at various sunrise, sunset, moonrise or moonset times based on a specified location.</p>
  <p><b>Note</b>: The next timestamp will be calculated if a timestamp is reached, settings are changed or the inject node is manual triggered. For a given timestamp (or an alternate timestamp) through a flow or global context a recalculation time could be defined. Then planned emit time then is recalculated every end of this interval. Changes to the contexts then only lead to a change of the planned emit time if a recalculation is done!</p>
  <p><b>Note</b>: To include a newline in a string you must use a Function node to create the payload.</p>

  <h3>Sun times:</h3>
  <p>
    <table>
        <thead>
        <tr>
        <th>Time</th>
        <th>Description</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>astronomicalDawn</code></td>
        <td>night ends (morning astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDawn</code></td>
        <td>amateur astronomical dawn (sun at 12Â° before sunrise)</td>
        </tr>
        <tr>
        <td><code>nauticalDawn</code></td>
        <td>nautical dawn (morning nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDawn</code></td>
        <td>dawn (morning nautical twilight ends, morning civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>sunrise</code></td>
        <td>sunrise (top edge of the sun appears on the horizon)</td>
        </tr>
        <tr>
        <td><code>sunriseEnd</code></td>
        <td>sunrise ends (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>goldenHourEnd</code></td>
        <td>morning golden hour (soft light, best time for photography) ends</td>
        </tr>
        <tr>
        <td><code>solarNoon</code></td>
        <td>solar noon (sun is in the highest position)</td>
        </tr>
        <tr>
        <td><code>goldenHourStart</code></td>
        <td>evening golden hour starts</td>
        </tr>
        <tr>
        <td><code>sunsetStart</code></td>
        <td>sunset starts (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>sunset</code></td>
        <td>sunset (sun disappears below the horizon, evening civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDusk</code></td>
        <td>dusk (evening nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>nauticalDusk</code></td>
        <td>nautical dusk end (evening astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDusk</code></td>
        <td>amateur astronomical dusk (sun at 12Â° after sunrise)</td>
        </tr>
        <tr>
        <td><code>astronomicalDusk</code></td>
        <td>night starts (dark enough for astronomical observations)</td>
        </tr>
        <tr>
        <td><code>nadir</code></td>
        <td>nadir (darkest moment of the night, sun is in the lowest position)</td>
        </tr>
        </tbody>
        </table>
  </p>
  <p>It can also be configured to inject once each time the flows are started.</p>
  <h3>References</h3>
  <ul>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">Node-Red</a> - the Node-Red Node overview</li>
      <li><a href="https://github.com/HM-RedMatic/node-red-contrib-sun-position">GitHub</a> - the nodes github repository</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">NPM</a> - the nodes npm node description</li>
  </ul>
  With friendly support by <b>agag</b>.
</script>

<script type="text/javascript">
    function clipValueLength(v, l) {
        if (v.length > l) {
            return v.substring(0, l - 3) + '...';
        }

        return v;
    }

    function getValueLabel(t, v, l) {
        l = l || 15;
        if (t === 'string' || t === 'str') {
            if (v === '') {
                return v;
            }

            return '"' + clipValueLength(v, l) + '"';
        }

        if (t === 'num' || t === 'bool') {
            if (v === '') {
                return v;
            }

            return String(v);
        }

        if (t === 'msg') {
            return t + '.' + clipValueLength(v, l);
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            return t + '.' + clipValueLength(result.key, l);
        }

        if (t === 'pdsCalcData') {
            return '{sun position}';
        }

        if (t === 'pdmCalcData') {
            return '{moon position}';
        }

        if (t === 'pdsTime') {
            const res = v
                .replace('astronomical', 'astro-')
                .replace('nautical', 'naut-')
                .replace('civil', '')
                .replace('amateur', 'amat-')
                .replace('blueHour', 'blHr-')
                .replace('goldenHour', 'goHr-');
            return clipValueLength(res, l);
        }

        if (t === 'pdmTime') {
            return 'moon' + v;
        }

        return clipValueLength(v, l);
    }

    RED.nodes.registerType('time-inject', {
        category: 'time and astro',
        color: '#a6bbcf',
        icon: 'injectSun-white.png',
        inputs: 0,
        outputs: 1,
        defaults: {
            name: {
                value: '',
                required: false
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            payload: {
                value: '',
                validate: RED.validators.typedInput('payloadType')
            },
            payloadType: {
                value: 'date'
            },
            payloadTimeFormat: {
                value: 0
            },
            payloadOffset: {
                value: 0
            },
            payloadOffsetMultiplier: {
                value: 60000
            },
            topic: {
                value: ''
            },
            time: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('timeType')
            },
            timeType: {
                value: 'none'
            },
            timeDays: {
                value: '*'
            },
            offset: {
                value: 0,
                required: false,
                validate(v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            offsetMultiplier: {
                value: 60000,
                required: false,
                validate(v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            property: {
                value: '',
                required: false,
                validate(v) {
                    return (
                        RED.validators.typedInput('propertyType')(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            propertyType: {
                value: 'none'
            },
            timeAlt: {
                value: '',
                required: false,
                validate(v) {
                    return (
                        RED.validators.typedInput('timeAltType')(v) ||
                        ($('#node-input-timeType').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            timeAltType: {
                value: 'entered'
            },
            timeAltOffset: {
                value: 0,
                required: true,
                validate(v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            timeAltOffsetMultiplier: {
                value: 60000,
                required: true,
                validate(v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            once: {
                value: false
            },
            onceDelay: {
                value: 0.1,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        v === '' ||
                        v === null ||
                        typeof v === 'undefined'
                    );
                }
            },
            addPayload1: {
                value: '',
                validate: RED.validators.typedInput('addPayload1Type')
            },
            addPayload1Type: {
                value: 'none'
            },
            addPayload1Value: {
                value: '',
                validate(v) {
                    return (
                        RED.validators.typedInput('addPayload1ValueType')(v) ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload1ValueType: {
                value: 'date'
            },
            addPayload1Format: {
                value: 0,
                required: false
            },
            addPayload1Offset: {
                value: 0,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload1OffsetMultiplier: {
                value: 60000,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload1Days: {
                value: '*'
            },
            addPayload2: {
                value: '',
                validate: RED.validators.typedInput('addPayload2Type')
            },
            addPayload2Type: {
                value: 'none'
            },
            addPayload2Value: {
                value: '',
                validate(v) {
                    return (
                        RED.validators.typedInput('addPayload2ValueType')(v) ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2ValueType: {
                value: 'date'
            },
            addPayload2Format: {
                value: 0,
                required: false
            },
            addPayload2Offset: {
                value: 0,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2OffsetMultiplier: {
                value: 60000,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2Days: {
                value: '*'
            },
            addPayload3: {
                value: '',
                validate: RED.validators.typedInput('addPayload3Type')
            },
            addPayload3Type: {
                value: 'none'
            },
            addPayload3Value: {
                value: '',
                validate(v) {
                    return (
                        RED.validators.typedInput('addPayload3ValueType')(v) ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        this.addPayload3Type === undefined
                    );
                }
            },
            addPayload3ValueType: {
                value: 'date'
            },
            addPayload3Format: {
                value: 0,
                required: false
            },
            addPayload3Offset: {
                value: 0,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        this.addPayload3Type === undefined
                    );
                }
            },
            addPayload3OffsetMultiplier: {
                value: 60000,
                required: false,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        this.addPayload3Type === undefined
                    );
                }
            },
            addPayload3Days: {
                value: '*'
            },
            recalcTime: {
                value: 2,
                validate(v) {
                    return (
                        RED.validators.number()(v) ||
                        v === '' ||
                        v === null ||
                        typeof v === 'undefined'
                    );
                }
            }
        },
        outputLabels(_index) {
            const labels = {
                str: 'string',
                num: 'number',
                bool: 'boolean',
                json: 'object',
                flow: 'flow context',
                global: 'global context',
                bin: 'binary data',
                date: 'timestamp',
                env: 'Enviroment variable',
                jsonata: 'result of jsonata expression',
                pdmTime: 'time',
                typeSunCalc: 'object of sun position',
                typeMoonCalc: 'object of moon position'
            };
            let lab = labels[this.payloadType] || this.payloadType;
            if (lab === 'object') {
                try {
                    lab = typeof JSON.parse(this.payload);
                    if (lab === 'object') {
                        if (Array.isArray(JSON.parse(this.payload))) {
                            lab = 'Array';
                        }
                    }
                } catch (e) {
                    lab = 'Invalid JSON Object';
                }
            }

            return lab;
        },
        label() {
            if (this.name) {
                return this.name;
            }

            let result = '';
            let prefix = '';
            if (this.once) {
                prefix += ' Â¹';
            }

            const getId = (type, value, offset, maxLength) => {
                let suffix = '';
                if (offset && offset > 0) {
                    suffix = 'â†·';
                } else if (offset && offset < 0) {
                    suffix = 'â†¶';
                }

                if (type === 'jsonata') {
                    if (value.length < 15) {
                        return value + suffix;
                    }

                    return this._('time-inject.label.jsonata');
                }

                if (type === 'json') {
                    if (value.length < 15) {
                        return value + suffix;
                    }

                    return this._('time-inject.label.json') + suffix;
                }

                if (type === 'bin') {
                    return this._('time-inject.label.binary') + suffix;
                }

                if (type === 'date') {
                    return this._('time-inject.label.timestamp') + suffix;
                }

                const v = getValueLabel(type, value, maxLength);
                if (v === '') {
                    return this._('time-inject.label.blank');
                }

                return v + suffix;
            };

            const getTimeId = () => {
                let suffix = '';
                const days = this.timeDays;
                if (days && days !== '*' && days !== '1,2,3,4,5,6,0') {
                    if (days === '1,2,3,4,5') {
                        suffix += ' [Mo-Fr]'; // 'ðŸ‘·'
                    } else if (days === '1,2,3,4') {
                        suffix += ' [Mo-Th]';
                    } else if (days === '5,6,0') {
                        suffix += ' [Fr-Su]';
                    } else if (days === '6,0') {
                        suffix += ' [Sa+Su]';
                    } else {
                        const dayarr = [];
                        if (days.indexOf('1') >= 0) {
                            dayarr.push('Mo');
                        }

                        if (days.indexOf('2') >= 0) {
                            dayarr.push('Tu');
                        }

                        if (days.indexOf('3') >= 0) {
                            dayarr.push('We');
                        }

                        if (days.indexOf('4') >= 0) {
                            dayarr.push('Th');
                        }

                        if (days.indexOf('5') >= 0) {
                            dayarr.push('Fr');
                        }

                        if (days.indexOf('6') >= 0) {
                            dayarr.push('Sa');
                        }

                        if (days.indexOf('0') >= 0) {
                            dayarr.push('Su');
                        }

                        suffix += ' [' + dayarr.join(',') + ']';
                    }
                    // ...
                }

                const part1 = getId(this.timeType, this.time, this.offset);
                if (
                    this.propertyType !== 'none' &&
      this.propertyType !== '' &&
      this.timeAlt
                ) {
                    return (
                        part1 +
        '/' +
        getId(this.timeAltType, this.timeAlt, this.timeAltOffset) +
        suffix
                    );
                }

                return part1 + suffix;
            };

            if (this.timeType === 'none' || this.timeType === '') {
                return this._('time-inject.label.inject');
            }

            const timeTxt = getTimeId();
            if (timeTxt.length > 24) {
                result += timeTxt + ' =...';
            } else {
                result +=
        timeTxt +
        ' = ' +
        getId(this.payloadType, this.payload, undefined, 12);
            }

            if (this.topic && this.topic.length + result.length <= 32) {
                return this.topic + ':' + prefix + result;
            }

            return prefix + result;
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'time inject',
        align: 'left',
        oneditprepare() {
            const node = this;
            // #region definition
            const SelectFields = {
                outputFormatsGroups: [
                    {id: 'number', label: 'Number'},
                    {id: 'string', label: 'Text (string)'},
                    {id: 'time', label: 'time (number) since emit'},
                    {id: 'dayofweek', label: 'day of week'},
                    {id: 'other', label: 'Other'}
                ], outputFormats: [
                    {id: 0, group: 'number', name: 'UNIX', label: 'milliseconds UNIX timestamp'},
                    {id: 10, group: 'number', name: 'YYYYMMDDHHMMSS', label: 'YYYYMMDDHHMMSS'},
                    {id: 11, group: 'number', name: 'YYYYMMDD_HHMMSS', label: 'YYYYMMDD.HHMMSS'},
                    {id: 1, group: 'string', name: 'ECMA262', label: 'ECMA-262', add: 'standard JSON Date representation'},
                    {id: 2, group: 'string', name: 'local', label: 'local date and time'},
                    {id: 14, group: 'string', name: 'localLong', label: 'local date and time enh.'},
                    {id: 3, group: 'string', name: 'localTime', label: 'local time'},
                    {id: 13, group: 'string', name: 'localTimeLong', label: 'ocal time enh.'},
                    {id: 12, group: 'string', name: 'localDate', label: 'local date'},
                    {id: 15, group: 'string', name: 'localDateLong', label: 'local date long'},
                    {id: 4, group: 'string', name: 'UTC', label: 'UTC date and time'},
                    {id: 5, group: 'string', name: 'ISO', label: 'ISO date and time'},
                    {id: 6, group: 'time', name: 'ms', label: 'milliseconds'},
                    {id: 7, group: 'time', name: 'sec', label: 'seconds'},
                    {id: 8, group: 'time', name: 'min', label: 'minutes'},
                    {id: 9, group: 'time', name: 'hour', label: 'hours'},
                    {id: 16, group: 'dayofweek', name: 'Day Name', label: 'Day Name, e.g. Monday, 22.12.'},
                    {id: 17, group: 'dayofweek', name: 'Day', label: 'Day in relative, e.g. Today, 22.12.'},
                    {id: -1, group: 'other', name: 'object', label: 'as object'},
                    {id: 99, group: 'other', name: 'free definition', label: 'Other'}
                ], multiplierGroups: [
                    {id: 'std', label: 'Standard'},
                    {id: 'other', label: 'Special'}
                ], multiplier: [
                    {id: 1, group: 'std', label: 'milliseconds'},
                    {id: 1000, group: 'std', label: 'seconds'},
                    {id: 60000, group: 'std', label: 'minutes'},
                    {id: 3600000, group: 'std', label: 'hours'},
                    {id: 86400000, group: 'std', label: 'days'},
                    {id: 604800000, group: 'other', label: 'weeks'},
                    {id: -1, group: 'other', label: 'month'},
                    {id: -2, group: 'other', label: 'year'}
                ]
            };
            const dateOutFormat = [{label: 'yyyy Year (4 digits)', value: 'yyyy'},
                {label: 'yy   Year (2 digits)', value: 'yy'},
                {label: 'M    Month (1 digit)', value: 'M'},
                {label: 'MM   Month (2 digits)', value: 'MM'},
                {label: 'MMM  Month (abbr.)', value: 'MMM'},
                {label: 'NNN  Month (name)', value: 'NNN'},
                {label: 'd    Day of Month (1 digit)', value: 'd'},
                {label: 'dd   Day of Month (2 digits)', value: 'dd'},
                {label: 'E    Day of Week (abbr)', value: 'E'},
                {label: 'EE   Day of Week (name)', value: 'EE'},
                {label: 'h    Hour (1-12)', value: 'h'},
                {label: 'hh   Hour (2 digits 01-12)', value: 'hh'},
                {label: 'H    Hour (0-23)', value: 'H'},
                {label: 'HH   Hour (2 digits 00-23)', value: 'HH'},
                {label: 'K    Hour (0-11)', value: 'K'},
                {label: 'KK   Hour (2 digits 00-11)', value: 'KK'},
                {label: 'k    Hour (1-24)', value: 'k'},
                {label: 'kk   Hour (2 digits 01-24)', value: 'kk'},
                {label: 'm    Minute (0-59)', value: 'm'},
                {label: 'mm   Minute (2 digits 00-59)', value: 'mm'},
                {label: 's    Second (0-59)', value: 's'},
                {label: 'ss   Second (2 digits 00-59)', value: 'ss'},
                {label: 'l    Milliseconds (0-999)', value: 'l'},
                {label: 'll   Milliseconds (2 digits 00-99)', value: 'll'},
                {label: 'lll  Milliseconds (3 digits 000-999)', value: 'lll'},
                {label: 't    AM/PM (1 digit - Lowercase)', value: 't'},
                {label: 'tt   AM/PM (2 digits - Lowercase)', value: 'tt'},
                {label: 'T    AM/PM (1 digit - Uppercase)', value: 'T'},
                {label: 'TT   AM/PM (2 digits - Uppercase)', value: 'TT'},
                {label: 'Z    timezone (abbr.)', value: 'Z'},
                {label: 'o    timezone offset (abbr.)', value: 'o'},
                {label: 'S    date\'s ordinal suffix (st, nd, rd, or th)', value: 'S'},
                {label: 'x    Day difference', value: 'x'},
                {label: 'xx   Day difference (name)', value: 'xx'}];
            const typeUndefined = {
                value: 'none',
                label: 'not used',
                // icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
                hasValue: false
            };
            const typeTime = {
                value: 'entered',
                label: 'time of day',
                icon: 'icons/node-red-contrib-sun-position/inputTypeTime.png',
                hasValue: true,
                validate: /^(0\d|\d|1\d|2[0-3])(?::([0-5]\d|\d))?(?::([0-5]\d|\d))?\s*(pm?)?$/
            };
            const typeTimeSun = {
                value: 'pdsTime',
                label: 'sun time ',
                icon: 'icons/node-red-contrib-sun-position/inputTypeSunClock.png',
                options: [
                    'astronomicalDawn',
                    'amateurDawn',
                    'nauticalDawn',
                    'blueHourDawnStart',
                    'civilDawn',
                    'blueHourDawnEnd',
                    'sunrise',
                    'sunriseEnd',
                    'goldenHourEnd',
                    'solarNoon',
                    'goldenHourStart',
                    'sunsetStart',
                    'sunset',
                    'blueHourDuskStart',
                    'civilDusk',
                    'blueHourDuskEnd',
                    'amateurDusk',
                    'astronomicalDusk',
                    'nadir'
                ]
            };
            const typeTimeMoon = {
                value: 'pdmTime',
                label: 'moon time ',
                icon: 'icons/node-red-contrib-sun-position/inputTypeMoonClock.png',
                options: ['rise', 'set']
            };
            const typeSunCalc = {
                value: 'pdsCalcData',
                label: 'sun caclucaltion',
                icon: 'icons/node-red-contrib-sun-position/inputTypeSun.png',
                hasValue: false
            };
            const typeMoonCalc = {
                value: 'pdmCalcData',
                label: 'moon caclucaltion',
                icon: 'icons/node-red-contrib-sun-position/inputTypeMoon.png',
                hasValue: false
            };
            // #endregion definition
            // #region initialize
            function initializeValue(data, id, newVal) {
                if (data[id] === null || typeof data[id] === 'undefined') {
                    // let idHtml = "#node-input-" + id;
                    // data[id] = newVal;
                    $('#node-input-' + id).val(newVal);
                    console.log('not initialized value !! "' + id + '" = "' + newVal + '" - ' + data[id]);
                }
            }

            function initializeNrValue(data, id, newVal) {
                if (data[id] === null ||
                    typeof data[id] === undefined ||
                    data[id] === '') {
                    $('#node-input-' + id).val(newVal);
                    console.log('not initialized numeric value !! ' + id + ' = "' + newVal + '" - ' + data[id]);
                }
            }

            initializeNrValue(this, 'offset', 0);
            initializeNrValue(this, 'timeAltOffset', 0);
            initializeNrValue(this, 'addPayload1Offset', 0);
            initializeNrValue(this, 'addPayload2Offset', 0);
            initializeNrValue(this, 'addPayload3Offset', 0);
            initializeValue(this, 'timeDays', '*');
            initializeValue(this, 'property', '');
            initializeValue(this, 'propertyType', typeUndefined.value);
            initializeValue(this, 'timeAlt', '');
            initializeValue(this, 'timeAltType', typeUndefined.value);
            initializeValue(this, 'timeAltDays', '*');
            initializeValue(this, 'addPayload1', '');
            initializeValue(this, 'addPayload1Type', typeUndefined.value);
            initializeValue(this, 'addPayload1Value', '');
            initializeValue(this, 'addPayload1ValueType', 'date');
            initializeValue(this, 'addPayload1Days', '*');
            initializeValue(this, 'addPayload2', '');
            initializeValue(this, 'addPayload2Type', typeUndefined.value);
            initializeValue(this, 'addPayload2Value', '');
            initializeValue(this, 'addPayload2ValueType', 'date');
            initializeValue(this, 'addPayload2Days', '*');
            initializeValue(this, 'addPayload3', '');
            initializeValue(this, 'addPayload3Type', typeUndefined.value);
            initializeValue(this, 'addPayload3Value', '');
            initializeValue(this, 'addPayload3ValueType', 'date');
            initializeValue(this, 'addPayload3Days', '*');
            // #endregion initialize
            // #region functions
            function autocomplete(inputBox, dataList) {
                // don't navigate away from the field on tab when selecting an item
                inputBox.on('keydown', function (event) {
                    if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance') && $(this).autocomplete('instance').menu.active) {
                        event.preventDefault();
                    }
                }).autocomplete({
                    minLength: 0,
                    source(request, response) {
                        if (inputBox.getCursorPosition() < request.term.length) {
                            return;
                        }

                        // delegate back to autocomplete, but extract the last term
                        const term = request.term.split(/\W+/).pop();
                        const result = dataList.filter(x => x.value.startsWith(term));
                        response(result);
                    },
                    focus() {
                        // prevent value inserted on focus
                        return false;
                    },
                    select(event, ui) {
                        const terms = this.value.split(/\W+/);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push('');
                        this.value = terms.join(' ');
                        return false;
                    }
                });
            }

            function initCombobox(inputSelectName, inputBoxName, dataList, optionElementName) {
                inputBox.attr('defValue', this._('time-inject.timeFormat.default'));
                const inputSelect = $('#node-input-' + inputSelectName);
                const inputBox = $('#node-input-' + inputBoxName);
                appendOptions(inputSelect, optionElementName);
                autocomplete(inputBox, dataList);

                inputSelect.on('change', (_type, _value) => {
                    const inputSelect = $('#node-input-' + inputSelectName);
                    const inputBox = $('#node-input-' + inputBoxName);
                    if (Number(inputSelect.val()) === 99) {
                        inputBox.show();
                        inputBox.css({ width: '40%' });
                        inputSelect.css({ width: '30%' });
                        if (!isNaN(inputBox.val())) {
                            inputBox.val(inputBox.attr('defValue'));
                        }
                    } else {
                        inputBox.hide();
                        inputSelect.css({ width: '70%' });
                    }
                });
                if (isNaN(this.addPayload1Format)) {
                    inputSelect.val(99);
                } else {
                    inputSelect.val(Number(node[inputBoxName]));
                }
                inputSelect.change();
            }

            function appendOptions(parent, elementName) {
                const groups = SelectFields[elementName + 'Groups'];
                const elements = SelectFields[elementName];
                const groupLength = groups.length;
                const elementsLength = elements.length;
                for (let gIndex = 0; gIndex < groupLength; gIndex++) {
                    const group = $('<optgroup/>', {label: node._('time-inject.' + elementName + 'Groups.' + gIndex)}).appendTo(parent);
                    for (let eIndex = 0; eIndex < elementsLength; eIndex++) {
                        if (groups[gIndex].id === elements[eIndex].group) {
                            group.append($('<option></option>').val(elements[eIndex].id).text(node._('time-inject.' + elementName + '.' + eIndex)).attr('addText', elements[eIndex].add));
                        }
                    }
                }
            }
            // #endregion
            // #region multiplier
            function multilpierUpdate(mp, name) {
                const field = $('#node-input-' + name);
                appendOptions(field, 'multiplier', mp);
                if (mp=== 1) {
                    field.val(1000);
                    return 1000;
                } else if (mp === 60) {
                    field.val(60000);
                    return 60000;
                } else if (mp === 3600) {
                    field.val(3600000);
                    return 3600000;
                } else if (mp === null || typeof mp === undefined || mp === '') {
                    field.val(60000);
                    return 60000;
                }
                field.val(mp);
                return mp;
            }

            node.payloadOffsetMultiplier = multilpierUpdate(node.payloadOffsetMultiplier, 'payloadOffsetMultiplier');
            node.offsetMultiplier = multilpierUpdate(node.offsetMultiplier, 'offsetMultiplier');
            node.timeAltOffsetMultiplier = multilpierUpdate(node.timeAltOffsetMultiplier, 'timeAltOffsetMultiplier');
            node.addPayload1OffsetMultiplier = multilpierUpdate(node.addPayload1OffsetMultiplier, 'addPayload1OffsetMultiplier');
            node.addPayload2OffsetMultiplier = multilpierUpdate(node.addPayload2OffsetMultiplier, 'addPayload2OffsetMultiplier');
            node.addPayload3OffsetMultiplier = multilpierUpdate(node.addPayload3OffsetMultiplier, 'addPayload3OffsetMultiplier');
            // #endregion
            // #region spinner
            $('#node-input-once').change(() => {
                $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
            });

            $('.wt-offset-time').spinner({
                max: 1439,
                min: -1439
            });
            $('#node-input-onceDelay').spinner({
                step: 0.1,
                numberFormat: 'n'
            });
            $('#node-input-recalcTime').spinner({
                step: 0.1,
                numberFormat: 'n'
            });
            // #endregion spinner
            // #region payload
            if (this.payloadType === null) {
                if (this.payload === '') {
                    this.payloadType = 'date';
                } else {
                    this.payloadType = 'str';
                }
            } else if (this.payloadType === 'string' || this.payloadType === typeUndefined.value) {
                this.payloadType = 'str';
            }

            $('#node-input-payloadType').val(this.payloadType);
            $('#node-input-payload').typedInput({
                default: this.payloadType || 'date',
                typeField: $('#node-input-payloadType'),
                types: [
                    'date',
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    'flow',
                    'global',
                    'str',
                    'num',
                    'bool',
                    'json',
                    'bin',
                    'env',
                    'jsonata',
                    typeSunCalc,
                    typeMoonCalc
                ]
            });
            $('#node-input-payload').typedInput('type', this.payloadType);
            $('#node-input-payload').on('change', (_type, _value) => {
                const plVType = $('#node-input-payload').typedInput('type');
                if (plVType === 'entered' || plVType === 'pdsTime' || plVType === 'pdmTime') {
                    $('.time-inject-row-payloadTimeFormat').show();
                    $('.time-inject-row-payloadOffset').show();
                } else if (plVType === 'date') {
                    $('.time-inject-row-payloadTimeFormat').show();
                    $('.time-inject-row-payloadOffset').show();
                } else {
                    $('.time-inject-row-payloadTimeFormat').hide();
                    $('.time-inject-row-payloadOffset').hide();
                }
            });
            initCombobox('payloadTimeFormatsel', 'payloadTimeFormat', dateOutFormat, 'outputFormats');
            // #endregion payload
            // #region addPayload1
            const addPl1TypeField = $('#node-input-addPayload1Type');
            const addPl1TiField = $('#node-input-addPayload1');
            addPl1TypeField.val(this.addPayload1Type);
            addPl1TiField.typedInput({
                default: this.addPayload1Type || typeUndefined.value,
                typeField: addPl1TypeField,
                types: [typeUndefined, 'msg', 'flow', 'global']
            });
            addPl1TiField.typedInput('type', this.addPayload1Type);

            const addPl1ValTypeField = $('#node-input-addPayload1ValueType');
            const addPl1ValTiField = $('#node-input-addPayload1Value');
            addPl1ValTypeField.val(this.addPayload1ValueType);
            addPl1ValTiField.typedInput({
                default: this.addPayload1ValueType || 'date',
                typeField: addPl1ValTypeField,
                types: [
                    'date',
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    'flow',
                    'global',
                    'str',
                    'num',
                    'bool',
                    'json',
                    'bin',
                    'env',
                    'jsonata',
                    typeSunCalc,
                    typeMoonCalc
                ]
            });
            addPl1ValTiField.typedInput('type', this.addPayload1ValueType);
            addPl1TiField.on('change', (_type, _value) => {
                const plType = $('#node-input-addPayload1').typedInput('type');
                if (plType !== typeUndefined.value) {
                    $('.time-addPayload1Value').show();
                    $('.time-addPayload2').show();
                    const plVType = $('#node-input-addPayload1Value').typedInput('type');
                    if (plVType === 'entered' || plVType === 'pdsTime' || plVType === 'pdmTime') {
                        $('.time-inject-row-addPayload1Format').show();
                        $('.time-inject-row-addPayload1Offset').show();
                        $('.time-inject-row-addPayload1days').show();
                    } else if (plVType === 'date') {
                        $('.time-inject-row-addPayload1Format').show();
                        $('.time-inject-row-addPayload1Offset').show();
                        $('.time-inject-row-addPayload1days').hide();
                    } else {
                        $('.time-inject-row-addPayload1Format').hide();
                        $('.time-inject-row-addPayload1Offset').hide();
                        $('.time-inject-row-addPayload1days').hide();
                    }
                } else {
                    $('.time-addPayload1Value').hide();
                    $('.time-inject-row-addPayload1Format').hide();
                    $('.time-inject-row-addPayload1Offset').hide();
                    $('.time-inject-row-addPayload1days').hide();
                    $('.time-addPayload2').hide();
                }
                $('#node-input-addPayload2').change();
            });
            addPl1ValTiField.on('change', (_type, _value) => {
                $('#node-input-addPayload1').change();
            });
            if (this.addPayload1Days === '*' || typeof this.addPayload1Days === 'undefined') {
                $('#time-inject-addPayload1Days input[type=checkbox]').prop('checked', true);
            } else {
                $('#time-inject-addPayload1Days input[type=checkbox]').removeAttr('checked');
                this.addPayload1Days.split(',').forEach(v => {
                    $('#time-inject-addPayload1Days [value=' + v + ']').prop('checked', true);
                });
            }
            initCombobox('addPayload1Formatsel', 'addPayload1Format', dateOutFormat, 'outputFormats');
            // #endregion addPayload1
            // #region addPayload2
            $('#node-input-addPayload2Type').val(this.addPayload2Type);
            $('#node-input-addPayload2').typedInput({
                default: this.addPayload2Type || typeUndefined.value,
                typeField: $('#node-input-addPayload2Type'),
                types: [typeUndefined, 'msg', 'flow', 'global']
            });
            $('#node-input-addPayload2').typedInput('type', this.addPayload2Type);

            $('#node-input-addPayload2ValueType').val(this.addPayload2ValueType);
            $('#node-input-addPayload2Value').typedInput({
                default: this.addPayload2ValueType || 'date',
                typeField: $('#node-input-addPayload2ValueType'),
                types: [
                    'date',
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    'flow',
                    'global',
                    'str',
                    'num',
                    'bool',
                    'json',
                    'bin',
                    'env',
                    'jsonata',
                    typeSunCalc,
                    typeMoonCalc
                ]
            });
            $('#node-input-addPayload2Value').typedInput('type', this.addPayload2ValueType);
            $('#node-input-addPayload2').on('change', (_type, _value) => {
                const plType = $('#node-input-addPayload2').typedInput('type');
                if (plType !== typeUndefined.value) {
                    $('.time-addPayload2Value').show();
                    $('.time-addPayload3').show();
                    const plVType = $('#node-input-addPayload2Value').typedInput('type');
                    if (
                        plVType === 'entered' ||
                        plVType === 'pdsTime' ||
                        plVType === 'pdmTime'
                    ) {
                        $('.time-inject-row-addPayload2Format').show();
                        $('.time-inject-row-addPayload2Offset').show();
                        $('.time-inject-row-addPayload2days').show();
                    } else if (plVType === 'date') {
                        $('.time-inject-row-addPayload2Format').show();
                        $('.time-inject-row-addPayload2Offset').show();
                        $('.time-inject-row-addPayload2days').hide();
                    } else {
                        $('.time-inject-row-addPayload2Format').hide();
                        $('.time-inject-row-addPayload2Offset').hide();
                        $('.time-inject-row-addPayload2days').hide();
                    }
                } else {
                    $('.time-addPayload2Value').hide();
                    $('.time-inject-row-addPayload2Format').hide();
                    $('.time-inject-row-addPayload2Offset').hide();
                    $('.time-inject-row-addPayload2days').hide();
                    $('.time-addPayload3').hide();
                }

                $('#node-input-addPayload3').change();
            });
            $('#node-input-addPayload2Value').on('change', (_type, _value) => {
                $('#node-input-addPayload2').change();
            });
            if (
                this.addPayload2Days === '*' || typeof this.addPayload2Days === 'undefined' ) {
                $('#time-inject-addPayload2Days input[type=checkbox]').prop('checked', true);
            } else {
                $('#time-inject-addPayload2Days input[type=checkbox]').removeAttr('checked');
                this.addPayload2Days.split(',').forEach(v => {
                    $('#time-inject-addPayload2Days [value=' + v + ']').prop('checked',true);
                });
            }
            initCombobox('addPayload2Formatsel', 'addPayload2Format', dateOutFormat, 'outputFormats');
            // #endregion addPayload2
            // #region addPayload3
            $('#node-input-addPayload3Type').val(this.addPayload3Type);
            $('#node-input-addPayload3').typedInput({
                default: this.addPayload3Type || typeUndefined.value,
                typeField: $('#node-input-addPayload3Type'),
                types: [typeUndefined, 'msg', 'flow', 'global']
            });
            $('#node-input-addPayload3').typedInput('type', this.addPayload3Type);
            $('#node-input-addPayload3ValueType').val(this.addPayload3ValueType);
            $('#node-input-addPayload3Value').typedInput({
                default: this.addPayload3ValueType || 'date',
                typeField: $('#node-input-addPayload3ValueType'),
                types: [
                    'date',
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    'flow',
                    'global',
                    'str',
                    'num',
                    'bool',
                    'json',
                    'bin',
                    'env',
                    'jsonata',
                    typeSunCalc,
                    typeMoonCalc
                ]
            });
            $('#node-input-addPayload3Value').typedInput('type', this.addPayload3ValueType);
            $('#node-input-addPayload3').on('change', (_type, _value) => {
                const plType = $('#node-input-addPayload3').typedInput('type');
                if (plType !== typeUndefined.value) {
                    $('.time-addPayload3Value').show();
                    const plVType = $('#node-input-addPayload3Value').typedInput('type');
                    if (plVType === 'entered' || plVType === 'pdsTime' || plVType === 'pdmTime') {
                        $('.time-inject-row-addPayload3Format').show();
                        $('.time-inject-row-addPayload3Offset').show();
                        $('.time-inject-row-addPayload3days').show();
                    } else if (plVType === 'date') {
                        $('.time-inject-row-addPayload3Format').show();
                        $('.time-inject-row-addPayload3Offset').show();
                        $('.time-inject-row-addPayload3days').hide();
                    } else {
                        $('.time-inject-row-addPayload3Format').hide();
                        $('.time-inject-row-addPayload3Offset').hide();
                        $('.time-inject-row-addPayload3days').hide();
                    }
                } else {
                    $('.time-addPayload3Value').hide();
                    $('.time-inject-row-addPayload3Format').hide();
                    $('.time-inject-row-addPayload3Offset').hide();
                    $('.time-inject-row-addPayload3days').hide();
                }
            });
            $('#node-input-addPayload3Value').on('change', (_type, _value) => {
                $('#node-input-addPayload3').change();
            });
            if (this.addPayload3Days === '*' || typeof this.addPayload3Days === 'undefined') {
                $('#time-inject-addPayload3Days input[type=checkbox]').prop(
                    'checked',
                    true
                );
            } else {
                $('#time-inject-addPayload3Days input[type=checkbox]').removeAttr('checked');
                this.addPayload3Days.split(',').forEach(v => {
                    $('#time-inject-addPayload3Days [value=' + v + ']').prop('checked',true);
                });
            }
            initCombobox('addPayload3Formatsel', 'addPayload3Format', dateOutFormat, 'outputFormats');
            // #endregion addPayload3
            // #region property
            $('#node-input-property').typedInput({
                default: this.propertyType || typeUndefined.value,
                types: [typeUndefined, 'flow', 'global', 'jsonata', 'env']
            });
            $('#node-input-property').on('change', (_type, _value) => {
                const timeType = $('#node-input-time').typedInput('type');
                const propType = $('#node-input-property').typedInput('type');
                if ( timeType === typeUndefined.value || propType === typeUndefined.value ) {
                    $('.time-inject-row-timeAlt').hide();
                    $('.time-inject-row-timeAltOffset').hide();
                    $('.time-inject-row-timeAltDays').hide();
                } else {
                    $('.time-inject-row-timeAlt').show();
                    $('.time-inject-row-timeAltOffset').show();
                    $('.time-inject-row-timeAltDays').show();
                }

                if ( timeType === 'flow' || timeType === 'global' || propType !== typeUndefined.value ) {
                    $('.time-inject-recalc').show();
                } else {
                    $('.time-inject-recalc').hide();
                    $('#time-inject-recalcTime').val('');
                }
            });
            initCombobox('payloadTimeFormatsel', 'payloadTimeFormat', dateOutFormat, 'outputFormats');
            // #endregion property
            // #region time
            $('#node-input-timeType').val(this.timeType);
            $('#node-input-time').typedInput({
                default: this.timeType || typeUndefined.value,
                typeField: $('#node-input-timeType'),
                types: [
                    typeUndefined,
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    'flow',
                    'global',
                    'env'
                ]
            });
            $('#node-input-time').typedInput('type', this.timeType);
            $('#node-input-time').on('change', (_type, _value) => {
                if ($('#node-input-time').typedInput('type') === typeUndefined.value) {
                    $('.time-inject-row-offset').hide();
                    $('.time-inject-row-timeDays').hide();
                    $('.time-inject-row-alt').hide();
                } else {
                    $('.time-inject-row-offset').show();
                    $('.time-inject-row-timeDays').show();
                    $('.time-inject-row-alt').show();
                }

                $('#node-input-property').change();
            });
            if (this.timeDays === '*' || typeof this.timeDays === 'undefined') {
                $('#time-inject-timeDays input[type=checkbox]').prop('checked', true);
            } else {
                $('#time-inject-timeDays input[type=checkbox]').removeAttr('checked');
                this.timeDays.split(',').forEach(v => {
                    $('#time-inject-timeDays [value=' + v + ']').prop('checked', true);
                });
            }

            // #endregion time
            // #region timeAlt
            $('#node-input-timeAlt').typedInput({
                default: this.timeAltType || 'entered',
                types: [typeTime, typeTimeSun, typeTimeMoon, 'flow', 'global', 'env']
            });
            $('#node-input-timeAlt').typedInput('type', this.timeAltType);
            if (this.timeAltDays === '*' || typeof this.timeAltDays === 'undefined') {
                $('#time-inject-timeAltDays input[type=checkbox]').prop('checked', true);
            } else {
                $('#time-inject-timeAltDays input[type=checkbox]').removeAttr(
                    'checked'
                );
                this.timeAltDays.split(',').forEach(v => {
                    $('#time-inject-timeAltDays [value=' + v + ']').prop('checked', true);
                });
            }

            // #endregion timeAlt
            // #region onceDelay
            $('#node-input-once').change(() => {
                $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
            });
            // #endregion onceDelay
            $('#node-input-time').change();
            $('#node-input-property').change();
            $('#node-input-payload').change();
            $('#node-input-addPayload1').change();
        },
        oneditsave() {
            function getDaysStr(value) {
                const days = value
                    .map((_, el) => {
                        return $(el).val();
                    })
                    .get();

                if (days.length === 0) { return ''; }
                if (days.length === 7) { return '*'; }
                return days.join(',');
            }

            // this.payloadType = $("#node-input-payload").typedInput("type");
            // this.timeType = $("#node-input-time").typedInput("type");
            this.timeDays = getDaysStr($('#time-inject-timeDays input[type=checkbox]:checked'));

            // this.propertyType = $("#node-input-property").typedInput("type");
            // this.timeAltType = $("#node-input-timeAlt").typedInput("type");
            this.timeAltDays = getDaysStr($('#time-inject-timeAltDays input[type=checkbox]:checked'));

            // this.addPayload1Type = $("#node-input-addPayload1").typedInput("type");
            // this.addPayload1ValueType = $("#node-input-addPayload1Value").typedInput("type");
            this.addPayload1Days = getDaysStr($('#time-inject-addPayload1Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload1Formatsel').val()) !== 99) {
                $('#node-input-addPayload1Format').val($('#node-input-addPayload1Formatsel').val());
                this.addPayload1Format = $('#node-input-addPayload1Formatsel').val();
            }

            // this.addPayload2Type = $("#node-input-addPayload2").typedInput("type");
            // this.addPayload2ValueType = $("#node-input-addPayload2Value").typedInput("type");
            this.addPayload2Days = getDaysStr($('#time-inject-addPayload2Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload2Formatsel').val()) !== 99) {
                $('#node-input-addPayload2Format').val($('#node-input-addPayload2Formatsel').val());
                this.addPayload2Format = $('#node-input-addPayload2Formatsel').val();
            }

            // this.addPayload3Type = $("#node-input-addPayload3").typedInput("type");
            // this.addPayload3ValueType = $("#node-input-addPayload3Value").typedInput("type");
            this.addPayload3Days = getDaysStr($('#time-inject-addPayload3Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload3Formatsel').val()) !== 99) {
                $('#node-input-addPayload3Format').val($('#node-input-addPayload3Formatsel').val());
                this.addPayload3Format = $('#node-input-addPayload3Formatsel').val();
            }
        },
        button: {
            enabled() {
                return !this.changed;
            },
            onclick() {
                if (this.changed) {
                    return RED.notify(
                        RED._('notification.warning', { message: RED._('notification.warnings.undeployedChanges') }), 'warning');
                }

                let payload = this.payload;
                if (this.payloadType === 'str' || this.payloadType === 'string') { payload = '"' + this.payload + '"'; }
                if (this.payloadType === 'flow' || this.payloadType === 'global') {
                    const key = RED.utils.parseContextKey(payload);
                    payload = this.payloadType + '.' + key.key;
                }

                let label = clipValueLength(this.name || payload, 30);
                label = label
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                if (this.payloadType === 'date') {
                    label = this._('time-inject.label.timestamp');
                }

                if (this.payloadType === 'none') {
                    label = this._('time-inject.label.blank');
                }

                const node = this;
                $.ajax({
                    url: 'inject/' + this.id,
                    type: 'POST',
                    success(_resp) {
                        RED.notify(
                            node._('time-inject.label.success', {
                                label
                            }),
                            'success'
                        );
                    },
                    error(jqXHR, textStatus, _errorThrown) {
                        if (jqXHR.status === 404) {
                            RED.notify(
                                RED._('time-inject.errors.error', {
                                    message: RED._('time-inject.errors.not-deployed')
                                }),
                                'error'
                            );
                        } else if (jqXHR.status === 500) {
                            RED.notify(
                                RED._('time-inject.errors.error', {
                                    message: RED._('time-inject.errors.failed')
                                }),
                                'error'
                            );
                        } else if (jqXHR.status === 0) {
                            RED.notify(
                                RED._('time-inject.errors.error', {
                                    message: RED._('time-inject.errors.no-response')
                                }),
                                'error'
                            );
                        } else {
                            RED.notify(
                                RED._('time-inject.errors.error', {
                                    message: RED._('time-inject.errors.unexpected', {
                                        status: jqXHR.status,
                                        message: textStatus
                                    })
                                }),
                                'error'
                            );
                        }
                    }
                });
            }
        }
    });</script>