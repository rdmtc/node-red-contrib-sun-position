<script type="text/x-red" data-template-name="time-inject">
    <div class="form-row">
      <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-inject.label.position"></span></label>
      <input type="text" id="node-input-positionConfig">
  </div>
  <hr>
  <div class="form-row time-payload">
      <label for="node-input-payload"><i class="fa fa-envelope"></i> <span data-i18n="time-inject.label.payload"></span></label>
      <input type="text" id="node-input-payload" style="width:70%">
      <input type="hidden" id="node-input-payloadType">
  </div>
  <div class="form-row time-inject-row-payloadTimeFormat hidden">
    <label for="node-input-payloadTimeFormat"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.payloadTimeFormat"></span></label>
    <select style="width:70%" id="node-input-payloadTimeFormat">
        <option value="0" data-i18n="time-inject.label.timeformat_msDef"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="1" data-i18n="time-inject.label.timeformat_ECMA262"></option> <!-- date as string ECMA-262 -->
        <option value="2" data-i18n="time-inject.label.timeformat_local"></option>
        <option value="3" data-i18n="time-inject.label.timeformat_localTime"></option>
        <option value="4" data-i18n="time-inject.label.timeformat_UTC"></option>
        <option value="5" data-i18n="time-inject.label.timeformat_ISO"></option>
        <option value="6" data-i18n="time-inject.label.timeformat_ms"></option> <!-- milliseconds since execution -->
        <option value="7" data-i18n="time-inject.label.timeformat_sec"></option> <!-- seconds since execution -->
        <option value="8" data-i18n="time-inject.label.timeformat_min"></option> <!-- minutes since execution -->
        <option value="9" data-i18n="time-inject.label.timeformat_obj"></option> <!-- as object -->
    </select>
</div>
  <div class="form-row time-topic">
      <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="time-inject.label.topic"></span></label>
      <input type="text" id="node-input-topic">
  </div>
  <hr>
  <div class="form-row">
      <label for="node-input-time"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.time"></span></label>
      <input type="text" id="node-input-time" style="width: 70%"/>
      <input type="hidden" id="node-input-timeType">
  </div>
  <div class="form-row time-inject-row-offset time-offset hidden">
      <label for="node-input-offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
      <input id="node-input-offset"" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
      <select style="width:100px" id="node-input-offsetMultiplier">
          <option value="1" data-i18n="time-inject.label.seconds"></option>
          <option value="60" data-i18n="time-inject.label.minutes"></option>
          <option value="3600" data-i18n="time-inject.label.hours"></option>
      </select>
  </div>
  <div class="form-row time-inject-row-days time-offset hidden">
    <div id="time-inject-timeDays" class="time-inject-days" style="margin-top:5px">
    <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
    <div style="display:inline-block;">
        <div>
            <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.0"></span></label>
            <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.1"></span></label>
            <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.2"></span></label>
        </div>
        <div>
            <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.3"></span></label>
            <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.4"></span></label>
            <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.5"></span></label>
        </div>
        <div>
            <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.6"></span></label>
        </div>
    </div>
</div>
</div>
  <hr class="time-inject-row-alt hidden">
  <div class="form-row time-inject-row-alt hidden">
      <label ><i class="fa fa-sun-o"></i> <span data-i18n="time-inject.label.property"></span></label>
      <input type="text" id="node-input-property" style="width: 70%"/>
  </div>
  <div class="form-row alternate-time hidden">
      <label for="node-input-timeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.timeAlt"></span></label>
      <input type="text" id="node-input-timeAlt" style="width: 70%"/>
  </div>
  <div class="form-row alternate-time alternate-time-offset hidden">
      <label for="node-input-timeAltOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.timeAltOffset"></span></label>
      <input id="node-input-timeAltOffset"" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.timeAltOffset">
      <select style="width:100px" id="node-input-timeAltOffsetMultiplier">
          <option value="1" data-i18n="time-inject.label.seconds"></option>
          <option value="60" data-i18n="time-inject.label.minutes"></option>
          <option value="3600" data-i18n="time-inject.label.hours"></option>
      </select>
  </div>
  <div class="form-tips time-inject-row-alt hidden">
      <span data-i18n="[html]time-inject.tips.addTimes"></span>&nbsp;
  </div>
  <hr>
  <div class="form-row" id="node-once">
      <label for="node-input-once"><i class="fa fa-play-circle"></i> <span data-i18n="time-inject.label.once"></span></label>
      <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
      <span data-i18n="time-inject.label.onstart"></span>&nbsp;
      <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:65px; height:28px;">&nbsp;
      <span data-i18n="time-inject.label.onceDelay"></span>
  </div>
  <hr class="time-inject-addPayload">
    <div class="form-row time-addPayload1">
        <label for="node-input-addPayload1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload1"></span></label>
        <input type="text" id="node-input-addPayload1" style="width:70%">
        <input type="hidden" id="node-input-addPayload1Type">
    </div>
    <div class="form-row time-addPayload1Value hidden">
        <label for="node-input-addPayload1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload1Value"></span></label>
        <input type="text" id="node-input-addPayload1Value" style="width:70%">
        <input type="hidden" id="node-input-addPayload1ValueType">
    </div>
    <div class="form-row time-inject-row-addPayload1Format hidden">
        <label for="node-input-addPayload1Format"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload1Format"></span></label>
        <select style="width:70%" id="node-input-addPayload1Format">
            <option value="0" data-i18n="time-inject.label.timeformat_msDef"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
            <option value="1" data-i18n="time-inject.label.timeformat_ECMA262"></option> <!-- date as string ECMA-262 -->
            <option value="2" data-i18n="time-inject.label.timeformat_local"></option>
            <option value="3" data-i18n="time-inject.label.timeformat_localTime"></option>
            <option value="4" data-i18n="time-inject.label.timeformat_UTC"></option>
            <option value="5" data-i18n="time-inject.label.timeformat_ISO"></option>
            <option value="6" data-i18n="time-inject.label.timeformat_ms"></option> <!-- milliseconds since execution -->
            <option value="7" data-i18n="time-inject.label.timeformat_sec"></option> <!-- seconds since execution -->
            <option value="8" data-i18n="time-inject.label.timeformat_min"></option> <!-- minutes since execution -->
            <option value="9" data-i18n="time-inject.label.timeformat_obj"></option> <!-- as object -->
        </select>
    </div>
    <div class="form-row time-inject-row-addPayload1Offset hidden">
        <label for="node-input-addPayload1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
        <input id="node-input-addPayload1Offset"" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
        <select style="width:100px" id="node-input-addPayload1OffsetMultiplier">
            <option value="1" data-i18n="time-inject.label.seconds"></option>
            <option value="60" data-i18n="time-inject.label.minutes"></option>
            <option value="3600" data-i18n="time-inject.label.hours"></option>
        </select>
    </div>
    <div class="form-row time-inject-row-addPayload1days hidden">
        <div id="time-inject-addPayload1Days" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row time-addPayload2">
        <label for="node-input-addPayload2"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload2"></span></label>
        <input type="text" id="node-input-addPayload2" style="width:70%">
        <input type="hidden" id="node-input-addPayload2Type">
    </div>
    <div class="form-row time-addPayload2Value hidden">
        <label for="node-input-addPayload2Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload2Value"></span></label>
        <input type="text" id="node-input-addPayload2Value" style="width:70%">
        <input type="hidden" id="node-input-addPayload2ValueType">
    </div>
    <div class="form-row time-inject-row-addPayload2Format hidden">
        <label for="node-input-addPayload2Format"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload2Format"></span></label>
        <select style="width:70%" id="node-input-addPayload2Format">
            <option value="0" data-i18n="time-inject.label.timeformat_msDef"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
            <option value="1" data-i18n="time-inject.label.timeformat_ECMA262"></option> <!-- date as string ECMA-262 -->
            <option value="2" data-i18n="time-inject.label.timeformat_local"></option>
            <option value="3" data-i18n="time-inject.label.timeformat_localTime"></option>
            <option value="4" data-i18n="time-inject.label.timeformat_UTC"></option>
            <option value="5" data-i18n="time-inject.label.timeformat_ISO"></option>
            <option value="6" data-i18n="time-inject.label.timeformat_ms"></option> <!-- milliseconds since execution -->
            <option value="7" data-i18n="time-inject.label.timeformat_sec"></option> <!-- seconds since execution -->
            <option value="8" data-i18n="time-inject.label.timeformat_min"></option> <!-- minutes since execution -->
            <option value="9" data-i18n="time-inject.label.timeformat_obj"></option> <!-- as object -->
        </select>
    </div>
    <div class="form-row time-inject-row-addPayload2Offset hidden">
        <label for="node-input-addPayload2Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
        <input id="node-input-addPayload2Offset"" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
        <select style="width:100px" id="node-input-addPayload2OffsetMultiplier">
            <option value="1" data-i18n="time-inject.label.seconds"></option>
            <option value="60" data-i18n="time-inject.label.minutes"></option>
            <option value="3600" data-i18n="time-inject.label.hours"></option>
        </select>
    </div>
    <div class="form-row time-inject-row-addPayload2days hidden">
        <div id="time-inject-addPayload2Days" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>
  <hr class="time-inject-recalc hidden">
  <div class="form-row time-inject-recalc hidden">
      <label for="node-input-recalcTime"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.recalcTime"></span></label>
      <input type="text" id="node-input-recalcTime" placeholder="2" style="width:65px; height:28px;">&nbsp;
      <span data-i18n="time-inject.label.hours"></span>
  </div>
  <div class="form-tips time-inject-recalc hidden" data-i18n="[html]time-inject.tips.recalc"></div>
  <hr>
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-inject.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]time-inject.placeholder.name">
  </div>

  <div class="form-tips" data-i18n="[html]time-inject.tips.config"></div>
</script>
<style>
    .time-inject-row-addPayload1days,
    .time-inject-row-addPayload2days,
    .time-inject-row-days {
    padding-left: 110px;
  }
  .time-inject-row-addPayload1days select,
  .time-inject-row-addPayload2days select,
  .time-inject-row-days select {
    margin: 3px 0;
  }
  .time-inject-days label {
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    vertical-align: baseline;
    width: 100px;
  }
  .time-inject-days input {
    width: auto;
    vertical-align: baseline;
  }
  .time-inject-times {
    width: 90px;
  }
  #time-inject-time {
    width: 75px;
    margin-left: 8px;
    margin-bottom: 8px;
  }
  .time-inject-count {
    width: 40px !important;
  }
</style>

<script type="text/x-red" data-help-name="time-inject">
    <p>Injects a message into a flow either manually or at timestamps which can also depending on the sunset, sunrise, or moon set and rise. The message
  payload can be a variety of types, including strings, JavaScript objects, the current time or the cuttent sun or moon position.</p>
  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>payload<span class="property-type">various</span></dt>
      <dd>The configured payload of the message.</dd>
      <dt class="optional">topic <span class="property-type">string</span></dt>
      <dd>An optional property that can be configured in the node.</dd>
      <dt class="optional">time <span class="property-type">time</span></dt>
      <dd>An optional property that can be configured when the inject node should emit a message on that timestamp.</dd>
      <dt class="optional">offset <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. The offset can be a positive or negative and defines a time offset to the choosen time.</dd>
      <dt class="optional">day select <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. There can be defined on which days a msg should be emited.</dd>
  </dl>
  <h3>Details</h3>
  <p>The Time-Inject node can initiate a flow with a specific payload value.
  The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
  <p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
  <p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
  inject at specified time stamp in a daily interval which can be set directly or by using the suncalc module to generate an output at various sunrise, sunset, moonrise or moonset times based on a specified location.</p>
  <p><b>Note</b>: The next timestamp will be calculated if a timestamp is reached, settings are changed or the inject node is manual triggered. For a given timestamp (or an alternate timestamp) through a flow or global context a recalculation time could be defined. Then planned emit time then is recalculated every end of this interval. Changes to the contexts then only lead to a change of the planned emit time if a recalculation is done!</p>
  <p><b>Note</b>: To include a newline in a string you must use a Function node to create the payload.</p>

  <h3>Sun times:</h3>
  <p>
    <table>
        <thead>
        <tr>
        <th>Time</th>
        <th>Description</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>astronomicalDawn</code></td>
        <td>night ends (morning astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDawn</code></td>
        <td>amateur astronomical dawn (sun at 12Â° before sunrise)</td>
        </tr>
        <tr>
        <td><code>nauticalDawn</code></td>
        <td>nautical dawn (morning nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDawn</code></td>
        <td>dawn (morning nautical twilight ends, morning civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>sunrise</code></td>
        <td>sunrise (top edge of the sun appears on the horizon)</td>
        </tr>
        <tr>
        <td><code>sunriseEnd</code></td>
        <td>sunrise ends (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>goldenHourEnd</code></td>
        <td>morning golden hour (soft light, best time for photography) ends</td>
        </tr>
        <tr>
        <td><code>solarNoon</code></td>
        <td>solar noon (sun is in the highest position)</td>
        </tr>
        <tr>
        <td><code>goldenHourStart</code></td>
        <td>evening golden hour starts</td>
        </tr>
        <tr>
        <td><code>sunsetStart</code></td>
        <td>sunset starts (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>sunset</code></td>
        <td>sunset (sun disappears below the horizon, evening civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDusk</code></td>
        <td>dusk (evening nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>nauticalDusk</code></td>
        <td>nautical dusk end (evening astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDusk</code></td>
        <td>amateur astronomical dusk (sun at 12Â° after sunrise)</td>
        </tr>
        <tr>
        <td><code>astronomicalDusk</code></td>
        <td>night starts (dark enough for astronomical observations)</td>
        </tr>
        <tr>
        <td><code>nadir</code></td>
        <td>nadir (darkest moment of the night, sun is in the lowest position)</td>
        </tr>
        </tbody>
        </table>
  </p>
  <p>It can also be configured to inject once each time the flows are started.</p>
  <h3>References</h3>
  <ul>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">Node-Red</a> - the Node-Red Node overview</li>
      <li><a href="https://github.com/HM-RedMatic/node-red-contrib-sun-position">GitHub</a> - the nodes github repository</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">NPM</a> - the nodes npm node description</li>
  </ul>
  With friendly support by <b>agag</b>.
</script>

<script type="text/javascript">
    function clipValueLength(v, l) {
        if (v.length > l) {
            return v.substring(0, (l - 3)) + "...";
        }
        return v;
    }

    function getValueLabel(t, v, l) {
        l = l || 15;
        if (t === "string" || t === "str") {
            if (v == "") {
                return v;
            }
            return '"' + clipValueLength(v, l) + '"';
        } else if (t === "num" || t === "bool") {
            if (v == "") {
                return v;
            }
            return "" + v;
        } else if (t === 'msg') {
            return t + "." + clipValueLength(v, l);
        } else if (t === 'flow' || t === 'global') {
            var result = RED.utils.parseContextKey(v);
            return t + "." + clipValueLength(result.key, l);
        } else if (t == "pdsCalcData") {
            return "{sun position}";
        } else if (t == "pdmCalcData") {
            return "{moon position}";
        } else if (t == "pdsTime") {
            let res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('civil', '').replace(
                'amateur', 'amat-').replace('blueHour', 'blHr-').replace('goldenHour', 'goHr-');
            return clipValueLength(res, l);
        } else if (t == "pdmTime") {
            return "moon" + v;
        }
        return clipValueLength(v, l);
    }

    RED.nodes.registerType("time-inject", {
        category: "input",
        color: "#a6bbcf",
        defaults: {
            name: {
                value: "",
                required: false
            },
            positionConfig: {
                value: "",
                type: "position-config",
                required: true
            },
            payload: {
                value: "",
                validate: RED.validators.typedInput("payloadType")
            },
            payloadType: {
                value: "date"
            },
            payloadTimeFormat: {
                value: 0,
                required: true,
                validate: RED.validators.number()
            },
            topic: {
                value: ""
            },
            time: {
                value: "",
                required: false,
                validate: RED.validators.typedInput("timeType")
            },
            timeType: {
                value: "none"
            },
            timeDays: {
                value: "*"
            },
            offset: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-time").typedInput("type") === "none"
                    );
                }
            },
            offsetMultiplier: {
                value: 60,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-time").typedInput("type") === "none"
                    );
                }
            },
            property: {
                value: "",
                required: false,
                validate: function (v) {
                    return (
                        RED.validators.typedInput("propertyType")(v) ||
                        $("#node-input-time").typedInput("type") === "none"
                    );
                }
            },
            propertyType: {
                value: "none"
            },
            timeAlt: {
                value: "",
                required: false,
                validate: function (v) {
                    return (
                        RED.validators.typedInput("timeAltType")(v) ||
                        $("#node-input-time").typedInput("type") === "none" ||
                        $("#node-input-property").typedInput("type") === "none" ||
                        this.propertyType === undefined
                    );
                }
            },
            timeAltType: {
                value: "entered"
            },
            timeAltOffset: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-time").typedInput("type") === "none" ||
                        $("#node-input-property").typedInput("type") === "none" ||
                        this.propertyType === undefined
                    );
                }
            },
            timeAltOffsetMultiplier: {
                value: 60,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-time").typedInput("type") === "none" ||
                        $("#node-input-property").typedInput("type") === "none" ||
                        this.propertyType === undefined
                    );
                }
            },
            once: {
                value: false
            },
            onceDelay: {
                value: 0.1,
                validate: function (v) {
                    return RED.validators.number()(v) || v === "" || v == null;
                }
            },
            addPayload1: {
                value: "",
                validate: RED.validators.typedInput("addPayload1Type")
            },
            addPayload1Type: {
                value: "none"
            },
            addPayload1Value: {
                value: "",
                validate: function (v) {
                    return (
                        RED.validators.typedInput("addPayload1ValueType")(v) ||
                        $("#node-input-addPayload1").typedInput("type") === "none" ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload1ValueType: {
                value: "date"
            },
            addPayload1Format: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload2").typedInput("type") === "none" ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload1Days: {
                value: "*"
            },
            addPayload1Offset: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload1").typedInput("type") === "none" ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload1OffsetMultiplier: {
                value: 60,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload1").typedInput("type") === "none" ||
                        this.addPayload1Type === undefined
                    );
                }
            },
            addPayload2: {
                value: "",
                validate: RED.validators.typedInput("addPayload2Type")
            },
            addPayload2Type: {
                value: "none"
            },
            addPayload2Value: {
                value: "",
                validate: function (v) {
                    return (
                        RED.validators.typedInput("addPayload2ValueType")(v) ||
                        $("#node-input-addPayload2").typedInput("type") === "none" ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2ValueType: {
                value: "date"
            },
            addPayload2Format: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload2").typedInput("type") === "none" ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2Days: {
                value: "*"
            },
            addPayload2Offset: {
                value: 0,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload2").typedInput("type") === "none" ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            addPayload2OffsetMultiplier: {
                value: 60,
                required: true,
                validate: function (v) {
                    return (
                        RED.validators.number()(v) ||
                        $("#node-input-addPayload2").typedInput("type") === "none" ||
                        this.addPayload2Type === undefined
                    );
                }
            },
            recalcTime: {
                value: 2,
                validate: function (v) {
                    return RED.validators.number()(v) || v === "" || v == null;
                }
            }
        },
        icon: "injectSun.png",
        inputs: 0,
        outputs: 1,
        outputLabels: function (index) {
            var labels = {
                str: "string",
                num: "number",
                bool: "boolean",
                json: "object",
                flow: "flow context",
                global: "global context",
                bin: "binary data",
                date: "timestamp",
                env: "Enviroment variable",
                jsonata: "result of jsonata expression",
                pdmTime: "time",
                typeSunCalc: "object of sun position",
                typeMoonCalc: "object of moon position"
            };
            var lab = labels[this.payloadType] || this.payloadType;
            if (lab === "object") {
                try {
                    lab = typeof JSON.parse(this.payload);
                    if (lab === "object") {
                        if (Array.isArray(JSON.parse(this.payload))) {
                            lab = "Array";
                        }
                    }
                } catch (e) {
                    lab = "Invalid JSON Object";
                }
            }
            return lab;
        },
        label: function () {
            if (this.name) {
                return this.name;
            }
            var result = "";
            let prefix = "";
            if (this.once) {
                prefix += " Â¹";
            }
            const getId = (type, value, offset, maxLength) => {
                let suffix = "";
                if (offset && offset > 0) {
                    suffix = "â†·";
                } else if (offset && offset < 0) {
                    suffix = "â†¶";
                }

                if (type === "jsonata") {
                    if (value.length < 15) {
                        return value + suffix;
                    }
                    return this._("time-inject.label.jsonata");
                } else if (type === "json") {
                    if (value.length < 15) {
                        return value + suffix;
                    }
                    return this._("time-inject.label.json") + suffix;
                } else if (type === "bin") {
                    return this._("time-inject.label.binary") + suffix;
                } else if (type === "date") {
                    return this._("time-inject.label.timestamp") + suffix;
                }

                let v = getValueLabel(type, value, maxLength);
                if (v == "") {
                    return this._("time-inject.label.blank");
                }
                return v + suffix;
            };
            const getTimeId = () => {
                let suffix = "";
                let days = this.timeDays;
                if (days && days !== "*" && days !== "1,2,3,4,5,6,0") {
                    if (days === "1,2,3,4,5") {
                        suffix += " [Mo-Fr]"; //'ðŸ‘·'
                    } else if (days === "1,2,3,4") {
                        suffix += " [Mo-Th]";
                    } else if (days === "5,6,0") {
                        suffix += " [Fr-Su]";
                    } else if (days === "6,0") {
                        suffix += " [Sa+Su]";
                    } else {
                        let dayarr = [];
                        if (days.indexOf("1") >= 0) {
                            dayarr.push("Mo");
                        }
                        if (days.indexOf("2") >= 0) {
                            dayarr.push("Tu");
                        }
                        if (days.indexOf("3") >= 0) {
                            dayarr.push("We");
                        }
                        if (days.indexOf("4") >= 0) {
                            dayarr.push("Th");
                        }
                        if (days.indexOf("5") >= 0) {
                            dayarr.push("Fr");
                        }
                        if (days.indexOf("6") >= 0) {
                            dayarr.push("Sa");
                        }
                        if (days.indexOf("0") >= 0) {
                            dayarr.push("Su");
                        }
                        suffix += " [" + dayarr.join(",") + "]";
                    }
                    //...
                }
                let part1 = getId(this.timeType, this.time, this.offset);
                if (
                    this.propertyType !== "none" &&
                    this.propertyType !== "" &&
                    this.timeAlt
                ) {
                    return (
                        part1 +
                        "/" +
                        getId(this.timeAltType, this.timeAlt, this.timeAltOffset) +
                        suffix
                    );
                }
                return part1 + suffix;
            };
            if (this.timeType === "none" || this.timeType === "") {
                return this._("time-inject.label.inject");
            } else {
                let timeTxt = getTimeId();
                if (timeTxt.length > 24) {
                    result += timeTxt + " =...";
                } else {
                    result += timeTxt + " = " + getId(this.payloadType, this.payload, undefined, 12);
                }
            }
            if (this.topic && this.topic.length + result.length <= 32) {
                return this.topic + ":" + prefix + result;
            }
            return prefix + result;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: "time inject",
        align: "left",
        oneditprepare: function () {
            function initializeValue(id, newVal) {
                if (this[id] == null || (typeof this[id] === 'undefined')) {
                    let idHtml = "#node-input-" + id;
                    this[id] = newVal;
                    $(idHtml).val(newVal);
                }
            }

            const typeUndefined = {
                value: "none",
                label: "not used",
                icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
                hasValue: false
            };
            const typeTime = {
                value: "entered",
                label: "time of day",
                icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
                hasValue: true,
                validate: /^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]|[0-9]))?(?::([0-5][0-9]|[0-9]))?\s*(pm?)?$/
            };
            const typeProperty = {
                value: "msgProperty",
                label: "msg property",
                icon: "icons/node-red-contrib-sun-position/inputTypeProperty.png",
                hasValue: true,
                validate: /^(?:[\$A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0-\u08B2\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC])(?:[\$0-9A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05F0-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u082D\u0840-\u085B\u08A0-\u08B2\u08E4-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1877\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19D9\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1CD0-\u1CD2\u1CD4-\u1CF6\u1CF8\u1CF9\u1D00-\u1DF5\u1DFC-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u2E2F\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099\u309A\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA69D\uA69F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA827\uA840-\uA873\uA880-\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA900-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2D\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC])*$/
            };
            const typeTimeSun = {
                value: "pdsTime",
                label: "sun time ",
                icon: "icons/node-red-contrib-sun-position/inputTypeSunClock.png",
                options: [
                    "astronomicalDawn",
                    "amateurDawn",
                    "nauticalDawn",
                    "blueHourDawnStart",
                    "civilDawn",
                    "blueHourDawnEnd",
                    "sunrise",
                    "sunriseEnd",
                    "goldenHourEnd",
                    "solarNoon",
                    "goldenHourStart",
                    "sunsetStart",
                    "sunset",
                    "blueHourDuskStart",
                    "civilDusk",
                    "blueHourDuskEnd",
                    "amateurDusk",
                    "astronomicalDusk",
                    "nadir"
                ]
            };
            const typeTimeMoon = {
                value: "pdmTime",
                label: "moon time ",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoonClock.png",
                options: ["rise", "set"]
            };
            const typeSunCalc = {
                value: "pdsCalcData",
                label: "sun caclucaltion",
                icon: "icons/node-red-contrib-sun-position/inputTypeSun.png",
                hasValue: false
            };
            const typeMoonCalc = {
                value: "pdmCalcData",
                label: "moon caclucaltion",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoon.png",
                hasValue: false
            };

            initializeValue('offset', 0);
            initializeValue('offsetMultiplier', 60);
            initializeValue('property', '');
            initializeValue('propertyType', typeUndefined.value);
            initializeValue('timeAlt', '');
            initializeValue('timeAltType', typeUndefined.value);
            initializeValue('timeAltOffset', 0);
            initializeValue('timeAltOffsetMultiplier', 60);
            initializeValue('addPayload1', '');
            initializeValue('addPayload1Type', typeUndefined.value);
            initializeValue('addPayload1Value', '');
            initializeValue('addPayload1ValueType', 'date');
            initializeValue('addPayload1Format', 0);
            initializeValue('addPayload1Offset', 0);
            initializeValue('addPayload1OffsetMultiplier', 60);
            initializeValue('addPayload2', '');
            initializeValue('addPayload2Type', typeUndefined.value);
            initializeValue('addPayload2Value', '');
            initializeValue('addPayload2ValueType', 'date');
            initializeValue('addPayload2Format', 0);
            initializeValue('addPayload2Offset', 0);
            initializeValue('addPayload2OffsetMultiplier', 60);

            initializeValue('payload', '');
            if (this.payloadType == null) {
                if (this.payload == "") {
                    this.payloadType = "date";
                } else {
                    this.payloadType = "str";
                }
            } else if (this.payloadType === "string" || this.payloadType === typeUndefined.value) {
                this.payloadType = "str";
            }


            $("#node-input-timeType").val(this.timeType);
            $("#node-input-time").typedInput({
                default: this.timeType || typeUndefined.value,
                typeField: $("#node-input-timeType"),
                types: [
                    typeUndefined,
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    "flow",
                    "global",
                    "env"
                ]
            });
            $("#node-input-time").on("change", function (type, value) {
                if ($("#node-input-time").typedInput("type") === typeUndefined.value) {
                    $(".time-inject-row-offset").hide();
                    $(".time-inject-row-days").hide();
                    $(".time-inject-row-alt").hide();
                } else {
                    $(".time-inject-row-offset").show();
                    $(".time-inject-row-days").show();
                    $(".time-inject-row-alt").show();
                }
                $("#node-input-property").change();
            });

            $("#node-input-payloadType").val(this.payloadType);
            $("#node-input-payload").typedInput({
                default: this.payloadType || "date",
                typeField: $("#node-input-payloadType"),
                types: [
                    "date",
                    typeTimeSun,
                    typeTimeMoon,
                    "flow",
                    "global",
                    "str",
                    "num",
                    "bool",
                    "json",
                    "bin",
                    "env",
                    "jsonata",
                    typeSunCalc,
                    typeMoonCalc,
                ]
            });
            $("#node-input-addPayload1Type").val(this.addPayload1Type);
            $("#node-input-addPayload1").typedInput({
                default: this.addPayload1Type,
                typeField: $("#node-input-addPayload1Type"),
                types: [
                    typeUndefined,
                    typeProperty
                ]
            });

            $("#node-input-addPayload1ValueType").val(this.addPayload1ValueType);
            $("#node-input-addPayload1Value").typedInput({
                default: this.addPayload1ValueType || "date",
                typeField: $("#node-input-addPayload1ValueType"),
                types: [
                    "date",
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    "flow",
                    "global",
                    "str",
                    "num",
                    "bool",
                    "json",
                    "bin",
                    "env",
                    "jsonata",
                    typeSunCalc,
                    typeMoonCalc,

                ]
            });
            $("#node-input-addPayload2Type").val(this.addPayload2Type);
            $("#node-input-addPayload2").typedInput({
                default: this.addPayload2Type || typeUndefined.value,
                typeField: $("#node-input-addPayload2Type"),
                types: [
                    typeUndefined,
                    typeProperty
                ]
            });
            $("#node-input-addPayload2ValueType").val(this.addPayload2ValueType);
            $("#node-input-addPayload2Value").typedInput({
                default: this.addPayload2ValueType || "date",
                typeField: $("#node-input-addPayload2ValueType"),
                types: [
                    "date",
                    typeTime,
                    typeTimeSun,
                    typeTimeMoon,
                    "flow",
                    "global",
                    "str",
                    "num",
                    "bool",
                    "json",
                    "bin",
                    "env",
                    "jsonata",
                    typeSunCalc,
                    typeMoonCalc,
                ]
            });
            $("#node-input-property").typedInput({
                default: this.propertyType || typeUndefined.value,
                types: [typeUndefined, "flow", "global", "jsonata", "env"]
            });
            $("#node-input-property").on("change", function (type, value) {
                let timeType = $("#node-input-time").typedInput("type");
                let propType = $("#node-input-property").typedInput("type");
                if (timeType === typeUndefined.value || propType === typeUndefined.value) {
                    $(".alternate-time").hide();
                    $(".alternate-time-offset").hide();
                } else {
                    $(".alternate-time").show();
                    $(".alternate-time-offset").show();
                }
                if (
                    timeType === "flow" ||
                    timeType === "global" ||
                    propType !== typeUndefined.value
                ) {
                    $(".time-inject-recalc").show();
                } else {
                    $(".time-inject-recalc").hide();
                    $("#time-inject-recalcTime").val("");
                }
            });
            $("#node-input-addPayload1").on("change", function (type, value) {
                let plType = $("#node-input-addPayload1").typedInput("type");
                if (plType === "msgProperty") {
                    $(".time-addPayload1Value").show();
                    let plVType = $("#node-input-addPayload1Value").typedInput("type");
                    if (plVType === "entered" ||
                        plVType === "pdsTime" ||
                        plVType === "pdmTime") {
                            $(".time-inject-row-addPayload1Format").show();
                        $(".time-inject-row-addPayload1Offset").show();
                        $(".time-inject-row-addPayload1days").show();
                    } else if (plVType === "date") {
                        $(".time-inject-row-addPayload1Format").show();
                        $(".time-inject-row-addPayload1Offset").show();
                        $(".time-inject-row-addPayload1days").hide();
                    } else {
                        $(".time-inject-row-addPayload1Format").hide();
                        $(".time-inject-row-addPayload1Offset").hide();
                        $(".time-inject-row-addPayload1days").hide();
                    }
                } else {
                    $(".time-addPayload1Value").hide();
                    $(".time-inject-row-addPayload1Format").hide();
                    $(".time-inject-row-addPayload1Offset").hide();
                    $(".time-inject-row-addPayload1days").hide();
                }
            });
            $("#node-input-addPayload1Value").on("change", function (type, value) {
                $("#node-input-addPayload1").change();
            });
            $("#node-input-addPayload2").on("change", function (type, value) {
                let plType = $("#node-input-addPayload2").typedInput("type");
                if (plType === "msgProperty") {
                    $(".time-addPayload2Value").show();
                    let plVType = $("#node-input-addPayload2Value").typedInput("type");
                    if (plVType === "entered" ||
                        plVType === "pdsTime" ||
                        plVType === "pdmTime") {
                            $(".time-inject-row-addPayload2Format").show();
                        $(".time-inject-row-addPayload2Offset").show();
                        $(".time-inject-row-addPayload2days").show();
                    } else if (plVType === "date") {
                        $(".time-inject-row-addPayload2Format").show();
                        $(".time-inject-row-addPayload2Offset").show();
                        $(".time-inject-row-addPayload2days").hide();
                    } else {
                        $(".time-inject-row-addPayload2Format").hide();
                        $(".time-inject-row-addPayload2Offset").hide();
                        $(".time-inject-row-addPayload2days").hide();
                    }
                } else {
                    $(".time-addPayload2Value").hide();
                    $(".time-inject-row-addPayload2Format").hide();
                    $(".time-inject-row-addPayload2Offset").hide();
                    $(".time-inject-row-addPayload2days").hide();
                }
            });
            $("#node-input-addPayload2Value").on("change", function (type, value) {
                $("#node-input-addPayload2").change();
            });
            $("#node-input-timeAlt").typedInput({
                default: this.timeAltType || "entered",
                types: [typeTime, typeTimeSun, typeTimeMoon, "flow", "global", "env"]
            });
            $(".wt-offset-time").spinner({
                max: 1439,
                min: -1439
            });
            $("#node-input-onceDelay").spinner({
                step: 0.1,
                numberFormat: "n"
            });
            $("#node-input-recalcTime").spinner({
                step: 0.1,
                numberFormat: "n"
            });
            if (this.timeDays == "*") {
                $("#time-inject-timeDays input[type=checkbox]").prop("checked", true);
            } else {
                $("#time-inject-timeDays input[type=checkbox]").removeAttr("checked");
                this.timeDays.split(",").forEach(function (v) {
                    $("#time-inject-timeDays [value=" + v + "]").prop("checked", true);
                });
            }
            $("#node-input-once").change(function () {
                $("#node-input-onceDelay").attr(
                    "disabled",
                    !$("#node-input-once").prop("checked")
                );
            });

            $("#node-input-time").change();
            $("#node-input-property").change();
            $("#node-input-payload").change();
            $("#node-input-addPayload1").change();
            $("#node-input-addPayload2").change();
        },
        oneditsave: function () {
            this.timeType = $("#node-input-time").typedInput("type");
            this.payloadType = $("#node-input-payload").typedInput("type");
            this.propertyType = $("#node-input-property").typedInput("type");
            this.timeAltType = $("#node-input-timeAlt").typedInput("type");
            var days = $("#time-inject-timeDays input[type=checkbox]:checked")
                .map(function (_, el) {
                    return $(el).val();
                })
                .get();

            if (days.length == 0) {
                this.timeDays = "";
            } else if (days.length == 7) {
                this.timeDays = "*";
            } else {
                this.timeDays = days.join(",");
            }
            this.addPayload1Type = $("#node-input-addPayload1").typedInput("type");
            this.addPayload1ValueType = $("#node-input-addPayload1Value").typedInput("type");
            var addPayload1Days = $("#time-inject-addPayload1Days input[type=checkbox]:checked")
                .map(function (_, el) {
                    return $(el).val();
                })
                .get();

            if (addPayload1Days.length == 0) {
                this.addPayload1Days = "";
            } else if (days.length == 7) {
                this.addPayload1Days = "*";
            } else {
                this.addPayload1Days = days.join(",");
            }
            this.addPayload2Type = $("#node-input-addPayload2").typedInput("type");
            this.addPayload2ValueType = $("#node-input-addPayload2Value").typedInput("type");
            var addPayload2Days = $("#time-inject-addPayload2Days input[type=checkbox]:checked")
                .map(function (_, el) {
                    return $(el).val();
                })
                .get();

            if (addPayload2Days.length == 0) {
                this.addPayload2Days = "";
            } else if (days.length == 7) {
                this.addPayload2Days = "*";
            } else {
                this.addPayload2Days = days.join(",");
            }
        },
        button: {
            enabled: function () {
                return !this.changed;
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(
                        RED._("notification.warning", {
                            message: RED._("notification.warnings.undeployedChanges")
                        }),
                        "warning"
                    );
                }
                var payload = this.payload;
                if (this.payloadType === "str" || this.payloadType === "string") {
                    payload = '"' + this.payload + '"';
                }
                if (this.payloadType === "flow" || this.payloadType === "global") {
                    var key = RED.utils.parseContextKey(payload);
                    payload = this.payloadType + "." + key.key;
                }
                var label = clipValueLength(this.name || payload, 30);
                label = label
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                if (this.payloadType === "date") {
                    label = this._("time-inject.label.timestamp");
                }
                if (this.payloadType === 'none') {
                    label = this._("time-inject.label.blank");
                }
                var node = this;
                $.ajax({
                    url: "inject/" + this.id,
                    type: "POST",
                    success: function (resp) {
                        RED.notify(
                            node._("time-inject.label.success", {
                                label: label
                            }),
                            "success"
                        );
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(
                                RED._("time-inject.errors.error", {
                                    message: RED._("time-inject.errors.not-deployed")
                                }),
                                "error"
                            );
                        } else if (jqXHR.status == 500) {
                            RED.notify(
                                RED._("time-inject.errors.error", {
                                    message: RED._("time-inject.errors.failed")
                                }),
                                "error"
                            );
                        } else if (jqXHR.status == 0) {
                            RED.notify(
                                RED._("time-inject.errors.error", {
                                    message: RED._("time-inject.errors.no-response")
                                }),
                                "error"
                            );
                        } else {
                            RED.notify(
                                RED._("time-inject.errors.error", {
                                    message: RED._("time-inject.errors.unexpected", {
                                        status: jqXHR.status,
                                        message: textStatus
                                    })
                                }),
                                "error"
                            );
                        }
                    }
                });
            }
        }
    });
</script>